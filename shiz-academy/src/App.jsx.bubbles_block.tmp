              {/* Performance cosmetic overlay: Pink Bubbles (Pop + All Genres) */}
              {isPerforming && performingSong && ((performingSong.genre === 'Pop') || pinkBubblesAllGenres) && pinkBubblesUnlocked && pinkBubblesEnabled && (
                <div style={styles.performBubblesOverlay}>
                  {bubbleSeeds.map((b, i) => (
                    <div
                      key={`pb${i}`}
                      style={{
                        ...styles.performBubble,
                        left: `${b.left}%`,
                        top: `${b.topPct || 100}%`,
                        '--dur': `${b.duration}s`,
                        '--delay': `${b.delay}s`,
                        '--amp': `${b.amp}px`,
                      }}
                    >
                      <span
                        style={{
                          ...styles.performBubbleInner,
                          width: b.size,
                          height: b.size,
                          filter: `blur(${b.blur}px) drop-shadow(0 0 10px rgba(255,180,210,.35))`,
                        }}
                      />
                    </div>
                  ))}
                  <div style={styles.performBubblesSheen} />
                </div>
              )}
              {/* Performance cosmetic overlay: Snowfall (Busking venue during Wizmas) */}
              {isPerforming && performingVenue === 'busking' && (activeEffects?.wizmas) && (
                <div style={{ position:'absolute', inset:0, pointerEvents:'none', zIndex: 3 }}>
                  <div style={styles.performSnowBack} />
                  <div style={styles.performSnowMid} />
                  <div style={styles.performSnowFront} />
                </div>
              )}
              {/* Performance cosmetic overlay: Spotlight Snap (Hip-Hop or All Genres, brief at start) */}
              {isPerforming && performingSong && (((performingSong.genre === 'Hip-Hop') || spotlightAllGenres)) && spotlightSnapUnlocked && spotlightSnapEnabled && spotlightActive && (
                <div style={styles.performSpotlightOverlay}>
                  <div style={{ ...styles.performSpotlightDim, animationDuration: `${spotlightDurMs}ms` }} />
                  <div style={{
                    ...styles.performSpotlightCircle,
                    left: `calc(${pos.x}% + 62px)`,
                    top: `calc(${pos.y}% + 62px)`,
                    transform: 'translate(-50%, -50%) scale(1.1, 0.85)'
                  }} />
                </div>
              )}
              {/* Room HUD: show money and rolls */}
              {!isPerforming && (
                <div style={{ ...styles.hudMoney, display:'inline-flex', alignItems:'center', gap:6 }}>
                  <span>{money}</span>
                  <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:16, height:16, objectFit:'contain' }} />
                </div>
              )}
              {!playingTrend && !isPerforming && (
                <div style={styles.hudRolls}>Available rolls: {Math.max(0, remaining)}</div>
              )}
              {(playingTrend && ((audioRef.current && !audioRef.current.paused) || (dancePreviewActiveRef.current))) && (
                <div style={styles.hudListening} title={`${playingTrend.artist} - ${playingTrend.title}`}>
                  <span style={{ marginRight: 6, opacity: .9 }}></span>
                  <b style={{ fontWeight:800, whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis', maxWidth: 220 }}>{playingTrend.artist} - {playingTrend.title}</b>
                </div>
              )}
              {isPerforming && (
                <div style={styles.hudPerforming} title={`${(performingSong?.name || songName || 'Your Song')} - ${(performingSong?.genre || genre)} / ${(performingSong?.theme || theme)}`}>
                  <div style={{ fontWeight: 800, whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis', maxWidth: 240 }}>{performingSong?.name || songName || 'Your Song'}</div>
                  <div style={{ fontSize: 12, opacity: .9 }}>{performingSong?.genre || genre} / {performingSong?.theme || theme}</div>
                  {(rainfallUnlocked && rainfallEnabled && (((performingSong?.genre||genre) === 'Rock') || rainfallAllGenres)) && (
                    <div style={{ fontSize: 11, opacity: .95, color: '#9ec9ff', marginTop: 2 }}>Rainfall Stage Lighting</div>
                  )}
                  {(midnightHazeUnlocked && midnightHazeEnabled && (((performingSong?.genre||genre) === 'Synthwave') || midnightHazeAllGenres)) && (
                    <div style={{ fontSize: 11, opacity: .95, color: '#caa7ff', marginTop: 2 }}>Midnight Haze Lighting</div>
                  )}
                  {(spotlightSnapUnlocked && spotlightSnapEnabled && (((performingSong?.genre||genre) === 'Hip-Hop') || spotlightAllGenres)) && (
                    <div style={{ fontSize: 11, opacity: .95, color: '#ffd27a', marginTop: 2 }}>Spotlight Snap</div>
                  )}
                  {(rivetFilterUnlocked && rivetFilterEnabled && (((performingSong?.genre||genre) === 'Metal') || rivetFilterAllGenres)) && (
                    <div style={{ fontSize: 11, opacity: .95, color: '#ddd', marginTop: 2 }}>Iron Overture Filter</div>
                  )}
                  {(pinkBubblesUnlocked && pinkBubblesEnabled && (((performingSong?.genre||genre) === 'Pop') || pinkBubblesAllGenres)) && (
                    <div style={{ fontSize: 11, opacity: .95, color: '#ffb3d9', marginTop: 2 }}>Pink Bubbles</div>
                  )}
                  {(pinkBubblesUnlocked && pinkBubblesEnabled && (performingSong?.genre||genre) === 'Pop') && (
                    <div style={{ fontSize: 11, opacity: .95, color: '#ffb3d9', marginTop: 2 }}>Pink Bubbles</div>
                  )}
                </div>
              )}
              {nudges > 0 && !isPerforming && (
                <img
                  src="/art/nudgebutton.png"
                  alt="Nudge"
                  title={`Nudges: ${nudges}`}
                  onClick={() => setNudgeOpen(true)}
                  style={styles.nudgeImgBtn}
                />
              )}
              {DICE_MODE && SHOW_DICE_MINI && (
                <div style={styles.diceMiniOverlay}>
                  {(() => { const rb=rollBest.sing; const faces = rb? rb.faces : facesFor(vocals); const val = rb? rb.value : null; const bg = bubbleBg(val||0, faces); return (
                    <div style={{...styles.diceMiniChip, background:bg}} title="Sing">
                      <div style={styles.diceLabel}>S</div>
                      <div style={styles.diceVal}>{val? `${val}/${faces}` : `d${faces}`}</div>
                    </div>
                  ); })()}
                  {(() => { const rb=rollBest.write; const faces = rb? rb.faces : facesFor(writing); const val = rb? rb.value : null; const bg = bubbleBg(val||0, faces); return (
                    <div style={{...styles.diceMiniChip, background:bg}} title="Write">
                      <div style={styles.diceLabel}>W</div>
                      <div style={styles.diceVal}>{val? `${val}/${faces}` : `d${faces}`}</div>
                    </div>
                  ); })()}
                  {(() => { const rb=rollBest.perform; const faces = rb? rb.faces : facesFor(stage); const val = rb? rb.value : null; const bg = bubbleBg(val||0, faces); return (
                    <div style={{...styles.diceMiniChip, background:bg}} title="Perform">
                      <div style={styles.diceLabel}>P</div>
                      <div style={styles.diceVal}>{val? `${val}/${faces}` : `d${faces}`}</div>
                    </div>
                  ); })()}
                </div>
              )}
              {isPerforming && (
                <button onClick={skipPerformance} style={{ position:'absolute', right:10, top:10, zIndex:2, ...styles.secondaryBtn }} title="Skip performance">Skip performance</button>
              )}
              {/* Legacy station sprites removed; replaced by anchor overlay above */}

                {/* Nudge badge is rendered inside the room overlay below */}

                <div
                  style={{
                    ...styles.performer,
                    left: `${pos.x}%`,
                    top: `${pos.y}%`,
                    transform: `translate(-50%, -50%) scaleX(${activity === 'walk' && facingLeft ? -1 : 1}) scale(${(activity === 'walk' ? 1.15 : activity === 'singing' ? 1.06 : activity === 'dancing' ? 1.26 : 1) * ((isPerforming && performingVenue === 'ozdustball') ? 0.9 : 1) * ((isPerforming && performingVenue === 'iron') ? 0.5 : 1)})${activity === 'dancing' ? ' rotate(2deg)' : ''}${(isPerforming && performingVenue === 'busking') ? ' translate(120px, 20px)' : ''}${(isPerforming && performingVenue === 'ozdustball') ? ' translate(-50px, 15px)' : ''}${(isPerforming && performingVenue === 'iron') ? ' translate(0px, 60px)' : ''}`,
                  }}
                  title="Your performer"
                >
                  {isPerforming ? (
                    <img src="/art/singing.gif" alt="Performer singing" style={styles.performerImg} />
                  ) : activity === 'walk' ? (
                    <img src="/art/walking.gif" alt="Performer walking" style={styles.performerImg} />
                  ) : activity === 'singing' ? (
                    <img src="/art/singing.gif" alt="Performer singing" style={styles.performerImg} />
                  ) : activity === 'dancing' ? (
                    <img src="/art/dancing.gif" alt="Performer dancing" style={styles.performerImg} />
                  ) : (
                    <img src="/art/idle.gif" alt="Performer idle" style={styles.performerImg} />
                  )}
                  {activity === "write" && <div style={styles.actionEmoji}>??</div>}
                  {activity === "sing" && <div style={styles.actionEmoji}>??</div>}
                  {activity === "dance" && <div style={styles.actionEmoji}>??</div>}
                </div>
                {/* Performance prop: Boombox beside performer during venue performances */}
                {isPerforming && performingVenue && (
                  <div
                    style={{
                      position:'absolute',
                      left: `${pos.x}%`,
                      top: `${pos.y}%`,
                      transform:
                        `translate(-50%, -50%)` +
                        (performingVenue === 'busking' ? ' translate(120px, 20px)' : '') +
                        (performingVenue === 'ozdustball' ? ' translate(-50px, 15px)' : '') +
                        (performingVenue === 'busking'
                          ? ' translate(-110px, 60px)'
                          : (performingVenue === 'katieparty'
                              ? ' translate(-135px, 22px)'
                               : ` translate(${facingLeft ? '-85px' : '85px'}, 12px)`)) +
                        (performingVenue === 'iron' ? ' translate(0px, 50px)' : ''),
                      zIndex: 3,
                      pointerEvents: 'none'
                    }}
                    aria-hidden
                    title="Boombox"
                  >
                    <img src={'/art/boombox.gif'} alt={'Boombox'} style={{ width: (performingVenue === 'iron' ? 48 : 96), height: 'auto', objectFit:'contain', filter:'drop-shadow(0 2px 6px rgba(0,0,0,.35))' }} />
                  </div>
                )}
                {DICE_MODE && rollFx.show && (
                  <div style={{
                    ...styles.rollBubble,
                    left: `${pos.x}%`,
                    top: `${pos.y}%`,
                    background: (rollFx.faces === 20 || rollFx.faces === 12 || rollFx.faces === 6) ? 'transparent' : bubbleBg(rollFx.current, rollFx.faces),
                    transform: `translate(-50%, -115%) translateY(-45px) translate(${!rollFx.settled ? (((rollFx.current||1)%2===0?-2:2)) : 0}px, ${!rollFx.settled ? ((((rollFx.current||1)%3)-1)*2) : 0}px) rotate(${!rollFx.settled ? (((rollFx.current||1)%2===0?-2:2)) : 0}deg) scale(${(rollFx.faces===12||rollFx.faces===6) ? (rollFx.settled ? (rollFxPulse ? 1.15 : 1.0) : 1.0) : (rollFx.settled?1.12:1)})`,
                    opacity: rollFxFadeOut ? 0 : 1,
                    transition: 'opacity 300ms ease, transform 300ms ease',
                    ...((rollFx.faces === 20 || rollFx.faces === 12 || rollFx.faces === 6) ? { border: 'none', padding: 0, borderRadius: 0, gap: 0, alignItems: 'center' } : {}),
                    ...(bubbleGlow.show ? { boxShadow: (rollFx.faces === 20 || rollFx.faces === 12 || rollFx.faces === 6) ? undefined : `0 0 0 2px ${bubbleGlow.color}, 0 0 12px ${bubbleGlow.color}` } : {})
                  }}>
                    {(rollFx.faces === 20 || rollFx.faces === 12 || rollFx.faces === 6) ? (
                      !rollFx.settled ? (
                        <img
                          src={rollFx.faces === 20 ? '/art/d20.gif' : rollFx.faces === 12 ? '/art/d12.gif' : '/art/d6.gif'}
                          alt={rollFx.faces === 20 ? 'd20 roll' : rollFx.faces === 12 ? 'd12 roll' : 'd6 roll'}
                          style={{ width: 48, height: 48 }}
                        />
                      ) : (
                        <div style={{ fontWeight:900, fontSize: 18 }}>{rollFx.current ?? ''}</div>
                      )
                    ) : (
                      <>
                        <div style={{ fontWeight:800 }}>{rollFx.current ?? ''}</div>
                        <div style={{ fontSize:11, opacity:.85 }}>d{rollFx.faces}</div>
                      </>
                    )}
                  </div>
                )}
                {celebrateFx.show && (
                  <div style={{
                    position:'absolute',
                    left: celebrateFx.phase==='start' ? `${celebrateFx.startX}%` : '50%',
                    top: celebrateFx.phase==='start' ? `${celebrateFx.startY}%` : '50%',
                    transform: celebrateFx.phase==='start'
                      ? 'translate(-50%, -115%) translateY(-75px)'
                      : 'translate(-50%, -50%)',
                    color: celebrateFx.color,
                    fontWeight: 900,
                    fontSize: celebrateFx.phase==='start' ? 14 : 28,
                    opacity: celebrateFx.phase==='fade' ? 0 : 1,
                    transition: 'left 650ms ease, top 650ms ease, transform 650ms ease, font-size 650ms ease, opacity 600ms ease',
                    textShadow: '0 1px 2px rgba(0,0,0,.6)',
                    letterSpacing: 0.3,
                    pointerEvents: 'none',
                    zIndex: 5,
                  }}>{celebrateFx.text}</div>
                )}
                {DICE_MODE && SHOW_DICE_BAR && (
                  <div style={styles.diceOverlay}>
                    {(() => { const rb=rollBest.sing; const faces = rb? rb.faces : facesFor(vocals); const val = rb? rb.value : null; const frac = val? (faces+1-val)/faces : null; const bg = frac==null? 'rgba(0,0,0,.35)' : (frac>=0.66? 'rgba(80,180,120,.55)' : frac>=0.33? 'rgba(200,160,80,.55)' : 'rgba(200,90,90,.55)'); return (
                      <div style={{...styles.diceChip, background:bg}} title="Sing">
                        <div style={styles.diceLabel}>S</div>
                        <div style={styles.diceVal}>{val? `${val}/${faces}` : `d${faces}`}</div>
                      </div>
                    ); })()}
                    {(() => { const rb=rollBest.write; const faces = rb? rb.faces : facesFor(writing); const val = rb? rb.value : null; const frac = val? (faces+1-val)/faces : null; const bg = frac==null? 'rgba(0,0,0,.35)' : (frac>=0.66? 'rgba(80,180,120,.55)' : frac>=0.33? 'rgba(200,160,80,.55)' : 'rgba(200,90,90,.55)'); return (
                      <div style={{...styles.diceChip, background:bg}} title="Write">
                        <div style={styles.diceLabel}>W</div>
                        <div style={styles.diceVal}>{val? `${val}/${faces}` : `d${faces}`}</div>
                      </div>
                    ); })()}
                    {(() => { const rb=rollBest.perform; const faces = rb? rb.faces : facesFor(stage); const val = rb? rb.value : null; const frac = val? (faces+1-val)/faces : null; const bg = frac==null? 'rgba(0,0,0,.35)' : (frac>=0.66? 'rgba(80,180,120,.55)' : frac>=0.33? 'rgba(200,160,80,.55)' : 'rgba(200,90,90,.55)'); return (
                      <div style={{...styles.diceChip, background:bg}} title="Perform">
                        <div style={styles.diceLabel}>P</div>
                        <div style={styles.diceVal}>{val? `${val}/${faces}` : `d${faces}`}</div>
                      </div>
                    ); })()}
                    <button disabled={remaining<=0} onClick={() => setActions((arr)=>[...arr,{t:'rest'}])} style={styles.restBtn}>Rest</button>
                    <div style={{...styles.sub, marginLeft:8}}>Lower rolls are better; better dice reduce worst-case.</div>
                  </div>
                )}
                {/* Overlayed action buttons on room */}
                {!isPerforming && !financeOpen && !endYearReady && !isOver && (
                  <div style={styles.buttonsOverlay}>
                    <div style={styles.actionBtnWrap}>
                      <button disabled={!conceptLocked || remaining<=0 || isActionBusy} onClick={() => instruct("practice")} style={styles.actionBtn}>
                        <img src={actionButtonSrc('practice')} alt="Sing" style={{
                          ...styles.actionImg,
                          ...((rollRing.show && rollRing.action==='sing') ? { filter: solidOutlineFilter(rollRing.color) } : (rollGlow.sing ? { filter: solidOutlineFilter(rollGlow.sing) } : {})),
                        }} />
                        {DICE_MODE && (rollBest?.sing?.value!=null) && !(rollFx.show && rollFx.action==='sing') && (
                          <div style={styles.actionBtnRoll}>{rollBest.sing.value}</div>
                        )}
                      </button>
                    </div>
                    <div style={styles.actionBtnWrap}>
                      <button disabled={!conceptLocked || remaining<=0 || isActionBusy} onClick={() => instruct("write")} style={styles.actionBtn}>
                        <img src={actionButtonSrc('write')} alt="Write" style={{
                          ...styles.actionImg,
                          ...((rollRing.show && rollRing.action==='write') ? { filter: solidOutlineFilter(rollRing.color) } : (rollGlow.write ? { filter: solidOutlineFilter(rollGlow.write) } : {})),
                        }} />
                        {DICE_MODE && (rollBest?.write?.value!=null) && !(rollFx.show && rollFx.action==='write') && (
                          <div style={styles.actionBtnRoll}>{rollBest.write.value}</div>
                        )}
                      </button>
                    </div>
                    <div style={styles.actionBtnWrap}>
                      <button disabled={!conceptLocked || remaining<=0 || isActionBusy} onClick={() => instruct("perform")} style={styles.actionBtn}>
                        <img src={actionButtonSrc('perform')} alt="Perform" style={{
                          ...styles.actionImg,
                          ...((rollRing.show && rollRing.action==='perform') ? { filter: solidOutlineFilter(rollRing.color) } : (rollGlow.perform ? { filter: solidOutlineFilter(rollGlow.perform) } : {})),
                        }} />
                        {DICE_MODE && (rollBest?.perform?.value!=null) && !(rollFx.show && rollFx.action==='perform') && (
                          <div style={styles.actionBtnRoll}>{rollBest.perform.value}</div>
                        )}
                      </button>
                    </div>
                  </div>
                )}
                {/* Bottom-right CTA: Choose venue & perform (replaces centered tick) */}
                {!isPerforming && canRelease && !endYearReady && !isOver && (
                  <button
                    onClick={() => { if (!finishedReady) finishSong(); setVenueOpen(true); }}
                    title="Choose venue & perform"
                    style={styles.performCta}
                  >
                    Choose venue & perform
                  </button>
                )}
                {!isPerforming && (endYearReady || isOver) && (
                  <button
                    onClick={() => { setFinaleSummaryOpen(true); setEndYearReady(false); }}
                    title="End year"
                    style={styles.performCta}
                  >
                    End year
                  </button>
                )}

                {financeOpen && (
                  <div style={styles.overlayClear} onClick={() => setFinanceOpen(false)}>
                    <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
                      <div style={{ ...styles.mirrorFrame, backgroundImage: "url('/art/modalframe_desktop.png')" }}>
                        <div className="hide-scrollbar" style={{ ...styles.mirrorInner, left:'8%', right:'8%', display:'flex', alignItems:'stretch', justifyContent:'center' }}>
                          <div style={{ position:'relative', width:'100%', height:'100%', borderRadius:12, overflow:'hidden' }}>
                            <div style={{ ...styles.desktopIcons, marginLeft: 12, top: 6 }}>
                              <div style={styles.desktopColumn}>
                                <div style={styles.desktopIconWrap}>
                                  <button style={styles.desktopIcon} title="MyBubble" onClick={() => { setSelectedFriendId(null); setShowFriendsList(false); setSocialOpen(true); }}>
                                    <div style={{ position:'relative' }}>
                                      <img src="/art/mybubbleicon.png" alt="MyBubble" style={styles.desktopIconImg} />
                                      {(pendingFriendEvents.some(ev=>ev && ev.week===week) && lastFriendProgressWeek !== week) && (
                                        <div style={{ position:'absolute', right:-2, top:-2, width:14, height:14, borderRadius:99, background:'#e65b7a', border:'1px solid rgba(0,0,0,.4)' }} />
                                      )}
                                    </div>
                                  </button>
                                  <div style={styles.desktopIconLabel}>myBubble</div>
                                </div>
                                <div style={styles.desktopIconWrap}>
                                  <button style={styles.desktopIcon} title="Settings" onClick={() => setMenuOpen(true)}>
                                    <img src="/art/settingicon.png" alt="Settings" style={styles.desktopIconImg} />
                                  </button>
                                  <div style={styles.desktopIconLabel}>Settings</div>
                                </div>
                              </div>
                              <div style={styles.desktopIconWrap}>
                                <button style={styles.desktopIcon} title="My Music" onClick={() => setMyMusicOpen(true)}>
                                  <img src="/art/shizyfiicon.png" alt="My Music" style={styles.desktopIconImg} />
                                </button>
                                <div style={styles.desktopIconLabel}>Shizy-FI</div>
                              </div>
                              <div style={styles.desktopIconWrap}>
                                <button style={styles.desktopIcon} title="Calendar" onClick={() => setCalendarOpen(true)}>
                                  <img src="/art/calendaricon.png" alt="Calendar" style={styles.desktopIconImg} />
                                </button>
                                <div style={styles.desktopIconLabel}>Calendar</div>
                              </div>
                              <div style={styles.desktopIconWrap}>
                                <button style={styles.desktopIcon} title="Shop" onClick={() => setShopOpen(true)}>
                                  <img src="/art/shopicon.png" alt="Shop" style={styles.desktopIconImg} />
                                </button>
                                <div style={styles.desktopIconLabel}>Am-Oz-on</div>
                              </div>
                            </div>
                            <div style={styles.desktopScanlinesOverlay} />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Book Gig moved into the computer modal */}
            {/* Gigs count removed per request */}

            {/* Removed old finishedReady CTA block; now handled in-room bottom-right */}
          </section>
        </div>

        {/* Streamlined: hide the persistent last result section */}

        {isOver && suppressFinale && (
          <div style={styles.overlayClear}>
            <div style={{ ...styles.modal, maxWidth: 460 }}>
              <div style={styles.title}>Year Summary</div>
              <div style={{ marginTop: 8 }}>
                <div style={styles.statRow}><span>Songs Released</span><b>{songHistory.length}</b></div>
                <div style={styles.statRow}><span>Best Chart</span><b>{bestChart != null ? `#${bestChart}` : ''}</b></div>
                <div style={styles.statRow}><span>Best Grade</span><b>{bestGrade ?? ''}</b></div>
                <div style={styles.statRow}><span>Total Earnings</span><b>{songHistory.reduce((sum,s)=> sum + (s.moneyGain||0), 0)}</b></div>
                <div style={styles.statRow}><span>Final Fans</span><b>{fans}</b></div>
                <div style={{ ...styles.sub, marginTop: 8 }}>
                  Thanks for playing Season 1! Start a new year and push for #1.
                </div>
              </div>
              <button onClick={restart} style={{ ...styles.primaryBtn, marginTop: 14 }}>
                Start New Year
              </button>
            </div>
          </div>
        )}

        {/* My Furniture modal */}
        {furnitureOpen && (
          <div style={styles.overlayClear} onClick={() => setFurnitureOpen(false)}>
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={styles.mirrorFrame}>
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, top: '22%', bottom: '10%', justifyContent: 'flex-start' }}>
                  <div style={styles.title}>My Furniture</div>
                  <div style={{ ...styles.sub, marginTop: 6 }}>Toggle which items appear in your room.</div>
                  <div style={{ marginTop: 10, display:'grid', gap:8 }}>
                    {lampUnlocked && (
                      <div style={{ display:'flex', alignItems:'center', gap:10, border:'1px solid rgba(255,255,255,.2)', borderRadius:10, padding:8 }}>
                        <img src={'/art/lavalamp.png'} alt="Lamp" style={{ width:48, height:48, objectFit:'contain' }} onError={(e)=>{ e.currentTarget.style.display='none'; }} />
                        <div style={{ fontWeight:800, flex:1 }}>Neon Dorm Lamp</div>
                        <button style={lampVisible ? styles.smallBtn : { ...styles.smallBtn, opacity:.7 }} onClick={() => {
                          setLampVisible(v => { const nv = !v; if (nv) setFairylightsVisible(false); return nv; });
                        }}>{lampVisible ? 'Visible' : 'Hidden'}</button>
                      </div>
                    )}
                    {fairylightsUnlocked && (
                      <div style={{ display:'flex', alignItems:'center', gap:10, border:'1px solid rgba(255,255,255,.2)', borderRadius:10, padding:8 }}>
                        <img src={'/art/fairylights.png'} alt="Fairy Lights" style={{ width:48, height:48, objectFit:'contain' }} onError={(e)=>{ e.currentTarget.style.display='none'; }} />
                        <div style={{ fontWeight:800, flex:1 }}>Frosted Jar with Fairy Lights</div>
                        <button style={fairylightsVisible ? styles.smallBtn : { ...styles.smallBtn, opacity:.7 }} onClick={() => {
                          setFairylightsVisible(v => { const nv = !v; if (nv) setLampVisible(false); return nv; });
                        }}>{fairylightsVisible ? 'Visible' : 'Hidden'}</button>
                      </div>
                    )}
                    {vinylUnlocked && (
                      <div style={{ display:'flex', alignItems:'center', gap:10, border:'1px solid rgba(255,255,255,.2)', borderRadius:10, padding:8 }}>
                        <img src={'/art/framedvinyl.png'} alt="Vinyl" style={{ width:48, height:48, objectFit:'contain' }} onError={(e)=>{ e.currentTarget.style.display='none'; }} />
                        <div style={{ fontWeight:800, flex:1 }}>Custom Vinyl Sleeve</div>
                        <button style={vinylVisible ? styles.smallBtn : { ...styles.smallBtn, opacity:.7 }} onClick={() => setVinylVisible(v=>!v)}>{vinylVisible ? 'Visible' : 'Hidden'}</button>
                      </div>
                    )}
                    {polaroidUnlocked && (
                      <div style={{ display:'flex', alignItems:'center', gap:10, border:'1px solid rgba(255,255,255,.2)', borderRadius:10, padding:8 }}>
                        <img src={'/art/forestpolaroid.png'} alt="Polaroid" style={{ width:48, height:48, objectFit:'contain' }} onError={(e)=>{ e.currentTarget.style.display='none'; }} />
                        <div style={{ fontWeight:800, flex:1 }}>Polaroid Photograph</div>
                        <button style={polaroidVisible ? styles.smallBtn : { ...styles.smallBtn, opacity:.7 }} onClick={() => setPolaroidVisible(v=>!v)}>{polaroidVisible ? 'Visible' : 'Hidden'}</button>
                      </div>
                    )}
                    {candleUnlocked && (
                      <div style={{ display:'flex', alignItems:'center', gap:10, border:'1px solid rgba(255,255,255,.2)', borderRadius:10, padding:8 }}>
                        <img src={'/art/wizmascandle.gif'} alt="Candle" style={{ width:48, height:48, objectFit:'contain' }} onError={(e)=>{ e.currentTarget.style.display='none'; }} />
                        <div style={{ fontWeight:800, flex:1 }}>Pine & Smoke Candle</div>
                        <button style={candleVisible ? styles.smallBtn : { ...styles.smallBtn, opacity:.7 }} onClick={() => {
                          setCandleVisible(v => { const nv = !v; if (nv) setOnairVisible(false); return nv; });
                        }}>{candleVisible ? 'Visible' : 'Hidden'}</button>
                      </div>
                    )}
                    {onairUnlocked && (
                      <div style={{ display:'flex', alignItems:'center', gap:10, border:'1px solid rgba(255,255,255,.2)', borderRadius:10, padding:8 }}>
                        <img src={'/art/onair.png'} alt="ON AIR" style={{ width:48, height:48, objectFit:'contain' }} onError={(e)=>{ e.currentTarget.style.display='none'; }} />
                        <div style={{ fontWeight:800, flex:1 }}>Mini ON AIR Sign</div>
                        <button style={onairVisible ? styles.smallBtn : { ...styles.smallBtn, opacity:.7 }} onClick={() => {
                          setOnairVisible(v => { const nv = !v; if (nv) setCandleVisible(false); return nv; });
                        }}>{onairVisible ? 'Visible' : 'Hidden'}</button>
                      </div>
                    )}
                    {!(lampUnlocked||vinylUnlocked||polaroidUnlocked||candleUnlocked||onairUnlocked) && (
                      <div style={{ ...styles.sub, marginTop: 8 }}>No furniture unlocked yet.</div>
                    )}
                  </div>
                  <button onClick={() => setFurnitureOpen(false)} style={{ ...styles.primaryBtn, marginTop: 12 }}>Close</button>
                </div>
              </div>
            </div>
          </div>
        )}
        {friendModal.open && (
          <VisualNovelModal
            open={friendModal.open}
            friendModal={friendModal}
            setFriendModal={setFriendModal}
            performerName={performerName}
            songHistory={songHistory}
            styles={styles}
            friends={friends}
            setFriends={setFriends}
            setNudges={setNudges}
            setBonusRolls={setBonusRolls}
            setNextRollOverride={setNextRollOverride}
            pushToast={pushToast}
            setWriting={setWriting}
            setVocals={setVocals}
            pinkBubblesUnlocked={pinkBubblesUnlocked}
            setPinkBubblesUnlocked={setPinkBubblesUnlocked}
            spotlightSnapUnlocked={spotlightSnapUnlocked}
            setSpotlightSnapUnlocked={setSpotlightSnapUnlocked}
            vinylUnlocked={vinylUnlocked}
            setVinylUnlocked={setVinylUnlocked}
            rainfallUnlocked={rainfallUnlocked}
            setRainfallUnlocked={setRainfallUnlocked}
            polaroidUnlocked={polaroidUnlocked}
            setPolaroidUnlocked={setPolaroidUnlocked}
            candleUnlocked={candleUnlocked}
            setCandleUnlocked={setCandleUnlocked}
            setCandleVisible={setCandleVisible}
            onairUnlocked={onairUnlocked}
            setOnairUnlocked={setOnairUnlocked}
            setOnairVisible={setOnairVisible}
            fairylightsUnlocked={fairylightsUnlocked}
            setFairylightsUnlocked={setFairylightsUnlocked}
            setFairylightsVisible={setFairylightsVisible}
            setLampVisible={setLampVisible}
            unlockedPosters={unlockedPosters}
            setUnlockedPosters={setUnlockedPosters}
            currentPosterIdx={currentPosterIdx}
            setCurrentPosterIdx={setCurrentPosterIdx}
            lampGiftOpen={lampGiftOpen}
            setLampGiftOpen={setLampGiftOpen}
            lampUnlocked={lampUnlocked}
            setLampUnlocked={setLampUnlocked}
            midnightHazeGiftOpen={midnightHazeGiftOpen}
            setMidnightHazeGiftOpen={setMidnightHazeGiftOpen}
            midnightHazeUnlocked={midnightHazeUnlocked}
            setMidnightHazeUnlocked={setMidnightHazeUnlocked}
            rivetFilterUnlocked={rivetFilterUnlocked}
            setRivetFilterUnlocked={setRivetFilterUnlocked}
            POSTERS={POSTERS}
          />
        )}

        

        {progressOpen && (
          <div style={styles.overlayClear} onClick={() => setProgressOpen(false)}>
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={styles.mirrorFrame}>
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, top: '22%', bottom: '12%', justifyContent: 'flex-start' }}>
                  <div style={{ ...styles.title, textAlign:'center' }}>{conceptLocked ? 'Current Song' : 'Create a new song'}</div>
              <div style={{ ...styles.sub, marginTop: 6 }}>
                {conceptLocked && songName ? (
                  <span style={{ fontSize: 18, fontWeight: 900 }}>Working on: <b>{songName}</b></span>
                ) : (
                  <span style={{ fontSize: 18, fontWeight: 900 }}>No active song yet.</span>
                )}
                {false && DICE_MODE && (
                  <div style={styles.progressHelp}>
                    Current die: d{facesFor(stage)}{nextDieInfo(stage) ? ` Next: d${nextDieInfo(stage).f} at ${nextDieInfo(stage).t.toFixed(1)}` : ' Max die unlocked'}
                  </div>
                )}
                {false && DICE_MODE && (
                  <div style={styles.progressHelp}>
                    Current die: d{facesFor(stage)}{nextDieInfo(stage) ? ` Next: d${nextDieInfo(stage).f} at ${nextDieInfo(stage).t.toFixed(1)}` : ' Max die unlocked'}
                  </div>
                )}
              </div>
              {conceptLocked && (
                <div style={{ marginTop: 10 }}>
                  <div style={{ ...styles.sub, fontSize: 14 }}>
                    Pairing: <b>{genre}</b> + <b>{theme}</b>
                  </div>
                  <div style={{ marginTop: 6, fontWeight: 800, color: compat>0 ? '#64d49a' : compat<0 ? '#e37a7a' : '#e1b768' }}>
                    {compat>0 ? 'great combination' : compat<0 ? 'risky combination' : 'okay combination'}
                  </div>
                </div>
              )}
              {null}
                </div>
              </div>
            </div>
          </div>
        )}

        {polaroidOpen && (
          <div style={styles.overlayClear} onClick={() => setPolaroidOpen(false)}>
            <img src={'/art/forestpolaroid.png'} alt={'Polaroid'} style={{ maxWidth: '92%', maxHeight: '88%', objectFit:'contain' }} />
          </div>
        )}

        {menuOpen && !isOver && (
                <div style={styles.overlayClear} onClick={() => setMenuOpen(false)}>
                  <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
                    <div style={styles.mirrorFrame}>
                      <div className="hide-scrollbar" style={{ ...styles.mirrorInner, top: '22%', bottom: '12%', justifyContent: 'flex-start' }}>
                        <div style={{ ...styles.title, textAlign:'center' }}>Settings</div>
              <div style={{ ...styles.sub, marginTop: 6 }}>
                Week {week} | Money {'\u00A3'}{money} | Fans {fans}
              </div>
              <div style={{ display: "flex", flexDirection: "column", gap: 8, marginTop: 12 }}>
                <button onClick={() => setMenuOpen(false)} style={styles.primaryBtn}>Resume</button>
                <button onClick={saveNow} style={styles.secondaryBtn}>Save now</button>
                <button onClick={() => { clearSave(); setMenuOpen(false); }} style={styles.secondaryBtn}>Clear save</button>
                <button onClick={() => { restart(); setMenuOpen(false); }} style={styles.secondaryBtn}>Restart run</button>
                {!debugUnlocked && (
                  <button
                    onClick={() => {
                      try {
                        const val = window.prompt('Enter debug password');
                        if (!val) return;
                        if (val === 'shizdebug') { setDebugUnlocked(true); pushToast('Debug unlocked'); }
                        else { pushToast('Incorrect password'); }
                      } catch (_) { /* ignore */ }
                    }}
                    style={styles.secondaryBtn}
                  >Unlock debug</button>
                )}
                {debugUnlocked && (
                  <>
                    <button onClick={() => { setFans(f=>f+10); pushToast('Fans +10 (debug)'); }} style={styles.secondaryBtn}>Add 10 fans (debug)</button>
                    <button onClick={() => { setMoney(m=>m+100); pushToast('Money +£100 (debug)'); }} style={styles.secondaryBtn}>Add £100 (debug)</button>
                    <button onClick={() => {
                      try {
                        setMidnightHazeUnlocked(true); setMidnightHazeEnabled(true);
                        setRainfallUnlocked(true); setRainfallEnabled(true);
                        setSpotlightSnapUnlocked(true); setSpotlightSnapEnabled(true);
                        setRivetFilterUnlocked(true); setRivetFilterEnabled(true);
                        if (typeof setPinkBubblesUnlocked === 'function') setPinkBubblesUnlocked(true);
                        if (typeof setPinkBubblesEnabled === 'function') setPinkBubblesEnabled(true);
                        pushToast('All performance cosmetics unlocked (debug)');
                      } catch(_) {}
                    }} style={styles.secondaryBtn}>Unlock all performance cosmetics (debug)</button>
                    <button onClick={() => { setDebugUnlocked(false); pushToast('Debug locked'); }} style={styles.secondaryBtn}>Lock debug</button>
                  </>
                )}
              </div>
              <div style={{ marginTop: 10 }}>
                <label style={{ display:'flex', alignItems:'center', gap:8 }}>
                  <input type="checkbox" checked={earlyFinishEnabled} onChange={(e)=>setEarlyFinishEnabled(e.target.checked)} />
                  Allow Early Finish (once S/W/P rolled)
                </label>
              </div>
              <div style={{ marginTop: 8 }}>
                <label style={{ display:'flex', alignItems:'center', gap:8 }}>
                  <input type="checkbox" checked={nightMode} onChange={(e)=>setNightMode(e.target.checked)} />
                  Night mode
                </label>
              </div>
              <div style={{ ...styles.sub, marginTop: 10 }}>Autosave: On</div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

        {showWelcome && (
          <div
            style={styles.overlayClear}
            onClick={() => {
              if (welcomeStep === 2) setShowWelcome(false);
            }}
          >
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={styles.mirrorFrame}>
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, top: '22%', bottom: '12%', justifyContent: 'flex-start' }}>
                  {welcomeStep === 1 ? (
                    <>
                      <div style={{ ...styles.title, textAlign: 'center' }}>Welcome to Shiz Academy</div>
                      <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:10, marginTop: 10 }}>
                        <div style={{ width:'100%', maxWidth: 520 }}>
                          <div style={{ ...styles.label, marginTop: 0, textAlign:'center' }}>What is your name?</div>
                          <div style={{ ...styles.inlineRow, justifyContent:'center' }}>
                            <input
                              autoFocus
                              value={welcomeName}
                              onChange={(e)=> setWelcomeName(e.target.value)}
                              onKeyDown={(e)=>{ if(e.key==='Enter'){ const nm = (welcomeName||'').trim() || 'Your Performer'; setPerformerName(nm); setWelcomeStep(2); } }}
                              placeholder="Type your name..."
                              style={{ ...styles.input, maxWidth: 320 }}
                              enterKeyHint="next"
                            />
                            <button
                              style={styles.smallBtn}
                              onClick={()=>{ const nm = (welcomeName||'').trim() || 'Your Performer'; setPerformerName(nm); setWelcomeStep(2); }}
                            >Next</button>
                          </div>
                        </div>
                      </div>
                    </>
                  ) : (
                    <>
                      <div style={{ ...styles.title, textAlign: 'center' }}>{`Welcome ${performerName}`}</div>
                      <div style={{ display:'flex', gap:12, alignItems:'center', marginTop: 10 }}>
                        <div style={{ flex:'0 0 204px', display:'flex', justifyContent:'center' }}>
                          <img src="/art/academylogo.png" alt="Shiz Academy Crest" style={{ height: 184, width: 'auto', objectFit: 'contain', filter: 'drop-shadow(0 2px 6px rgba(0,0,0,.25))' }} />
                        </div>
                        <div style={{ flex: 1 }}>
                          <div style={{ ...styles.sub, marginTop: 0, lineHeight: 1.4 }}>
                            This year is all about making music. Create and perform songs across Oz. There is a big celebration at the end of the year. Perhaps you will be able to perform a masterpiece?
                          </div>
                          <div style={{ marginTop: 10 }}>
                            <button
                              style={styles.primaryBtn}
                              onClick={() => {
                                setShowWelcome(false);
                                try {
                                  const toNotify = (activeEvents||[]).filter(ev => !ev.choices && !(eventsResolved[ev.id] && eventsResolved[ev.id].notified));
                                  const upcomingNext = (eventsSchedule||[]).find(e => e.week === week + 1) || null;
                                  setEventInfoModal({ events: toNotify, upcoming: upcomingNext, weekly: true });
                                  setWeeklyInfoShownWeek(week);
                                } catch(_) {}
                              }}
                            >Start</button>
                          </div>
                        </div>
                      </div>
                    </>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {showConcept && !conceptLocked && (
          <div
            style={styles.overlayClear}
            onClick={(e) => {
              const ae = document.activeElement;
              if (ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.getAttribute('contenteditable') === 'true')) {
                try { ae.blur(); } catch(_) {}
                e.stopPropagation();
                return;
              }
              setShowConcept(false);
            }}
          >
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={styles.mirrorFrame}>
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, top: '22%', bottom: '12%', justifyContent: 'flex-start' }}>
                  <div style={{ ...styles.title, textAlign:'center' }}>Create a new song</div>
              <div style={{ ...styles.label, marginTop: 10 }}>Genre</div>
              <div style={{ display:'flex', alignItems:'center', gap:8 }}>
                <select value={genre} onChange={(e)=>setGenre(e.target.value)} style={{ ...styles.input, width:'auto', minWidth: 180, padding:'6px 10px', background:'white', color:'black' }}>
                  {availableGenres.map(g => (<option key={g} value={g}>{g}</option>))}
                </select>
              </div>

              <div style={styles.label}>Theme</div>
              <div style={{ display:'flex', alignItems:'center', gap:8 }}>
                <select value={theme} onChange={(e)=>setTheme(e.target.value)} style={{ ...styles.input, width:'auto', minWidth: 200, padding:'6px 10px', background:'white', color:'black' }}>
                  {THEMES.map(t => (<option key={t} value={t}>{t}</option>))}
                </select>
              </div>

              <div style={{ ...styles.label, marginTop: 8 }}>Song name</div>
              <div style={styles.inlineRow}>
                <input
                  value={songName}
                  onChange={(e) => setSongName(e.target.value)}
                  onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); e.currentTarget.blur(); } }}
                  placeholder="Type a song name..."
                  style={styles.input}
                  enterKeyHint="done"
                />
                <button
                  style={styles.smallBtn}
                  onClick={() => { try { if (document.activeElement) document.activeElement.blur(); } catch(_) {} }}
                >OK</button>
              </div>
              {compat < 0 && (
                <div style={{ ...styles.sub, marginTop: 8, color: 'rgba(255,120,120,.95)' }}>
                  Risky pairing
                </div>
              )}

              <div style={{ display: 'flex', gap: 8, marginTop: 12 }}>
                <button onClick={() => { setConceptLocked(true); setShowConcept(false); const c = compat; setPairFeedback(c>0 ? 'great combination' : c<0 ? 'risky combination' : 'okay combination'); }} disabled={!songName.trim()} style={!songName.trim() ? styles.primaryBtnDisabled : styles.primaryBtn}>Start composing</button>
              </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {statsOpen && (
          <div style={styles.overlayClear} onClick={() => setStatsOpen(false)}>
            <div style={{ ...styles.mirrorModal, transform: mirrorAnim? 'scale(1) translateY(0)' : 'scale(.985) translateY(-6px)', opacity: mirrorAnim? 1 : 0, transition: 'transform 220ms ease, opacity 220ms ease' }} onClick={(e) => e.stopPropagation()}>
              <div style={{ ...styles.mirrorFrame, backgroundImage: "url('/art/modalframe_mirror.png')" }}>
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, top: '22%', right: '13%', bottom: '4%', left: '15%', justifyContent: 'flex-start' }}>
                  <div style={{ marginTop: 0, display:'flex', gap:16, alignItems:'flex-start', paddingLeft: 50 }}>
                    <div style={{ display:'flex', flexDirection:'column', alignItems:'center', marginLeft: -40 }}>
                      <div style={styles.portraitWrap}>
                        <img src="/art/mirrorportrait.png" alt="Performer portrait" style={styles.portraitImg} />
                      </div>
                      <div style={{
                        ...styles.title,
                        textAlign: 'center',
                        marginTop: 4,
                        fontFamily: "'Lobster', cursive",
                        fontWeight: 400,
                        color: '#0d2b6f'
                      }}>
                        {editingName ? (
                          <div style={{ display:'flex', gap:6, alignItems:'center' }}>
                            <input
                              autoFocus
                              value={tempName}
                              onChange={(e)=>setTempName(e.target.value)}
                              onKeyDown={(e)=>{ if(e.key==='Enter'){ setPerformerName(tempName.trim()||'Your Performer'); setEditingName(false);} if(e.key==='Escape'){ setEditingName(false);} }}
                              style={{ ...styles.input, height:32, fontWeight:800, color:'#0d2b6f' }}
                            />
                            <button className="btn" onClick={()=>{ setPerformerName(tempName.trim()||'Your Performer'); setEditingName(false); }} style={{ ...styles.smallBtn, color:'#0d2b6f' }}>Save</button>
                          </div>
                        ) : (
                          <span onClick={()=>{ setTempName(performerName); setEditingName(true); }} title="Click to rename" style={{ cursor:'text' }}>{performerName}</span>
                        )}
                      </div>
                    </div>
                    <div style={{ flex:1, marginTop: 20 }}>
                  <div style={{ ...styles.progressLabel, color:'#0d2b6f' }}><span>Sing</span></div>
                {(() => { 
                  const pr = dieProgress(vocals); const pct = Math.round((pr.pct||0)*100); const nextLabel = pr.next? `d${pr.next}` : 'MAX';
                  const col1 = '#B084F5', col2 = '#7A4CC4';
                  return (
                  <div style={{ ...styles.progressTrack, display:'flex', alignItems:'center', gap:10, padding:'5px 10px', background:'rgba(176,132,245,.15)', border:'1px solid rgba(176,132,245,.35)', borderRadius:12, width:'72%' }}>
                    {dieBadgePath(pr.curr) ? (
                      <div style={{...styles.dieBadgeWrap, marginLeft:-6}}>
                        <img src={dieBadgePath(pr.curr)} alt={`d${pr.curr}`} style={styles.dieBadge} />
                        <div style={styles.dieBadgeText}>d{pr.curr}</div>
                      </div>
                    ) : (
                      <div style={{ ...styles.dieToken, background:'linear-gradient(180deg,#c39af7,#8d60d8)', border:'1px solid rgba(176,132,245,.8)' }}>d{pr.curr}</div>
                    )}
                    <div style={{ position:'relative', flex:1, height:9, borderRadius:999, background:'rgba(255,255,255,.08)', boxShadow:'inset 0 2px 4px rgba(0,0,0,.25), 0 1px 2px rgba(255,255,255,.15)' }}>
                      <div style={{ position:'absolute', inset:0, borderRadius:999, overflow:'hidden' }}>
                        <div style={{ width:`${pct}%`, height:'100%', background:`linear-gradient(180deg, ${col1}, ${col2})` }} />
                        <div style={{ position:'absolute', inset:0, borderRadius:999, background:'linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,0))' }} />
                      </div>
                      {pr.next && (
                        <div style={{ position:'absolute', left:`calc(${pct}% - 5px)`, top:'50%', transform:'translate(-50%,-50%)', width:10, height:10, borderRadius:999, background:'#fff', boxShadow:'0 0 7px rgba(176,132,245,.9)', border:'1px solid #6d49b7' }} />
                      )}
                      {/* Shared tracks section (moved below) - disabled */}
                      {false && (
                      <div style={{ marginTop: 6 }}>
                        <div style={{ fontWeight:800, marginBottom:4 }}>Shared Tracks</div>
                        {(() => {
                          const list = (sharedSongs||[]).filter(s => (s.shareWeek||0) <= week);
                          if (!list.length) return (<div style={styles.sub}>No shared tracks yet.</div>);
                          return (
                            <div style={{ display:'grid', gap:8 }}>
                              {list.map(s => (
                                <div key={s.id} style={{ border:'1px solid rgba(54,46,70,.25)', borderRadius:10, padding:8, display:'flex', alignItems:'center', gap:10 }}>
                                  <div style={{ fontWeight:800 }}>{s.artist} - {s.title}</div>
                                  <div style={{ marginLeft:'auto', display:'flex', gap:6 }}>
                                    {(() => { const isPlaying = !!(playingTrend && playingTrend.id === `${s.artist}__${s.title}`); return (
                                      <button style={styles.smallBtn} onClick={() => {
                                        try {
                                          const item = { artist: s.artist, title: s.title, audioSources: [s.audioSrc] };
                                          playTrendItem(item);
                                          setSharedSongs(arr => arr.map(x => x.id===s.id ? { ...x, listened:true } : x));
                                        } catch(_){}
                                      }}>{isPlaying ? 'Stop' : 'Play'}</button>
                                    ); })()}
                                    <button style={s.liked? { ...styles.smallBtn, background:'#64d49a', borderColor:'#64d49a', color:'#0f1524' } : styles.smallBtn} onClick={() => {
                                      if (s.liked) return;
                                      setSharedSongs(arr => arr.map(x => x.id===s.id ? { ...x, liked:true } : x));
                                      pushToast(`You liked ${s.artist}'s track ?" it may chart higher next week.`);
                                    }}>Like</button>
                                  </div>
                                </div>
                              ))}
                            </div>
                          );
                        })()}
                      </div>
                      )}
                    </div>
                    {dieBadgePath(pr.next) ? (
                      <div style={{...styles.dieBadgeWrap, marginRight:-6}}>
                        <img src={dieBadgePath(pr.next)} alt={`d${pr.next}`} style={styles.dieBadge} />
                        <div style={styles.dieBadgeText}>{nextLabel}</div>
                      </div>
                    ) : (
                      <div style={{ ...styles.dieToken, background:'linear-gradient(180deg,#d7c4fb,#9a79e5)', border:'1px solid rgba(176,132,245,.8)', opacity: pr.next? 1 : .5 }}>{nextLabel}</div>
                    )}
                  </div>
                ); })()}
                
                {false && DICE_MODE && (
                  <div style={styles.progressHelp}>
                    Current die: d{facesFor(vocals)}{nextDieInfo(vocals) ? ` ? Next: d${nextDieInfo(vocals).f} at = ${nextDieInfo(vocals).t.toFixed(1)}` : ' ? Max die unlocked'}
                  </div>
                )}
                {false && DICE_MODE && (
                  <div style={styles.progressHelp}>
                    Current die: d{facesFor(vocals)}{nextDieInfo(vocals) ? ` Next: d${nextDieInfo(vocals).f} at ${nextDieInfo(vocals).t.toFixed(1)}` : ' Max die unlocked'}
                  </div>
                )}

                <div style={{ ...styles.progressLabel, color:'#0d2b6f' }}><span>Write</span></div>
                {(() => { 
                  const pr = dieProgress(writing); const pct = Math.round((pr.pct||0)*100); const nextLabel = pr.next? `d${pr.next}` : 'MAX';
                  const col1 = '#5FE7D9', col2 = '#2AA296';
                  return (
                  <div style={{ ...styles.progressTrack, display:'flex', alignItems:'center', gap:10, padding:'5px 10px', background:'rgba(95,231,217,.12)', border:'1px solid rgba(95,231,217,.35)', borderRadius:12, width:'72%' }}>
                    {dieBadgePath(pr.curr) ? (
                      <div style={{...styles.dieBadgeWrap, marginLeft:-6}}>
                        <img src={dieBadgePath(pr.curr)} alt={`d${pr.curr}`} style={styles.dieBadge} />
                        <div style={styles.dieBadgeText}>d{pr.curr}</div>
                      </div>
                    ) : (
                      <div style={{ ...styles.dieToken, background:'linear-gradient(180deg,#8ff1e8,#3dbbb0)', border:'1px solid rgba(95,231,217,.7)' }}>d{pr.curr}</div>
                    )}
                    <div style={{ position:'relative', flex:1, height:9, borderRadius:999, background:'rgba(255,255,255,.08)', boxShadow:'inset 0 2px 4px rgba(0,0,0,.25), 0 1px 2px rgba(255,255,255,.15)' }}>
                      <div style={{ position:'absolute', inset:0, borderRadius:999, overflow:'hidden' }}>
                        <div style={{ width:`${pct}%`, height:'100%', background:`linear-gradient(180deg, ${col1}, ${col2})` }} />
                        <div style={{ position:'absolute', inset:0, borderRadius:999, background:'linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,0))' }} />
                      </div>
                      {pr.next && (
                        <div style={{ position:'absolute', left:`calc(${pct}% - 5px)`, top:'50%', transform:'translate(-50%,-50%)', width:10, height:10, borderRadius:999, background:'#fff', boxShadow:'0 0 7px rgba(95,231,217,.9)', border:'1px solid #1f7f76' }} />
                      )}
                    </div>
                    {dieBadgePath(pr.next) ? (
                      <div style={{...styles.dieBadgeWrap, marginRight:-6}}>
                        <img src={dieBadgePath(pr.next)} alt={`d${pr.next}`} style={styles.dieBadge} />
                        <div style={styles.dieBadgeText}>{nextLabel}</div>
                      </div>
                    ) : (
                      <div style={{ ...styles.dieToken, background:'linear-gradient(180deg,#c0f7f0,#70d9cf)', border:'1px solid rgba(95,231,217,.7)', opacity: pr.next? 1 : .5 }}>{nextLabel}</div>
                    )}
                  </div>
                ); })()}
                
                {false && DICE_MODE && (
                  <div style={styles.progressHelp}>
                    Current die: d{facesFor(writing)}{nextDieInfo(writing) ? ` ? Next: d${nextDieInfo(writing).f} at = ${nextDieInfo(writing).t.toFixed(1)}` : ' ? Max die unlocked'}
                  </div>
                )}
                {false && DICE_MODE && (
                  <div style={styles.progressHelp}>
                    Current die: d{facesFor(writing)}{nextDieInfo(writing) ? ` Next: d${nextDieInfo(writing).f} at ${nextDieInfo(writing).t.toFixed(1)}` : ' Max die unlocked'}
                  </div>
                )}

                <div style={{ ...styles.progressLabel, color:'#0d2b6f' }}><span>Dance</span></div>
                {(() => { 
                  const pr = dieProgress(stage); const pct = Math.round((pr.pct||0)*100); const nextLabel = pr.next? `d${pr.next}` : 'MAX';
                  const col1 = '#F7D774', col2 = '#C79C2A';
                  return (
                  <div style={{ ...styles.progressTrack, display:'flex', alignItems:'center', gap:10, padding:'5px 10px', background:'rgba(247,215,116,.12)', border:'1px solid rgba(247,215,116,.35)', borderRadius:12, width:'72%' }}>
                    {dieBadgePath(pr.curr) ? (
                      <div style={{...styles.dieBadgeWrap, marginLeft:-6}}>
                        <img src={dieBadgePath(pr.curr)} alt={`d${pr.curr}`} style={styles.dieBadge} />
                        <div style={styles.dieBadgeText}>d{pr.curr}</div>
                      </div>
                    ) : (
                      <div style={{ ...styles.dieToken, background:'linear-gradient(180deg,#ffe39c,#e1b951)', border:'1px solid rgba(247,215,116,.7)' }}>d{pr.curr}</div>
                    )}
                    <div style={{ position:'relative', flex:1, height:9, borderRadius:999, background:'rgba(255,255,255,.08)', boxShadow:'inset 0 2px 4px rgba(0,0,0,.25), 0 1px 2px rgba(255,255,255,.15)' }}>
                      <div style={{ position:'absolute', inset:0, borderRadius:999, overflow:'hidden' }}>
                        <div style={{ width:`${pct}%`, height:'100%', background:`linear-gradient(180deg, ${col1}, ${col2})` }} />
                        <div style={{ position:'absolute', inset:0, borderRadius:999, background:'linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,0))' }} />
                      </div>
                      {pr.next && (
                        <div style={{ position:'absolute', left:`calc(${pct}% - 5px)`, top:'50%', transform:'translate(-50%,-50%)', width:10, height:10, borderRadius:999, background:'#fff', boxShadow:'0 0 7px rgba(247,215,116,.9)', border:'1px solid #c29a2a' }} />
                      )}
                    </div>
                    {dieBadgePath(pr.next) ? (
                      <div style={{...styles.dieBadgeWrap, marginRight:-6}}>
                        <img src={dieBadgePath(pr.next)} alt={`d${pr.next}`} style={styles.dieBadge} />
                        <div style={styles.dieBadgeText}>{nextLabel}</div>
                      </div>
                    ) : (
                      <div style={{ ...styles.dieToken, background:'linear-gradient(180deg,#ffeab6,#f2cd62)', border:'1px solid rgba(247,215,116,.7)', opacity: pr.next? 1 : .5 }}>{nextLabel}</div>
                    )}
                  </div>
                ); })()}
                
                {false && DICE_MODE && (
                  <div style={styles.progressHelp}>
                    Current die: d{facesFor(stage)}{nextDieInfo(stage) ? ` ? Next: d${nextDieInfo(stage).f} at = ${nextDieInfo(stage).t.toFixed(1)}` : ' ? Max die unlocked'}
                  </div>
                )}
                    </div>
                  </div>
                  {null}
                </div>
              </div>
            </div>
          </div>
        )}

        {false && financeOpen}

        {socialOpen && (
          <div
            style={styles.overlayClear}
            onClick={() => {
              if (selectedFriendId != null) { setSelectedFriendId(null); return; }
              if (showFriendsList) { setShowFriendsList(false); return; }
              setSocialOpen(false);
            }}
          >
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={{ ...styles.mirrorFrame, backgroundImage: "url('/art/modalframe_mybubble.png')" }}>
                <div style={{ ...styles.desktopScanlinesOverlay, top:'16%', right:'7%', bottom:'12%', left:'7%' }} />
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, top: '22%', right: '12%', bottom: '12%', left: '10%', justifyContent: 'flex-start', color: '#362e46' }}>
              {null}
              {null}
              {!showFriendsList && (
              <div style={{ display:'flex', gap:12, marginTop: 8 }}>
                <div style={{ flex:'0 0 56px', display:'flex', flexDirection:'column', alignItems:'center', gap:10 }}>
                  <img
                    src={'/art/mybubble/profilepic.png'}
                    alt={''}
                    style={{ display:'block', width:56, height:'auto', borderRadius:12, border:'1px solid rgba(54,46,70,.25)' }}
                    onError={(e)=>{ e.currentTarget.style.display='none'; }}
                  />
                  <button title="Messages" onClick={() => setMyBubbleMessagesOpen(true)} style={{ position:'relative', background:'none', border:'none', padding:0, cursor:'pointer' }}>
                    <img
                      src={'/art/mybubble/messagebutton.png'}
                      alt={'Messages'}
                      style={{ display:'block', width:56, height:'auto', borderRadius:12, border:'1px solid rgba(54,46,70,.25)' }}
                      onError={(e)=>{ e.currentTarget.style.display='none'; }}
                    />
                    {(pendingFriendEvents.some(ev=>ev && ev.week===week) && !myBubbleMessagesOpen) && (
                      <div style={{ position:'absolute', right:-2, top:-2, width:14, height:14, borderRadius:99, background:'#e65b7a', border:'1px solid rgba(0,0,0,.4)' }} />
                    )}
                  </button>
                  <button title="Friends" onClick={() => setMyBubbleFriendsOpen(true)} style={{ background:'none', border:'none', padding:0, cursor:'pointer' }}>
                    <img
                      src={'/art/mybubble/friendsbutton.png'}
                      alt={'Friends'}
                      style={{ display:'block', width:56, height:'auto', borderRadius:12, border:'1px solid rgba(54,46,70,.25)' }}
                      onError={(e)=>{ e.currentTarget.style.display='none'; }}
                    />
                  </button>
                </div>
                <div style={{ flex:1, display:'flex', flexDirection:'column', gap:8 }}>
                  <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between' }}>
                    <img
                      src={'/art/mybubble/mybubbletitle.png'}
                      alt={'MyBubble'}
                      style={{ display:'block', width:220, height:'auto' }}
                      onError={(e)=>{ e.currentTarget.style.display='none'; }}
                    />
                {(() => {
                  const targetWeek = Math.max(1, week - 1);
                  const entry = (songHistory||[]).find(s=> s.releaseWeek === targetWeek);
                  const gain = (entry && Number.isFinite(entry.fansGain)) ? entry.fansGain : 0;
                  return (
                    <div style={{ display:'inline-flex', alignItems:'center', gap:8, padding:'6px 12px', borderRadius:999, border:'2px solid rgba(54,46,70,.25)', background:'rgba(255,255,255,.12)', fontWeight:800 }}>
                      <span style={{ opacity:.9 }}>Fans</span>
                      <span>{fans}</span>
                      <span style={{ marginLeft:6, color: gain > 0 ? '#64d49a' : 'rgba(255,255,255,.85)' }}>+{gain}</span>
                    </div>
                  );
                })()}
                  </div>
                  {(() => {
                    const targetWeek = Math.max(1, week - 1);
                    let entry = (songHistory||[]).find(s=> s.releaseWeek === targetWeek);
                    if (!entry) entry = (songHistory||[])[0];
                    if (!entry) return null;
                    return (
                      <div>
                        <div style={{ display:'block', width:'100%', boxSizing:'border-box', padding:'8px 12px', borderRadius:12, border:'2px solid rgba(54,46,70,.25)', background:'rgba(255,255,255,.10)', fontWeight:800 }}>
                          <div style={{ opacity:.9, marginBottom:4 }}>This week's drop:</div>
                          <div style={{ display:'flex', alignItems:'baseline', justifyContent:'space-between', gap:10 }}>
                            <div style={{ fontStyle:'italic', fontWeight:700, whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis', maxWidth: 240 }}>
                              {entry.songName || 'Your Song'}
                            </div>
                            <div style={{ fontWeight:900, fontSize:16, marginLeft:10 }}>Grade {entry.grade || '-'}</div>
                          </div>
                        </div>
                      </div>
                    );
                  })()}
                  <div style={{ marginTop: 8 }}>
                    <div>
                  {(() => {
                    // Find latest release for current calendar week (week-1), fallback to most recent entry
                    const targetWeek = Math.max(1, week - 1);
                    let entry = (songHistory||[]).find(s=> s.releaseWeek === targetWeek);
                    if (!entry) entry = (songHistory||[])[0];
                    if (!entry) return (<div style={styles.sub}>No songs yet. Release a song to see fan comments.</div>);
                    const header = null;
                    let comments = entry.fanComments && entry.fanComments.length ? entry.fanComments : generateFanComments(entry, performerName);
                    // Sanitize legacy metadata-style last line (e.g., 'Grade X - Genre - Theme')
                    const cleaned = comments.filter(c => !/^Grade\s/i.test((c||'').trim()));
                    if (cleaned.length < 3) {
                      while (cleaned.length < 3) cleaned.push('Loving the growth each week!');
                    }
                    comments = cleaned.slice(0,3);
                    return (
                      <>
                      <div style={{ display:'grid', gap:8 }}>
                        {comments.slice(0,3).map((t,i)=> {
                          const idx = fanIdxFor(targetWeek, i, seedTs);
                          return (
                            <div key={i} style={{ border:'2px solid rgba(54,46,70,.25)', borderRadius:10, padding:8, display:'flex', alignItems:'center', gap:8 }}>
                              <div style={fanAvatarStyle(idx, 44, fanSpriteMeta)} />
                              <div style={{ ...styles.sub, opacity:.95 }}>{t}</div>
                            </div>
                          );
                        })}
                      </div>
                      </>
                    );
                  })()}
                    </div>
                  </div>
                </div>
              </div>
              )}
              {showFriendsList && (
                <div style={{ marginTop: 10 }}>
                  <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:6 }}>
                    <div style={{ fontWeight:900 }}>{selectedFriendId ? 'Friend' : 'Friends'}</div>
                    <button style={styles.smallBtn} onClick={()=> { setSelectedFriendId(null); setShowFriendsList(false); }}>Back to MyBubble</button>
                  </div>
                  {selectedFriendId == null && (
                    <>
                      <div style={{ display:'grid', gap:8 }}>
                        {(() => {
                          const list = Object.keys(friends||{}).reduce((arr, fid) => {
                            const f = friends[fid]; const lv = (f && f.level) || 0;
                            if (lv>0) arr.push({ id: fid, name: (f && f.bio && f.bio.title) || fid, level: lv, max: 5 });
                            return arr;
                          }, []);
                          if (list.length===0) return (<div style={styles.sub}>No friends yet.</div>);
                          return list.map(f => (
                            <button key={f.id} onClick={() => setSelectedFriendId(f.id)} style={{ textAlign:'left', background:'transparent', color:'inherit', border:'1px solid rgba(255,255,255,.15)', borderRadius:12, padding:10, cursor:'pointer' }}>
                              <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center' }}>
                                <div style={{ fontWeight:800 }}>{f.name}</div>
                                <div style={{ ...styles.sub, fontWeight:800 }}>Lv {f.level}/{f.max}</div>
                              </div>
                            </button>
                          ));
                        })()}
                      </div>
                    </>
                  )}
                  {selectedFriendId != null && (
                    (()=>{
                      const fid = selectedFriendId;
                      const f = (friends && friends[fid]) || {};
                      const meta = { name: (f && f.bio && f.bio.title) || fid, bio: f.bio || { title: fid, summary:'', bullets:[] } };
                      const bust = fid==='luminaO' ? '/art/friends/luminao_bust.png' : (fid==='griswald' ? '/art/friends/griswald_bust.png' : (fid==='mcmunch' ? '/art/friends/mcmunch_bust.png' : (fid==='aureliagleam' ? '/art/friends/aureliagleam_bust.png' : (fid==='rivet' ? '/art/friends/rivet_bust.png' : '/art/friends/luminao_bust.png'))));
                      const profile = fid==='luminaO' ? '/art/friends/luminao_profile.png'
                        : fid==='griswald' ? '/art/friends/griswald_profile.png'
                        : fid==='mcmunch' ? '/art/friends/mcmunch_profile.png'
                        : fid==='aureliagleam' ? '/art/friends/aureliagleam_profile.png'
                        : fid==='rivet' ? '/art/friends/rivet_profile.png'
                        : '/art/friends/luminao_profile.png';
                      return (
                        <div style={{}}>
                          <div style={{ display:'flex', justifyContent:'center', marginTop: 6 }}>
                            <img src={profile} alt={`${meta.bio.title} profile`} style={{ width: 96, height:'auto', objectFit:'contain', borderRadius: 10, filter:'drop-shadow(0 2px 6px rgba(0,0,0,.35))' }} onError={(e)=>{ e.currentTarget.style.display='none'; }} />
                          </div>
                          <div style={{ fontWeight:900, margin:'8px 0 6px', textAlign:'center' }}>{meta.bio.title}</div>
                          <div style={{ ...styles.sub, marginBottom:6 }}>{meta.bio.summary}</div>
                          {meta.bio.bullets && meta.bio.bullets.length>0 && (
                            <ul style={styles.ul}>
                              {meta.bio.bullets.map((b,i)=>(<li key={i} style={styles.li}>{b}</li>))}
                            </ul>
                          )}
                          <div style={{ marginTop: 8, display:'flex', gap:8, alignItems:'center' }}>
                            <img src={bust} alt={meta.name} style={{ width: 120, height:'auto', objectFit:'contain', filter:'drop-shadow(0 2px 6px rgba(0,0,0,.35))' }} onError={(e)=>{ e.currentTarget.style.display='none'; }} />
                            <div style={{ ...styles.sub }}>Level: <b>{(f && f.level) || 0}</b>/5</div>
                          </div>
                          {/* Back button removed; use left-rail Friends icon to return */}
                        </div>
                      );
                    })()
                  )}
                </div>
              )}
              {null}
                </div>
              </div>
            </div>
          </div>
        )}

        {myBubbleFriendsOpen && (
          <div
            style={{ ...styles.overlayClear, background: 'transparent', backdropFilter: 'none' }}
            onClick={() => setMyBubbleFriendsOpen(false)}
          >
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={{ ...styles.mirrorFrame, backgroundImage: "url('/art/modalframe_mybubble.png')" }}>
                <div style={{ ...styles.desktopScanlinesOverlay, top:'16%', right:'7%', bottom:'12%', left:'7%' }} />
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, top: '22%', right: '12%', bottom: '12%', left: '10%', justifyContent: 'flex-start', color: '#362e46' }}>
                  <div style={{ display:'flex', gap:12, marginTop: 8 }}>
                    <div style={{ flex:'0 0 56px', display:'flex', flexDirection:'column', alignItems:'center', gap:10 }}>
                      <button title="Back to MyBubble" onClick={() => setMyBubbleFriendsOpen(false)} style={{ background:'none', border:'none', padding:0, cursor:'pointer' }}>
                        <img
                          src={'/art/mybubble/profilepic.png'}
                          alt={''}
                          style={{ display:'block', width:56, height:'auto', borderRadius:12, border:'1px solid rgba(54,46,70,.25)' }}
                          onError={(e)=>{ e.currentTarget.style.display='none'; }}
                        />
                      </button>
                      <button title="Messages" onClick={() => { setMyBubbleFriendsOpen(false); setMyBubbleMessagesOpen(true); }} style={{ position:'relative', background:'none', border:'none', padding:0, cursor:'pointer' }}>
                        <img
                          src={'/art/mybubble/messagebutton.png'}
                          alt={''}
                          style={{ display:'block', width:56, height:'auto', borderRadius:12, border:'1px solid rgba(54,46,70,.25)' }}
                          onError={(e)=>{ e.currentTarget.style.display='none'; }}
                        />
                        {(pendingFriendEvents.some(ev=>ev && ev.week===week) && !myBubbleMessagesOpen) && (
                          <div style={{ position:'absolute', right:-2, top:-2, width:14, height:14, borderRadius:99, background:'#e65b7a', border:'1px solid rgba(0,0,0,.4)' }} />
                        )}
                      </button>
                      <button title="Friends" onClick={() => setSelectedFriendId(null)} style={{ background:'none', border:'none', padding:0, cursor:'pointer' }}>
                        <img
                          src={'/art/mybubble/friendsbutton.png'}
                          alt={'Friends'}
                          style={{ display:'block', width:56, height:'auto', borderRadius:12, border:'1px solid rgba(54,46,70,.25)' }}
                          onError={(e)=>{ e.currentTarget.style.display='none'; }}
                        />
                      </button>
                    </div>
                    <div style={{ flex:1, display:'flex', flexDirection:'column', gap:8 }}>
                      <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between' }}>
                        <img
                          src={'/art/mybubble/mybubbletitle.png'}
                          alt={'MyBubble'}
                          style={{ display:'block', width:220, height:'auto' }}
                          onError={(e)=>{ e.currentTarget.style.display='none'; }}
                        />
                        {(() => {
                          const targetWeek = Math.max(1, week - 1);
                          const entry = (songHistory||[]).find(s=> s.releaseWeek === targetWeek);
                          const gain = (entry && Number.isFinite(entry.fansGain)) ? entry.fansGain : 0;
                          return (
                            <div style={{ display:'inline-flex', alignItems:'center', gap:8, padding:'6px 12px', borderRadius:999, border:'2px solid rgba(54,46,70,.25)', background:'rgba(255,255,255,.12)', fontWeight:800 }}>
                              <span style={{ opacity:.9 }}>Fans</span>
                              <span>{fans}</span>
                              <span style={{ marginLeft:6, color: gain > 0 ? '#64d49a' : 'rgba(255,255,255,.85)' }}>+{gain}</span>
                            </div>
                          );
                        })()}
                      </div>
                      {selectedFriendId == null && (
                        <div style={{ fontWeight:900, marginTop:4 }}>Friends</div>
                      )}
                      {(() => {
                        const list = Object.keys(friends||{}).reduce((arr, fid) => {
                          const f = friends[fid];
                          const lv = (f && f.level) || 0;
                          const bio = (f && f.bio) || null;
                          if (lv>0 && bio) arr.push({ id: fid, level: lv, bio });
                          return arr;
                        }, []);
                        if (list.length===0) return (<div style={styles.sub}>No friends yet.</div>);
                        return (
                          <div className="hide-scrollbar" style={{ display:'grid', gap:8, maxHeight: 320, overflowY:'auto', paddingRight:4 }}>
                            {selectedFriendId == null ? (
                              list.map((f) => (
                                <div key={f.id} onClick={() => setSelectedFriendId(f.id)} style={{ border:'2px solid rgba(54,46,70,.25)', borderRadius:12, padding:10, cursor:'pointer' }}>
                                  <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center' }}>
                                    <div style={{ fontWeight:900 }}>{f.bio.title || f.id}</div>
                                    <div style={{ ...styles.sub, fontWeight:800 }}>Lv {f.level}/5</div>
                                  </div>
                                </div>
                              ))
                            ) : (
                              (() => {
                                const fid = selectedFriendId;
                                const fsel = (friends && friends[fid]) || {};
                                const bio = fsel.bio || { title: fid, summary:'', bullets:[] };
                                const profile = fid==='luminaO' ? '/art/friends/luminao_profile.png'
                                  : fid==='griswald' ? '/art/friends/griswald_profile.png'
                                  : fid==='mcmunch' ? '/art/friends/mcmunch_profile.png'
                                  : fid==='aureliagleam' ? '/art/friends/aureliagleam_profile.png'
                                  : '';
                                return (
                                  <div style={{ border:'2px solid rgba(54,46,70,.25)', borderRadius:12, padding:12 }}>
                                    <div style={{ display:'flex', justifyContent:'center', marginBottom:8 }}>
                                      <img src={profile} alt={`${bio.title} profile`} style={{ width: 96, height:'auto', objectFit:'contain', borderRadius:10, filter:'drop-shadow(0 2px 6px rgba(0,0,0,.35))' }} onError={(e)=>{ e.currentTarget.style.display='none'; }} />
                                    </div>
                                    <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center' }}>
                                      <div style={{ fontWeight:900 }}>{bio.title || fid}</div>
                                      <div style={{ ...styles.sub, fontWeight:800 }}>Lv {(fsel.level||0)}/5</div>
                                    </div>
                                    {bio.summary && (
                                      <div style={{ ...styles.sub, opacity:.95, marginTop:6 }}>{bio.summary}</div>
                                    )}
                                    {Array.isArray(bio.bullets) && bio.bullets.length>0 && (
                                      <ul style={{ margin:'8px 0 0 18px', padding:0 }}>
                                        {bio.bullets.map((b, i) => (
                                          <li key={i} style={{ fontSize: 13, lineHeight: 1.4, opacity: 0.95 }}>{b}</li>
                                        ))}
                                      </ul>
                                    )}
                                    {/* Back button removed; use left-rail Friends icon to return */}
                                  </div>
                                );
                              })()
                            )}
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
        {myBubbleMessagesOpen && (
          <div
            style={{ ...styles.overlayClear, background: 'transparent', backdropFilter: 'none' }}
            onClick={() => setMyBubbleMessagesOpen(false)}
          >
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={{ ...styles.mirrorFrame, backgroundImage: "url('/art/modalframe_mybubble.png')" }}>
                <div style={{ ...styles.desktopScanlinesOverlay, top:'16%', right:'7%', bottom:'12%', left:'7%' }} />
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, top: '22%', right: '12%', bottom: '12%', left: '10%', justifyContent: 'flex-start', color: '#362e46' }}>
                  <div style={{ display:'flex', gap:12, marginTop: 8 }}>
                    <div style={{ flex:'0 0 56px', display:'flex', flexDirection:'column', alignItems:'center', gap:10 }}>
                      <button title="Back to MyBubble" onClick={() => setMyBubbleMessagesOpen(false)} style={{ background:'none', border:'none', padding:0, cursor:'pointer' }}>
                        <img
                          src={'/art/mybubble/profilepic.png'}
                          alt={''}
                          style={{ display:'block', width:56, height:'auto', borderRadius:12, border:'1px solid rgba(54,46,70,.25)' }}
                          onError={(e)=>{ e.currentTarget.style.display='none'; }}
                        />
                      </button>
                      <img
                        src={'/art/mybubble/messagebutton.png'}
                        alt={''}
                        style={{ display:'block', width:56, height:'auto', borderRadius:12, border:'1px solid rgba(54,46,70,.25)', opacity:.55 }}
                        onError={(e)=>{ e.currentTarget.style.display='none'; }}
                      />
                      <button title="Friends" onClick={() => { setMyBubbleMessagesOpen(false); setMyBubbleFriendsOpen(true); }} style={{ background:'none', border:'none', padding:0, cursor:'pointer' }}>
                        <img
                          src={'/art/mybubble/friendsbutton.png'}
                          alt={''}
                          style={{ display:'block', width:56, height:'auto', borderRadius:12, border:'1px solid rgba(54,46,70,.25)' }}
                          onError={(e)=>{ e.currentTarget.style.display='none'; }}
                        />
                      </button>
                    </div>
                    <div style={{ flex:1, display:'flex', flexDirection:'column', gap:8 }}>
                      <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between' }}>
                        <img
                          src={'/art/mybubble/mybubbletitle.png'}
                          alt={'MyBubble'}
                          style={{ display:'block', width:220, height:'auto' }}
                          onError={(e)=>{ e.currentTarget.style.display='none'; }}
                        />
                        {(() => {
                          const targetWeek = Math.max(1, week - 1);
                          const entry = (songHistory||[]).find(s=> s.releaseWeek === targetWeek);
                          const gain = (entry && Number.isFinite(entry.fansGain)) ? entry.fansGain : 0;
                          return (
                            <div style={{ display:'inline-flex', alignItems:'center', gap:8, padding:'6px 12px', borderRadius:999, border:'2px solid rgba(54,46,70,.25)', background:'rgba(255,255,255,.12)', fontWeight:800 }}>
                              <span style={{ opacity:.9 }}>Fans</span>
                              <span>{fans}</span>
                              <span style={{ marginLeft:6, color: gain > 0 ? '#64d49a' : 'rgba(255,255,255,.85)' }}>+{gain}</span>
                            </div>
                          );
                        })()}
                      </div>
                      {/* Shared tracks section */}
                      {false && (
                      <div style={{ marginTop: 6 }}>
                        <div style={{ fontWeight:800, marginBottom:4 }}>Shared Tracks</div>
                        {(() => {
                          const list = (sharedSongs||[]).filter(s => (s.shareWeek||0) <= week);
                          if (!list.length) return (<div style={styles.sub}>No shared tracks yet.</div>);
                          return (
                            <div style={{ display:'grid', gap:8 }}>
                              {list.map(s => (
                                <div key={s.id} style={{ border:'1px solid rgba(54,46,70,.25)', borderRadius:10, padding:8, display:'flex', alignItems:'center', gap:10 }}>
                                  <div style={{ fontWeight:800 }}>{s.artist} - {s.title}</div>
                                  <div style={{ marginLeft:'auto', display:'flex', gap:6 }}>
                                    {(() => { const isPlaying = !!(playingTrend && playingTrend.id === `${s.artist}__${s.title}`); return (
                                      <button style={styles.smallBtn} onClick={() => {
                                        try {
                                          const item = { artist: s.artist, title: s.title, audioSources: [s.audioSrc] };
                                          playTrendItem(item);
                                          setSharedSongs(arr => arr.map(x => x.id===s.id ? { ...x, listened:true } : x));
                                        } catch(_){}
                                      }}>{isPlaying ? 'Stop' : 'Play'}</button>
                                    ); })()}
                                    <button style={s.liked? { ...styles.smallBtn, background:'#64d49a', borderColor:'#64d49a', color:'#0f1524' } : styles.smallBtn} onClick={() => {
                                      if (s.liked) return;
                                      setSharedSongs(arr => arr.map(x => x.id===s.id ? { ...x, liked:true } : x));
                                      pushToast(`You liked ${s.artist}'s track — it may chart higher next week.`);
                                    }}>Like</button>
                                  </div>
                                </div>
                              ))}
                            </div>
                          );
                        })()}
                      </div>
                      )}
                      <div style={{ fontWeight:900, marginBottom:6, marginTop:4 }}>Messages</div>
                      {(pendingFriendEvents && pendingFriendEvents.some(ev=>ev && ev.week===week) && lastFriendProgressWeek !== week) ? (
                        (()=>{ const ev = (pendingFriendEvents.find(e=>e && e.week===week))||pendingFriendEvents[0]; const fid = ev.friendId || 'luminaO'; const meta = (friends && friends[fid] && friends[fid].bio) ? friends[fid].bio : { title: fid }; const name = meta.title || fid; const title = ev.targetLevel===1? 'Friend request' : 'New message'; return (
                          <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', gap:8, border:'2px solid rgba(54,46,70,.25)', borderRadius:12, padding:10 }}>
                            <div>
                              <div style={{ fontWeight:800 }}>{title}</div>
                              <div style={{ ...styles.sub }}>from {name}</div>
                            </div>
                            <div style={{ display:'flex', gap:6 }}>
                                <button style={styles.smallBtn} onClick={()=>{
                                  setFriendModal({ open:true, friendId: ev.friendId, targetLevel: ev.targetLevel, idx:0, snapshot: ev.snapshot||null, isWizmas: !!ev.wizmas });
                                  setPendingFriendEvents(prev=>{
                                    const idx = (prev||[]).findIndex(e => e && e.friendId===ev.friendId && e.targetLevel===ev.targetLevel && e.week===ev.week);
                                    if (idx < 0) return prev;
                                    const next = prev.slice();
                                    next.splice(idx, 1);
                                    return next;
                                  });
                                  setLastFriendProgressWeek(week);
                                  setMyBubbleMessagesOpen(false);
                                  setSocialOpen(false);
                                }}>Open</button>
                              <button style={styles.smallBtn} onClick={()=>{ /* Later: keep in queue */ }}>Later</button>
                            </div>
                          </div>
                        ); })()
                      ) : (
                        <div style={{ display:'inline-block', padding:'8px 12px', borderRadius:999, border:'2px solid rgba(54,46,70,.25)', background:'rgba(255,255,255,.10)', fontWeight:800 }}>No new messages.</div>
                      )}
                      {/* Shared tracks section (now below Messages) */}
                      <div style={{ marginTop: 6 }}>
                        <div style={{ fontWeight:800, marginBottom:4 }}>Shared Tracks</div>
                        {(() => {
                          const list = (sharedSongs||[]).filter(s => (s.shareWeek||0) <= week);
                          if (!list.length) return (<div style={styles.sub}>No shared tracks yet.</div>);
                          return (
                            <div style={{ display:'grid', gap:8 }}>
                              {list.map(s => (
                                <div key={s.id} style={{ border:'1px solid rgba(54,46,70,.25)', borderRadius:10, padding:8, display:'flex', alignItems:'center', gap:10 }}>
                                  <div style={{ fontWeight:800 }}>{s.artist} - {s.title}</div>
                                  <div style={{ marginLeft:'auto', display:'flex', gap:6 }}>
                                    {(() => { const isPlaying = !!(playingTrend && playingTrend.id === `${s.artist}__${s.title}`); return (
                                      <button style={styles.smallBtn} onClick={() => {
                                        try {
                                          const item = { artist: s.artist, title: s.title, audioSources: [s.audioSrc] };
                                          playTrendItem(item);
                                          setSharedSongs(arr => arr.map(x => x.id===s.id ? { ...x, listened:true } : x));
                                        } catch(_){}
                                      }}>{isPlaying ? 'Stop' : 'Play'}</button>
                                    ); })()}
                                    <button style={s.liked? { ...styles.smallBtn, background:'#64d49a', borderColor:'#64d49a', color:'#0f1524' } : styles.smallBtn} onClick={() => {
                                      if (s.liked) return;
                                      setSharedSongs(arr => arr.map(x => x.id===s.id ? { ...x, liked:true } : x));
                                      pushToast(`You liked ${s.artist}'s track - it may chart higher next week.`);
                                    }}>Like</button>
                                  </div>
                                </div>
                              ))}
                            </div>
                          );
                        })()}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
              {eventModal && eventModal.event && (
                <div style={styles.overlayClear} onClick={() => setEventModal(null)}>
                  <div style={styles.modal} onClick={(e) => e.stopPropagation()}>
                    <div style={styles.title}>{eventModal.event.title}</div>
                    <div style={{ ...styles.sub, marginTop: 6 }}>{eventModal.event.details}</div>
                    {eventModal.event.choices && (
                      <div style={{ display:'flex', flexDirection:'column', gap:8, marginTop: 10 }}>
                        {eventModal.event.choices.map((ch, idx) => {
                          const cost = ch.effect && typeof ch.effect.cost === 'number' ? ch.effect.cost : 0;
                          const needsMoney = cost < 0;
                          const disabled = needsMoney && money < Math.abs(cost);
                          return (
                            <button key={idx} disabled={disabled} style={disabled ? styles.primaryBtnDisabled : styles.secondaryBtn} onClick={() => {
                              if (disabled) return;
                              // Apply immediate effects (grantMoney/cost applied now; multipliers/flags merged via activeEffects)
                              if (ch.effect && typeof ch.effect.grantMoney === 'number') setMoney(m=>m+ch.effect.grantMoney);
                              if (needsMoney) setMoney(m => m + cost);
                              // If entering Iron Overture, trigger new friend introduction at Level 1
                              if ((eventModal.event && eventModal.event.key === 'iron') && ch.effect && ch.effect.ironLockMetal) {
                                try {
                                  // Defer introduction to after Iron performance (scheduled next week there)
                                  setIronAccepted(true);
                                } catch (_) {}
                              }
                              setEventsResolved(r => ({ ...r, [eventModal.event.id]: { status:'choice', choiceIndex: idx } }));
                              setEventModal(null);
                            }}>
                              <span style={{ display:'inline-flex', alignItems:'center', gap:6 }}>
                                <span>{ch.label}</span>
                                {(ch.effect && typeof ch.effect.grantMoney === 'number') && (
                                  <span style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                                    +{ch.effect.grantMoney}
                                    <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:12, height:12, objectFit:'contain' }} />
                                    <span>now</span>
                                  </span>
                                )}
                              </span>
                            </button>
                          );
                        })}
                      </div>
                    )}
              {!eventModal.event.choices && (
                <button onClick={() => setEventModal(null)} style={{ ...styles.primaryBtn, marginTop: 14 }}>Okay</button>
              )}
            </div>
          </div>
        )}

        {eventInfoModal && (
          <div style={styles.overlayClear} onClick={() => setEventInfoModal(null)}>
            <div style={styles.modal} onClick={(e) => e.stopPropagation()}>
              <div style={styles.title}>This Week: {Math.min(week, MAX_WEEKS)} / {MAX_WEEKS}</div>
              <div style={{ marginTop: 6, display:'grid', gap:6 }}>
                {(!eventInfoModal.events || eventInfoModal.events.length === 0) ? (
                  <div style={styles.sub}>Nothing scheduled.</div>
                ) : (
                  eventInfoModal.events.map(ev => (
                    <div key={ev.id}>
                      <div style={{ fontWeight: 700 }}>{ev.title}</div>
                      <div style={{ ...styles.sub }}>{ev.short}</div>
                      {ev.effect && (
                        <div style={{ ...styles.sub, opacity: .9 }}>{effectSummary(ev.effect)}</div>
                      )}
                    </div>
                  ))
                )}
              </div>
              
              <div style={{ marginTop: 10 }}>
                <div style={{ fontWeight: 800, marginBottom: 4 }}>Upcoming</div>
                {eventInfoModal.upcoming ? (
                  <div>
                    <div style={{ fontWeight: 700 }}>{eventInfoModal.upcoming.title}</div>
                    <div style={{ ...styles.sub }}>{eventInfoModal.upcoming.short}</div>
                  </div>
                ) : (
                  <div style={styles.sub}>No upcoming events.</div>
                )}
              </div>
              {(() => {
                try {
                  const sharedNew = (sharedSongs||[]).some(s => (s.shareWeek||0) === week);
                  if (!sharedNew) return null;
                  return (
                    <div style={{ marginTop: 12, paddingTop: 8, borderTop: '1px solid rgba(255,255,255,.15)' }}>
                      <div style={{ fontWeight: 800, marginBottom: 4 }}>Social</div>
                      <div style={styles.sub}>New message in MyBubble.</div>
                    </div>
                  );
                } catch(_) { return null; }
              })()}
              {(() => {
                const list = trendsByWeek && trendsByWeek[week];
                if (!list || list.length === 0) return null;
                const playerItem = list.find(it => it && it.isPlayer);
                if (!playerItem) return null;
                const msg = playerItem.rank === 1
                  ? 'Your song is number 1 in the charts!'
                  : `Your song made the Top 5 at #${playerItem.rank}.`;
                return (
                  <div style={{ marginTop: 12, paddingTop: 8, borderTop: '1px solid rgba(255,255,255,.15)' }}>
                    <div style={{ fontWeight: 800, marginBottom: 4 }}>Charts</div>
                    <div style={styles.sub}>{msg}</div>
                  </div>
                );
              })()}
              {pendingFriendEvents.some(ev=>ev && ev.week===week) && lastFriendProgressWeek !== week && (
                <div style={{ marginTop: 12, paddingTop: 8, borderTop: '1px solid rgba(255,255,255,.15)' }}>
                  <div style={{ fontWeight: 800, marginBottom: 4 }}>Social</div>
                  {(() => { const ev = pendingFriendEvents[0]; const isFirst = ev && ev.targetLevel === 1; const fid = ev && (ev.friendId || 'luminaO'); const meta = (friends && friends[fid] && friends[fid].bio) ? friends[fid].bio : { title: fid }; const name = meta.title || fid; return (
                    <div style={styles.sub}>{isFirst ? 'New friend request in MyBubble.' : 'New message in MyBubble.'}</div>
                  ); })()}
                </div>
              )}
              <button onClick={() => {
                setEventsResolved(r => {
                  const copy = { ...r };
                  (eventInfoModal.events||[]).forEach(ev => {
                    const prev = copy[ev.id] || {};
                    copy[ev.id] = { ...prev, notified: true };
                  });
                  return copy;
                });
                setEventInfoModal(null);
                // If Iron Overture choice was deferred, show it now
                try {
                  if (deferredChoice && deferredChoice.key === 'iron' && !(eventsResolved[deferredChoice.id] && typeof eventsResolved[deferredChoice.id].choiceIndex === 'number')) {
                    setEventModal({ event: deferredChoice });
                  }
                } finally {
                  setDeferredChoice(null);
                }
              }} style={{ ...styles.primaryBtn, marginTop: 12 }}>OK</button>
            </div>
          </div>
        )}

        {nudgeOpen && (
          <div style={styles.overlayClear} onClick={() => setNudgeOpen(false)}>
            <div style={styles.modal} onClick={(e) => e.stopPropagation()}>
              <div style={styles.title}>Use Nudge</div>
              <div style={{ ...styles.sub, marginTop: 6 }}>Nudges available: <b>{nudges}</b></div>
              <div style={{ display:'grid', gap:8, marginTop: 10 }}>
                <button
                  disabled={!rollBest?.sing || (rollBest?.sing?.value||1) <= 1 || nudges<=0 || !!rollBest?.sing?.nudged}
                  onClick={() => {
                    if (nudges>0 && rollBest?.sing && rollBest.sing.value>1 && !rollBest.sing.nudged){
                      setRollBest(r=>({ ...r, sing: { ...r.sing, value: Math.max(1, (r.sing?.value||1)-1), nudged:true } }));
                      setNudges(n=>n-1);
                      pushToast('Nudge used on Sing: -1');
                    }
                  }}
                  style={(!rollBest?.sing || (rollBest?.sing?.value||1) <= 1 || nudges<=0 || !!rollBest?.sing?.nudged) ? styles.primaryBtnDisabled : styles.primaryBtn}
                >Sing +1</button>
                <button
                  disabled={!rollBest?.write || (rollBest?.write?.value||1) <= 1 || nudges<=0 || !!rollBest?.write?.nudged}
                  onClick={() => {
                    if (nudges>0 && rollBest?.write && rollBest.write.value>1 && !rollBest.write.nudged){
                      setRollBest(r=>({ ...r, write: { ...r.write, value: Math.max(1, (r.write?.value||1)-1), nudged:true } }));
                      setNudges(n=>n-1);
                      pushToast('Nudge used on Write: -1');
                    }
                  }}
                  style={(!rollBest?.write || (rollBest?.write?.value||1) <= 1 || nudges<=0 || !!rollBest?.write?.nudged) ? styles.primaryBtnDisabled : styles.primaryBtn}
                >Write +1</button>
                <button
                  disabled={!rollBest?.perform || (rollBest?.perform?.value||1) <= 1 || nudges<=0 || !!rollBest?.perform?.nudged}
                  onClick={() => {
                    if (nudges>0 && rollBest?.perform && rollBest.perform.value>1 && !rollBest.perform.nudged){
                      setRollBest(r=>({ ...r, perform: { ...r.perform, value: Math.max(1, (r.perform?.value||1)-1), nudged:true } }));
                      setNudges(n=>n-1);
                      pushToast('Nudge used on Perform: -1');
                    }
                  }}
                  style={(!rollBest?.perform || (rollBest?.perform?.value||1) <= 1 || nudges<=0 || !!rollBest?.perform?.nudged) ? styles.primaryBtnDisabled : styles.primaryBtn}
                >Dance +1</button>
              </div>
              <button onClick={() => setNudgeOpen(false)} style={{ ...styles.primaryBtn, marginTop: 14 }}>Close</button>
            </div>
          </div>
        )}

        {shopOpen && (
          <div style={styles.overlayClear} onClick={() => setShopOpen(false)}>
            <div style={{ ...styles.mirrorModal, transform: shopAnim? 'scale(1) translateY(0)' : 'scale(.985) translateY(-6px)', opacity: shopAnim? 1 : 0, transition: 'transform 220ms ease, opacity 220ms ease' }} onClick={(e) => e.stopPropagation()}>
              <div style={{ ...styles.mirrorFrame, backgroundImage: "url('/art/modalframe_amozon.png')" }}>
                <div style={{ ...styles.desktopScanlinesOverlay, top:'16%', right:'6%', bottom:'12%', left:'6%' }} />
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, color: '#8a6f1a', paddingTop: 12 }}>
                  <div style={{ display:'flex', flexDirection:'column', gap:8 }}>
                    <div style={{ flex:'0 0 auto', position:'relative', width:'100%', display:'flex', alignItems:'center', justifyContent:'center', margin:'0 auto', marginTop: 450 }}>
                      <img src="/art/shoplogo.png" alt="Shop" style={{ height: 96, width: 'auto', objectFit:'contain', filter:'drop-shadow(0 2px 6px rgba(0,0,0,.25))' }} />
                      <div style={styles.shopMoneyOnLogo}>
                        <span style={{ fontWeight: 900, letterSpacing: .2 }}>{money}</span>
                        <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:16, height:16, objectFit:'contain' }} />
                      </div>
                    </div>
                    {/* Mock search bar between logo and items */}
                    <div style={{ display:'flex', justifyContent:'center', marginTop: 8, marginBottom: 10 }}>
                      <div style={styles.shopSearchBar}>
                        <span style={{ opacity: 0.6 }}>Search</span>
                        <span style={{ opacity: 0.85 }}>🔍</span>
                      </div>
                    </div>
                    
                    <div style={{ flex:0.95 }}>
                    <div style={styles.shopGrid}>
                      {(() => { const disc = activeEffects?.shopDiscount || 1; const price20 = Math.max(1, Math.ceil(15 * disc)); const price12 = Math.max(1, Math.ceil(40 * disc)); const price6 = Math.max(1, Math.ceil(100 * disc)); return (<>
                      <div style={styles.shopCard}>
                        <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:8, justifyContent:'space-between', flex:1 }}>
                          <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:6, fontWeight:700 }}>Extra d20 roll</div>
                          <div style={styles.shopImageBox}>
                            <img src="/art/d20badge.png" alt="d20" style={{ width:36, height:36, objectFit:'contain' }} />
                          </div>
                          <button
                            disabled={money < price20}
                            onClick={() => { if (money>=price20){ setMoney(m=>m-price20); setBonusRolls(r=>r+1); setNextRollOverride(20); pushToast('Purchased: Extra d20 roll (+1) - next roll uses d20'); } }}
                            style={money<price20? { ...styles.primaryBtnDisabled, ...styles.shopBuyBtnDisabled, alignSelf:'center' } : { ...styles.smallBtn, ...styles.shopBuyBtn, alignSelf:'center' }}
                          >
                            <span style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                              {price20}
                              <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:14, height:14, objectFit:'contain' }} />
                            </span>
                          </button>
                        </div>
                      </div>
                      <div style={styles.shopCard}>
                        <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:8, justifyContent:'space-between', flex:1 }}>
                          <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:6, fontWeight:700 }}>Extra d12 roll</div>
                          <div style={styles.shopImageBox}>
                            <img src="/art/d12badge.png" alt="d12" style={{ width:36, height:36, objectFit:'contain' }} />
                          </div>
                          <button
                            disabled={money < price12}
                            onClick={() => { if (money>=price12){ setMoney(m=>m-price12); setBonusRolls(r=>r+1); setNextRollOverride(12); pushToast('Purchased: Extra d12 roll (+1) - next roll uses d12'); } }}
                            style={money<price12? { ...styles.primaryBtnDisabled, ...styles.shopBuyBtnDisabled, alignSelf:'center' } : { ...styles.smallBtn, ...styles.shopBuyBtn, alignSelf:'center' }}
                          >
                            <span style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                              {price12}
                              <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:14, height:14, objectFit:'contain' }} />
                            </span>
                          </button>
                        </div>
                      </div>
                      <div style={styles.shopCard}>
                        <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:8, justifyContent:'space-between', flex:1 }}>
                          <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:6, fontWeight:700 }}>Extra d6 roll</div>
                          <div style={styles.shopImageBox}>
                            <img src="/art/d6badge.png" alt="d6" style={{ width:36, height:36, objectFit:'contain' }} />
                          </div>
                          <button
                            disabled={money < price6}
                            onClick={() => { if (money>=price6){ setMoney(m=>m-price6); setBonusRolls(r=>r+1); setNextRollOverride(6); pushToast('Purchased: Extra d6 roll (+1) - next roll uses d6'); } }}
                            style={money<price6? { ...styles.primaryBtnDisabled, ...styles.shopBuyBtnDisabled, alignSelf:'center' } : { ...styles.smallBtn, ...styles.shopBuyBtn, alignSelf:'center' }}
                          >
                            <span style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                              {price6}
                              <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:14, height:14, objectFit:'contain' }} />
                            </span>
                          </button>
                        </div>
                      </div>
                      </>); })()}
                      </div>
                      <div style={{ ...styles.shopGrid, marginTop: 10 }}>
                      {/* Mystery Poster */}
                      <div style={styles.shopCard}>
                        <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:8, justifyContent:'space-between', flex:1 }}>
                          <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:6, fontWeight:700 }}>Mystery Poster</div>
                          <div style={styles.shopImageBox}>
                            <img src="/art/posters/poster1.png" alt="poster" style={{ width:36, height:36, objectFit:'cover', borderRadius:6 }} />
                          </div>
                          {(() => { const disc = activeEffects?.shopDiscount || 1; const priceP = Math.max(1, Math.ceil(30 * disc)); const disabled = money < priceP; return (
                            <button
                              disabled={disabled}
                              onClick={() => {
                                if (!disabled) {
                                  setMoney(m=>m-priceP);
                                  // Compute pick based on current unlocked list to avoid duplicate side effects
                                  const prevList = Array.isArray(unlockedPosters) ? unlockedPosters : [];
                                  const lumIdx = POSTERS.findIndex(p => (p||'').includes('luminaposter.png'));
                                  const all = POSTERS.map((_,i)=>i).filter(i => i !== lumIdx);
                                  const remaining = all.filter(i => !prevList.includes(i));
                                  const pool = remaining.length>0 ? remaining : all;
                                  const pick = pool[Math.floor(Math.random()*pool.length)];
                                  setCurrentPosterIdx(pick);
                                  setUnlockedPosters(prev => (prev && prev.includes(pick)) ? prev : [ ...(prev||[]), pick ]);
                                  pushToast(remaining.length>0 ? 'Unlocked a new poster!' : 'Swapped to another poster!');
                                }
                              }}
                              style={disabled? { ...styles.primaryBtnDisabled, ...styles.shopBuyBtnDisabled, alignSelf:'center' } : { ...styles.smallBtn, ...styles.shopBuyBtn, alignSelf:'center' }}
                            >
                              <span style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                                {priceP}
                                <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:14, height:14, objectFit:'contain' }} />
                              </span>
                            </button>
                          ); })()}
                        </div>
                      </div>
                      <div style={styles.shopCard}>
                      <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:8, justifyContent:'space-between', flex:1 }}>
                          <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:6, fontWeight:700 }}>Nudge</div>
                          <div style={styles.shopImageBox}>
                            <img src="/art/nudgebadge.png" alt="nudge" style={{ width:36, height:36, objectFit:'contain' }} />
                          </div>
                          {(() => { const disc = activeEffects?.shopDiscount || 1; const priceN = Math.max(1, Math.ceil(30 * disc)); return (
                            <button
                              disabled={money < priceN}
                              onClick={() => { if (money>=priceN){ setMoney(m=>m-priceN); setNudges(n=>n+1); pushToast('Purchased: Nudge (+1)'); } }}
                              style={money<priceN? { ...styles.primaryBtnDisabled, ...styles.shopBuyBtnDisabled, alignSelf:'center' } : { ...styles.smallBtn, ...styles.shopBuyBtn, alignSelf:'center' }}
                            >
                              <span style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                                {priceN}
                                <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:14, height:14, objectFit:'contain' }} />
                              </span>
                            </button>
                          ); })()}
                        </div>
                      </div>
                      {/* Permanent boost items styled like other shop items */}
                      <div style={styles.shopCard}>
                        <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:8, justifyContent:'space-between', flex:1 }}>
                          <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:6, fontWeight:700 }}>
                            Soothing Honey Drink
                            {(() => {
                              const dp = dieProgress(vocals);
                              if (!dp || !dp.next) return null;
                              const floor = dp.floor||0, goal = dp.goal||6;
                              const currPct = Math.max(0, Math.min(1, (vocals - floor) / Math.max(0.0001, goal - floor)));
                              const newStat = Math.min(10, vocals + 1.0);
                              const newPct = Math.max(0, Math.min(1, (newStat - floor) / Math.max(0.0001, goal - floor)));
                              const delta = Math.max(0, newPct - currPct);
                              return <span style={{ ...styles.sub, marginLeft:6 }}>+1 lvl toward next die</span>;
                            })()}
                          </div>
                          <div style={styles.shopImageBox}>
                            <img src="/art/honey.png" alt="honey" style={{ width:56, height:56, objectFit:'contain' }} onError={(e)=>{e.currentTarget.style.display='none';}} />
                          </div>
                          {(() => {
                            const disc = activeEffects?.shopDiscount || 1; const price = Math.max(1, Math.ceil(120 * disc)); const disabled = money < price || vocals >= 10;
                            return (
                              <button
                                disabled={disabled}
                                onClick={() => { if (!disabled){ setMoney(m=>m-price); setVocals(v=>clamp(v+1.0,0,10)); setWeekVocGain(g=>+(g+1.0).toFixed(3)); pushToast('Purchased: Soothing Honey Drink (+1.00 Vocals)'); } }}
                                style={disabled? { ...styles.primaryBtnDisabled, ...styles.shopBuyBtnDisabled, alignSelf:'center' } : { ...styles.smallBtn, ...styles.shopBuyBtn, alignSelf:'center' }}
                              >
                                <span style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                                  {price}
                                  <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:14, height:14, objectFit:'contain' }} />
                                </span>
                              </button>
                            );
                          })()}
                        </div>
                      </div>
                      <div style={styles.shopCard}>
                        <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:8, justifyContent:'space-between', flex:1 }}>
                          <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:6, fontWeight:700 }}>
                            Lyric Notebook
                            {(() => {
                              const dp = dieProgress(writing);
                              if (!dp || !dp.next) return null;
                              const floor = dp.floor||0, goal = dp.goal||6;
                              const currPct = Math.max(0, Math.min(1, (writing - floor) / Math.max(0.0001, goal - floor)));
                              const newStat = Math.min(10, writing + 1.0);
                              const newPct = Math.max(0, Math.min(1, (newStat - floor) / Math.max(0.0001, goal - floor)));
                              const delta = Math.max(0, newPct - currPct);
                              return <span style={{ ...styles.sub, marginLeft:6 }}>+1 lvl toward next die</span>;
                            })()}
                          </div>
                          <div style={styles.shopImageBox}>
                            <img src="/art/notebook.png" alt="notebook" style={{ width:56, height:56, objectFit:'contain' }} onError={(e)=>{e.currentTarget.style.display='none';}} />
                          </div>
                          {(() => {
                            const disc = activeEffects?.shopDiscount || 1; const price = Math.max(1, Math.ceil(120 * disc)); const disabled = money < price || writing >= 10;
                            return (
                              <button
                                disabled={disabled}
                                onClick={() => { if (!disabled){ setMoney(m=>m-price); setWriting(v=>clamp(v+1.0,0,10)); setWeekWriGain(g=>+(g+1.0).toFixed(3)); pushToast('Purchased: Lyric Notebook (+1.00 Writing)'); } }}
                                style={disabled? { ...styles.primaryBtnDisabled, ...styles.shopBuyBtnDisabled, alignSelf:'center' } : { ...styles.smallBtn, ...styles.shopBuyBtn, alignSelf:'center' }}
                              >
                                <span style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                                  {price}
                                  <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:14, height:14, objectFit:'contain' }} />
                                </span>
                              </button>
                            );
                          })()}
                        </div>
                      </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {myMusicOpen && (
          <div style={styles.overlayClear} onClick={() => setMyMusicOpen(false)}>
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={{ ...styles.mirrorFrame, backgroundImage: "url('/art/modalframe_shizyfi.png')" }}>
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, top: '22%', bottom: 'calc(12% + 45px)', justifyContent: 'flex-start' }}>
              <img
                src={'/art/shizyfi/shizyfilogo.png'}
                alt={'Shizy-Fi'}
                style={{ display:'block', margin:'0 auto', width:154, height:'auto' }}
                onError={(e)=>{ e.currentTarget.style.display='none'; }}
              />
              <div style={{ display:'flex', flexDirection:'column', gap:10, marginTop: 10 }}>
                <div style={{ display:'flex', gap:8, flexWrap:'wrap', justifyContent:'flex-start' }}>
                  {(!endYearReady && !isOver) ? (
                    <>
                      <button
                        onClick={() => {
                          setMyMusicOpen(false);
                          if (!conceptLocked) setShowConcept(true); else setProgressOpen(true);
                        }}
                        style={{ background:'none', border:'none', padding:0, cursor:'pointer', flex:'0 0 auto' }}
                        title={conceptLocked ? 'Current Song' : 'Create Song'}
                      >
                        <img
                          src={'/art/shizyfi/createsongbutton.png'}
                          alt={conceptLocked ? 'Current Song' : 'Create Song'}
                          style={{ display:'block', width:200, height:'auto' }}
                          onError={(e)=>{ e.currentTarget.style.display='none'; }}
                        />
                      </button>
                      <button
                        onClick={() => { setMyMusicOpen(false); setHistoryOpen(true); }}
                        style={{ background:'none', border:'none', padding:0, cursor:'pointer', flex:'0 0 auto' }}
                        title={'My Song History'}
                      >
                        <img
                          src={'/art/shizyfi/mysonghistorybutton.png'}
                          alt={'My Song History'}
                          style={{ display:'block', width:200, height:'auto' }}
                          onError={(e)=>{ e.currentTarget.style.display='none'; }}
                        />
                      </button>
                    </>
                  ) : (
                    <>
                      <button
                        onClick={() => { setMyMusicOpen(false); setFinaleSummaryOpen(true); setEndYearReady(false); }}
                        style={styles.primaryBtn}
                      >
                        End year
                      </button>
                      <button onClick={() => { setMyMusicOpen(false); setHistoryOpen(true); }} style={styles.secondaryBtn}>My Song History</button>
                    </>
                  )}
                </div>
                {(!endYearReady && !isOver) && (
                  <div style={{ width:'96%', margin:'-6px auto 0' }}>
                    <div style={{ position:'relative' }}>
                      <img
                        src={'/art/shizyfi/banner.png'}
                        alt={''}
                        style={{ display:'block', width:'100%', height:'auto' }}
                        onError={(e)=>{ e.currentTarget.style.display='none'; }}
                      />
                      <div style={{ position:'absolute', left:'50%', top:'46%', transform:'translate(-50%, -50%)', fontWeight:900, fontSize:18, textAlign:'center', letterSpacing:.2, textTransform:'uppercase', whiteSpace:'nowrap' }}>
                        Academy Trends (Week {Math.min(week, MAX_WEEKS)})
                      </div>
                    </div>
                    {(() => {
                      const list = trendsByWeek && trendsByWeek[week];
                      if (!list) { ensureTrendsForWeek(week); return (<div style={styles.sub}>Loading trends...</div>);} 
                      return (
                        <div className="hide-scrollbar" style={{ overflowY:'auto', overflowX:'hidden', maxHeight: (list && list.length >= 5) ? 320 : 'none', paddingRight:4, marginTop:8 }}>
                          <div style={{ display:'grid', gap:8 }}>
                            {list.map(item => {
                              const isActive = (playingTrend && playingTrend.id === `${item.artist}__${item.title}`);
                              const pct = Math.max(0, Math.min(100, (audioTime.duration>0? (audioTime.current/audioTime.duration)*100 : 0)));
                              return (
                                <div
                                  key={`${item.rank}-${item.title}`}
                                  onClick={() => playTrendItem(item)}
                                  style={{ position:'relative', height:48, borderRadius:0, backgroundImage: "url('/art/shizyfi/chartscroll.png')", backgroundSize:'contain', backgroundPosition:'center', backgroundRepeat:'no-repeat', cursor:'pointer', overflow:'visible', filter: isActive ? 'brightness(1.05)' : 'none' }}
                                >
                                  <div style={{ position:'absolute', left:'12%', right:'8%', top:'50%', transform:'translateY(-50%)', textAlign:'left', fontWeight:900, fontSize:12, whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis', color: isActive ? '#0f1524' : '#151a2c', fontStyle: isActive ? 'italic' : 'normal' }}>
                                    <span style={{ marginRight: 8 }}>{`#${item.rank}`}</span>
                                    {item.artist} - {(item.title && item.title.length>38) ? (item.title.slice(0,38) + '...') : item.title}
                                  </div>
                                  {item.isPlayer && (
                                    <div style={{ position:'absolute', right:6, top:4, fontSize:10, fontWeight:800, color:'#151a2c' }}>You</div>
                                  )}
                                  {null}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                )}
                {(endYearReady || isOver) && (
                  <div style={{ width:'100%', margin:0, overflow:'hidden' }}>
                    <div style={{ fontWeight:900, marginBottom:6 }}>Academy Trends (Week {Math.min(week, MAX_WEEKS)})</div>
                    {(() => { const list = trendsByWeek && trendsByWeek[week]; if (!list) { ensureTrendsForWeek(week); return (<div style={styles.sub}>Loading trends...</div>);} return (
                      <div style={{ overflowY:'auto', overflowX:'hidden', maxHeight: (list && list.length >= 5) ? 320 : 'none', paddingRight:4 }}>
                        <div style={{ display:'grid', gap:8 }}>
                        {list.map(item => {
                          const isActive = (playingTrend && playingTrend.id === `${item.artist}__${item.title}`);
                          const pct = Math.max(0, Math.min(100, (audioTime.duration>0? (audioTime.current/audioTime.duration)*100 : 0)));
                          return (
                            <div
                              key={`${item.rank}-${item.title}`}
                              onClick={() => playTrendItem(item)}
                              style={{ position:'relative', height:48, borderRadius:0, backgroundImage: "url('/art/shizyfi/chartscroll.png')", backgroundSize:'contain', backgroundPosition:'center', backgroundRepeat:'no-repeat', cursor:'pointer', overflow:'visible', filter: isActive ? 'brightness(1.05)' : 'none' }}
                            >
                              <div style={{ position:'absolute', left:'12%', right:'8%', top:'50%', transform:'translateY(-50%)', textAlign:'left', fontWeight:900, fontSize:12, whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis', color: isActive ? '#0f1524' : '#151a2c', fontStyle: isActive ? 'italic' : 'normal' }}>
                                <span style={{ marginRight: 8 }}>{`#${item.rank}`}</span>
                                {item.artist} - {(item.title && item.title.length>38) ? (item.title.slice(0,38) + '...') : item.title}
                              </div>
                              {item.isPlayer && (
                                <div style={{ position:'absolute', right:6, top:4, fontSize:10, fontWeight:800, color:'#151a2c' }}>You</div>
                              )}
                              {null}
                            </div>
                          );
                        })}
                        </div>
                      </div>
                    ); })()}
                  </div>
                )}
              </div>
              {null}
                </div>
              </div>
              {/* Shizy-Fi media controls bar (overlays bottom area; content scrolls behind) */}
              <div style={{ position:'absolute', left:'30%', right:'30%', bottom:'calc(6% + 35px)', display:'flex', flexDirection:'column', gap:6, zIndex:2 }}>
                <div style={{ display:'flex', alignItems:'center', gap:12 }}>
                  <div style={{ display:'flex', alignItems:'center', gap:10, marginLeft:80 }}>
                    <button title="Play" onClick={playPreview} style={{ background:'none', border:'none', padding:0, cursor:'pointer' }}>
                      <div style={{ position:'relative', width:28, height:28, display:'flex', alignItems:'center', justifyContent:'center' }}>
                        <div style={{ position:'absolute', inset:0, borderRadius:'50%', background:'radial-gradient(circle at 50% 50%, rgba(148,129,250,.34) 0%, rgba(148,129,250,.12) 50%, rgba(148,129,250,0) 80%)', filter:'blur(1px)', pointerEvents:'none' }} />
                        <img src={'/art/shizyfi/play.png'} alt={"Play"} style={{ display:'block', width:18, height:'auto', position:'relative', zIndex:1 }} onError={(e)=>{ e.currentTarget.style.display='none'; }} />
                      </div>
                    </button>
                    <button title="Pause" onClick={pausePreview} style={{ background:'none', border:'none', padding:0, cursor:'pointer' }}>
                      <div style={{ position:'relative', width:28, height:28, display:'flex', alignItems:'center', justifyContent:'center' }}>
                        <div style={{ position:'absolute', inset:0, borderRadius:'50%', background:'radial-gradient(circle at 50% 50%, rgba(148,129,250,.34) 0%, rgba(148,129,250,.12) 50%, rgba(148,129,250,0) 80%)', filter:'blur(1px)', pointerEvents:'none' }} />
                        <img src={'/art/shizyfi/pause.png'} alt={"Pause"} style={{ display:'block', width:18, height:'auto', position:'relative', zIndex:1 }} onError={(e)=>{ e.currentTarget.style.display='none'; }} />
                      </div>
                    </button>
                    <button title="Skip" onClick={() => skipPreview(1)} style={{ background:'none', border:'none', padding:0, cursor:'pointer' }}>
                      <div style={{ position:'relative', width:28, height:28, display:'flex', alignItems:'center', justifyContent:'center' }}>
                        <div style={{ position:'absolute', inset:0, borderRadius:'50%', background:'radial-gradient(circle at 50% 50%, rgba(148,129,250,.34) 0%, rgba(148,129,250,.12) 50%, rgba(148,129,250,0) 80%)', filter:'blur(1px)', pointerEvents:'none' }} />
                        <img src={'/art/shizyfi/skip.png'} alt={"Skip"} style={{ display:'block', width:18, height:'auto', position:'relative', zIndex:1 }} onError={(e)=>{ e.currentTarget.style.display='none'; }} />
                      </div>
                    </button>
                  </div>
                  <div style={{ display:'flex', alignItems:'center', gap:8, flex:1, minWidth:0 }}>
                    <div onClick={seekPreview} style={{ flex:1, height:8, borderRadius:999, background:'rgba(255,255,255,.18)', overflow:'hidden', cursor:'pointer' }}>
                      <div style={{ width: `${Math.max(0, Math.min(100, (audioTime.duration>0? (audioTime.current/audioTime.duration)*100 : 0)))}%`, height:'100%', background:'white' }} />
                    </div>
                    <div style={{ fontSize:11, opacity:.9, minWidth:70, textAlign:'right' }}>{fmtTime(audioTime.current)} / {fmtTime(audioTime.duration)}</div>
                  </div>
                </div>
              </div>
              {/* Now Playing record UI (rotates while playing) */}
              {/* Circular glow behind the record */}
              <div
                style={{
                  position:'absolute',
                  left:'calc(14% + 125px - 16px)',
                  bottom:'calc(8% + 20px - 16px)',
                  width:104,
                  height:104,
                  borderRadius:'50%',
                  background:'radial-gradient(circle at 50% 50%, rgba(148,129,250,.42) 0%, rgba(148,129,250,.22) 40%, rgba(148,129,250,0) 75%)',
                  filter:'blur(2px)',
                  pointerEvents:'none',
                  zIndex:1,
                }}
              />
              <style>{`@keyframes recordSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`}</style>
              <img
                src={'/art/shizyfi/nowplaying.png'}
                alt={''}
                style={{ position:'absolute', left:'calc(14% + 125px)', bottom:'calc(8% + 20px)', width:72, height:'auto', transformOrigin:'50% 50%', animation: (audioRef.current && !audioRef.current.paused) ? 'recordSpin 6s linear infinite' : 'none', opacity: (audioRef.current && !audioRef.current.paused) ? 1 : 0.95, zIndex:2 }}
                onError={(e)=>{ e.currentTarget.style.display='none'; }}
              />
              {/* Scanlines overlay reduced width by ~40% (centered) */}
              <div style={{ ...styles.desktopScanlinesOverlay, top:'16%', right:'25%', bottom:'12%', left:'25%' }} />
            </div>
          </div>
        )}

        {calendarOpen && (
          <div style={styles.overlayClear} onClick={() => setCalendarOpen(false)}>
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={styles.mirrorFrame}>
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner }}>
              <div style={{ ...styles.title, textAlign:'center' }}>Calendar</div>
              <div style={{ marginTop: 8 }}>
                <div style={styles.statRow}><span>Week</span><b>{Math.min(week, MAX_WEEKS)} / {MAX_WEEKS}</b></div>
              </div>
              {!!activeEvents.length && (
                <div style={{ marginTop: 8 }}>
                  <div style={styles.h3}>This Week</div>
                  {activeEvents.map(ev => (
                    <div key={ev.id} style={{ ...styles.sub }}>
                      <b>{ev.title}</b> {'\u2014'} {ev.short}
                      {ev.effect && (
                        <div style={{ opacity: .9 }}>{effectSummary(ev.effect)}</div>
                      )}
                    </div>
                  ))}
                </div>
              )}
              {eventsSchedule && (
                <div style={{ marginTop: 8 }}>
                  <div style={styles.h3}>Upcoming</div>
                  {eventsSchedule.filter(e => e.week > week).slice(0,4).map(ev => (
                    <div key={ev.id} style={{ display:'flex', justifyContent:'space-between', padding:'4px 0' }}>
                      <span>W{ev.week} {'\u00B7'} {ev.title}</span>
                      <span style={{ ...styles.sub }}>{ev.short}</span>
                    </div>
                  ))}
                  {eventsSchedule.filter(e => e.week > week).length === 0 && (
                    <div style={styles.sub}>No upcoming events.</div>
                  )}
                </div>
              )}
              <button
                disabled={weekMode === 'song'}
                onClick={() => { if (weekMode==='song'){ pushToast("I'm too deep in the creative process to book a gig this week."); return; } if (activeEffects && activeEffects.ironGigLock){ pushToast('Iron Overture week: Gig booking disabled.'); return; } setCalendarOpen(false); setGigOpen(true); setSelectedGigSong(null); }}
                style={{ ...styles.secondaryBtn, marginTop: 10 }}
              >
                Book Gig (uses this week)
              </button>
              {null}
                </div>
              </div>
            </div>
          </div>
        )}

        {pairFeedback && (
          <div style={styles.overlayClear} onClick={() => setPairFeedback(null)}>
            <div style={styles.modal} onClick={(e) => e.stopPropagation()}>
              <div style={styles.title}>{pairFeedback}</div>
              <button onClick={() => setPairFeedback(null)} style={{ ...styles.primaryBtn, marginTop: 14 }}>
                Close
              </button>
            </div>
          </div>
        )}

        {releaseOpen && lastResult && (
          <div style={styles.overlayClear} onClick={() => { setReleaseOpen(false); try { if (lastResult) { if (lastResult.wizmasFlopZeroAll) { pushToast("This Wizmas song didn't land: no new fans or money"); } else if (lastResult.riskyFlopNoFans) { pushToast('Risky flop: no new fans.'); } } } catch (_) {} }}>
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={styles.mirrorFrame}>
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, top: '22%', bottom: '12%', justifyContent: 'flex-start' }}>
                  <div style={styles.title}>Release Results</div>
                  <div style={{ marginTop: 8, paddingBottom: 8 }}>
                    <div style={{ ...styles.sub, marginBottom: 6 }}>
                      Song: <b>{lastResult.songName}</b> - {lastResult.genre} / {lastResult.theme}
                    </div>
                    <div style={styles.statRow}><span>Critics Score</span><b>{Number(lastResult.score ?? 0).toFixed(2)}</b></div>
                    <div style={styles.statRow}><span>Grade</span><b>{lastResult.grade}</b></div>
                    {/* Charts moved to Trends; hide legacy chartPos */}
                    {lastResult.venue && (
                      <div style={styles.statRow}><span>Venue</span><b>{lastResult.venue}</b></div>
                    )}
                    <div style={styles.review}>
                      "{lastResult.review}"
                    </div>
                    <div style={{ ...styles.sub, marginTop: 8 }}>
                      +
                      <span style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                        {lastResult.moneyGain}
                        <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:14, height:14, objectFit:'contain' }} />
                      </span>
                    </div>
                    <div style={{ ...styles.sub, marginTop: 2 }}>+{lastResult.fansGain} fans</div>
                    {lastResult.trainingGains && (
                      <div style={{ marginTop: 10 }}>
                        <div style={styles.h3}>This Week's Progress</div>
                        <div style={{ display:'grid', gap:6, marginTop: 6 }}>
                          {(() => { const g = lastResult.trainingGains || {}; const b = lastResult.diceBefore||{}; const a = lastResult.diceAfter||{}; const changed = b.vocals!==a.vocals; const badge = a.vocals===20? '/art/d20badge.png' : a.vocals===12? '/art/d12badge.png' : '/art/d6badge.png'; return (
                            <div style={{ ...styles.statRow }}>
                              <span style={{ display:'inline-flex', alignItems:'center', gap:6 }}>
                                <img src={badge} alt={`d${a.vocals||'-'}`} style={styles.dieBadge} />
                                Sing
                              </span>
                              <b>+{Number(g.vocals||0).toFixed(2)}{changed? ` (d${b.vocals||'-'} → d${a.vocals||'-'})` : ''}</b>
                            </div>
                          ); })()}
                          {(() => { const g = lastResult.trainingGains || {}; const b = lastResult.diceBefore||{}; const a = lastResult.diceAfter||{}; const changed = b.writing!==a.writing; const badge = a.writing===20? '/art/d20badge.png' : a.writing===12? '/art/d12badge.png' : '/art/d6badge.png'; return (
                            <div style={{ ...styles.statRow }}>
                              <span style={{ display:'inline-flex', alignItems:'center', gap:6 }}>
                                <img src={badge} alt={`d${a.writing||'-'}`} style={styles.dieBadge} />
                                Write
                              </span>
                              <b>+{Number(g.writing||0).toFixed(2)}{changed? ` (d${b.writing||'-'} → d${a.writing||'-'})` : ''}</b>
                            </div>
                          ); })()}
                          {(() => { const g = lastResult.trainingGains || {}; const b = lastResult.diceBefore||{}; const a = lastResult.diceAfter||{}; const changed = b.stage!==a.stage; const badge = a.stage===20? '/art/d20badge.png' : a.stage===12? '/art/d12badge.png' : '/art/d6badge.png'; return (
                            <div style={{ ...styles.statRow }}>
                              <span style={{ display:'inline-flex', alignItems:'center', gap:6 }}>
                                <img src={badge} alt={`d${a.stage||'-'}`} style={styles.dieBadge} />
                                Dance
                              </span>
                              <b>+{Number(g.stage||0).toFixed(2)}{changed? ` (d${b.stage||'-'} → d${a.stage||'-'})` : ''}</b>
                            </div>
                          ); })()}
                        </div>
                      </div>
                    )}
                    {lastResult.feedback && lastResult.feedback.length > 0 && (
                      <div style={{ marginTop: 10 }}>
                        <div style={styles.h3}>Suggestions</div>
                        <ul style={styles.ul}>
                          {lastResult.feedback.map((t, i) => (
                            <li key={i} style={styles.li}>{t}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                    <button
                onClick={() => {
                  setReleaseOpen(false);
                  // Show risky flop toast after the results modal closes
                  try {
                    if (lastResult) {
                      if (lastResult.wizmasFlopZeroAll) {
                        pushToast("This Wizmas song didn't land: no new fans or money");
                      } else if (lastResult.riskyFlopNoFans) {
                        pushToast('Risky flop: no new fans.');
                      }
                    }
                  } catch (_) {}
                  if (finalePending && lastResult && lastResult.releaseWeek === MAX_WEEKS && !isPerforming && !suppressFinale) {
                    setFinalePending(false);
                    setEndYearReady(true);
                  }
                }}
                style={{ ...styles.primaryBtn, marginTop: 12 }}
              >
                Continue
              </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Poster collection modal */}
        {posterOpen && (
          <div style={styles.overlayClear} onClick={() => setPosterOpen(false)}>
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={styles.mirrorFrame}>
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, top: '22%', bottom: '10%', justifyContent: 'flex-start' }}>
                  <div style={styles.title}>My Poster Collection</div>
                  {(!unlockedPosters || unlockedPosters.length === 0) ? (
                    <div style={{ ...styles.sub, marginTop: 8 }}>No posters unlocked yet. Buy a Mystery Poster from the shop!</div>
                  ) : (
                    <div style={{ marginTop: 10, display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(88px, 1fr))', gap: 8 }}>
                      <button key="none" onClick={() => setCurrentPosterIdx(null)} style={{ display:'flex', flexDirection:'column', gap:6, alignItems:'center', justifyContent:'center', background:'rgba(255,255,255,.04)', border:'1px dashed rgba(255,255,255,.25)', borderRadius: 10, padding: 6, cursor: 'pointer' }}>
                        <div style={{ width: 80, height: 80, borderRadius: 8, background:'rgba(255,255,255,.05)', display:'flex', alignItems:'center', justifyContent:'center', color:'rgba(255,255,255,.7)', fontWeight:800, fontSize:12 }}>No Poster</div>
                        <div style={{ fontSize: 12, opacity: .9, fontWeight: 700 }}>None</div>
                      </button>
                      {unlockedPosters.map((idx) => (
                        <button key={idx} onClick={() => setCurrentPosterIdx(idx)} style={{ display:'flex', flexDirection:'column', gap:6, alignItems:'center', justifyContent:'center', background:'rgba(255,255,255,.06)', border:'1px solid rgba(255,255,255,.2)', borderRadius: 10, padding: 6, cursor: 'pointer' }}>
                          <img src={POSTERS[idx]} alt={`Poster ${idx+1}`} style={{ width: 80, height: 80, objectFit: 'cover', borderRadius: 8, filter:'drop-shadow(0 2px 6px rgba(0,0,0,.3))' }} />
                          <div style={{ fontSize: 12, opacity: .9, fontWeight: 700 }}>{idx+1}</div>
                        </button>
                      ))}
                    </div>
                  )}
                  <button onClick={() => setPosterOpen(false)} style={{ ...styles.primaryBtn, marginTop: 12 }}>Close</button>
                </div>
              </div>
            </div>
          </div>
        )}

        {venueOpen && (
          <div style={styles.overlayClear} onClick={() => setVenueOpen(false)}>
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={styles.mirrorFrame}>
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, justifyContent: 'flex-start' }}>
                  <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between' }}>
                    <div style={styles.title}>Choose Venue & Perform</div>
                    <button title="Performance Cosmetics" onClick={() => setVenueTab(venueTab==='cosmetics' ? 'venues' : 'cosmetics')} style={{ ...styles.smallBtn, padding:'6px 10px' }}>{venueTab==='cosmetics' ? 'Back' : 'Cosmetics'}</button>
                  </div>
                  {venueTab === 'venues' ? (
                    <>
                      <div style={{ ...styles.sub, marginTop: 6 }}>Pick a venue for your finished song.</div>
                      <div style={{ marginTop: 8, display: 'grid', gap: 8 }}>
                        {Object.entries(VENUES)
                          .filter(([key]) => key !== 'stadium')
                          .filter(([key]) => {
                            const ironOnly = !!(activeEffects && activeEffects.ironVenue);
                            return ironOnly ? (key === 'iron') : (key !== 'iron');
                          })
                          .map(([key, v]) => {
                          // Simple textual forecast
                          let expected = 0;
                          if (DICE_MODE) {
                            const s = rollBest.sing ? ((rollBest.sing.faces + 1 - rollBest.sing.value) / rollBest.sing.faces) : 0;
                            const w = rollBest.write ? ((rollBest.write.faces + 1 - rollBest.write.value) / rollBest.write.faces) : 0;
                            const p = rollBest.perform ? ((rollBest.perform.faces + 1 - rollBest.perform.value) / rollBest.perform.faces) : 0;
                            expected = Math.round(clamp((0.34*s+0.33*w+0.33*p)*92 + computePairBonus(genre, theme, false), 0, 100));
                          } else {
                            const triadE = actions.reduce((acc,a)=> a.t==='gig'? acc : acc + (a.m||0)+(a.l||0)+(a.p||0), 0);
                            const baseE = triadE * 5;
                            const earlyF = Math.min(1, 0.75 + (week - 1) * 0.05);
                            expected = Math.round(
                              clamp(baseE * earlyF + computePairBonus(genre, theme, false), 0, 100)
                            );
                          }
                          const margin = expected - (v.breakEven ?? 0);
                          const risk = v.cost === 0 ? 'None' : margin >= 5 ? 'Low' : margin >= 0 ? 'Edge' : 'High';
                          const turnout = v.fanMult >= 2 ? 'Huge' : v.fanMult >= 1.4 ? 'High' : v.fanMult >= 1 ? 'Medium' : 'Low';
                          const fansPot = v.fanMult >= 2 ? 'Massive' : v.fanMult >= 1.4 ? 'Big' : v.fanMult >= 1 ? 'Solid' : 'Small';
                          const ironOnly = !!(activeEffects && activeEffects.ironVenue);
                          const lockedByIron = ironOnly && key !== 'iron';
                          const locked = (fans < (VENUE_FAN_REQ[key] ?? 0)) || lockedByIron;
                          const isSwingy = (compat < 0);
                          const reqText = lockedByIron
                            ? 'Festival week: The Iron Overture only'
                            : (VENUE_FAN_REQ[key] ? `Requires ${VENUE_FAN_REQ[key]} fans` : null);
                          return (
                            <div key={key} style={{ border: '1px solid rgba(255,255,255,.2)', borderRadius: 12, padding: 10 }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div style={{ fontWeight: 700 }}>
                                  {v.name}
                                </div>
                                <div style={{ ...styles.sub, display:'inline-flex', alignItems:'center', gap:4 }}>
                                  Cost:
                                  <span style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                                    {v.cost}
                                    <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:14, height:14, objectFit:'contain' }} />
                                  </span>
                                </div>
                              </div>
                              <div style={{ ...styles.sub, marginTop: 6 }}>{v.desc}</div>
                              <div style={{ display: 'flex', gap: 10, flexWrap: 'wrap', marginTop: 6, fontSize: 12, opacity: .9 }}>
                                <div>Turnout: <b>{turnout}</b></div>
                                <div>Risk: <b>{risk}</b></div>
                                <div>Fans: <b>{fansPot}</b></div>
                                {isSwingy && <div style={{ color: 'rgba(255,220,140,.95)' }}>Swingy</div>}
                                {locked && reqText && <div style={{ color: 'rgba(255,120,120,.9)' }}>{reqText}</div>}
                              </div>
                              <button disabled={locked} onClick={() => performRelease(key)} style={{ ...(locked ? styles.primaryBtnDisabled : styles.primaryBtn), marginTop: 8 }}>
                                Perform here
                              </button>
                            </div>
                          );
                        })}
                      </div>
                    </>
                  ) : (
                    <div style={{ marginTop: 8 }}>
                      <div style={styles.sub}>My Performance Cosmetics</div>
                      <div style={{ marginTop: 8, display:'grid', gap:8 }}>
                        {/* Midnight Haze */}
                        <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', border:'1px solid rgba(255,255,255,.2)', borderRadius:10, padding:10 }}>
                          <div>
                            <div style={{ fontWeight:800 }}>{midnightHazeUnlocked ? 'Midnight Haze Lighting' : '???'}</div>
                            <div style={{ ...styles.sub }}>Synthwave only (default)</div>
                          </div>
                          <div style={{ display:'flex', alignItems:'center', gap:14 }}>
                            <label style={{ display:'inline-flex', alignItems:'center', gap:6 }}>
                              <input type="checkbox" disabled={!midnightHazeUnlocked} checked={!!midnightHazeEnabled && midnightHazeUnlocked} onChange={(e)=> setMidnightHazeEnabled(!!e.target.checked)} />
                              <span>{midnightHazeUnlocked ? (midnightHazeEnabled ? 'On' : 'Off') : 'Locked'}</span>
                            </label>
                            <label style={{ display:'inline-flex', alignItems:'center', gap:6 }}>
                              <input type="checkbox" disabled={!midnightHazeUnlocked} checked={!!midnightHazeAllGenres && midnightHazeUnlocked} onChange={(e)=> setMidnightHazeAllGenres(!!e.target.checked)} />
                              <span>All genres</span>
                            </label>
                          </div>
                        </div>
                        {/* Rainfall Lighting */}
                        <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', border:'1px solid rgba(255,255,255,.2)', borderRadius:10, padding:10 }}>
                          <div>
                            <div style={{ fontWeight:800 }}>{rainfallUnlocked ? 'Rainfall Stage Lighting' : '???'}</div>
                            <div style={{ ...styles.sub }}>Rock only (default)</div>
                          </div>
                          <div style={{ display:'flex', alignItems:'center', gap:14 }}>
                            <label style={{ display:'inline-flex', alignItems:'center', gap:6 }}>
                              <input type="checkbox" disabled={!rainfallUnlocked} checked={!!rainfallEnabled && rainfallUnlocked} onChange={(e)=> setRainfallEnabled(!!e.target.checked)} />
                              <span>{rainfallUnlocked ? (rainfallEnabled ? 'On' : 'Off') : 'Locked'}</span>
                            </label>
                            <label style={{ display:'inline-flex', alignItems:'center', gap:6 }}>
                              <input type="checkbox" disabled={!rainfallUnlocked} checked={!!rainfallAllGenres && rainfallUnlocked} onChange={(e)=> setRainfallAllGenres(!!e.target.checked)} />
                              <span>All genres</span>
                            </label>
                          </div>
                        </div>
                        {/* Spotlight Snap */}
                        <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', border:'1px solid rgba(255,255,255,.2)', borderRadius:10, padding:10 }}>
                          <div>
                            <div style={{ fontWeight:800 }}>{spotlightSnapUnlocked ? 'Spotlight Snap' : '???'}</div>
                            <div style={{ ...styles.sub }}>Hip-Hop only (default)</div>
                        </div>
                          <div style={{ display:'flex', alignItems:'center', gap:14 }}>
                            <label style={{ display:'inline-flex', alignItems:'center', gap:6 }}>
                              <input type="checkbox" disabled={!spotlightSnapUnlocked} checked={!!spotlightSnapEnabled && spotlightSnapUnlocked} onChange={(e)=> setSpotlightSnapEnabled(!!e.target.checked)} />
                              <span>{spotlightSnapUnlocked ? (spotlightSnapEnabled ? 'On' : 'Off') : 'Locked'}</span>
                            </label>
                            <label style={{ display:'inline-flex', alignItems:'center', gap:6 }}>
                              <input type="checkbox" disabled={!spotlightSnapUnlocked} checked={!!spotlightAllGenres && spotlightSnapUnlocked} onChange={(e)=> setSpotlightAllGenres(!!e.target.checked)} />
                              <span>All genres</span>
                            </label>
                          </div>
                        </div>
                        {/* Pink Bubbles */}
                        <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', border:'1px solid rgba(255,255,255,.2)', borderRadius:10, padding:10 }}>
                          <div>
                            <div style={{ fontWeight:800 }}>{pinkBubblesUnlocked ? 'Pink Bubbles' : '???'}</div>
                            <div style={{ ...styles.sub }}>Pop only (default)</div>
                          </div>
                          <div style={{ display:'flex', alignItems:'center', gap:14 }}>
                            <label style={{ display:'inline-flex', alignItems:'center', gap:6 }}>
                              <input type="checkbox" disabled={!pinkBubblesUnlocked} checked={!!pinkBubblesEnabled && pinkBubblesUnlocked} onChange={(e)=> setPinkBubblesEnabled(!!e.target.checked)} />
                              <span>{pinkBubblesUnlocked ? (pinkBubblesEnabled ? 'On' : 'Off') : 'Locked'}</span>
                            </label>
                            <label style={{ display:'inline-flex', alignItems:'center', gap:6 }}>
                              <input type="checkbox" disabled={!pinkBubblesUnlocked} checked={!!pinkBubblesAllGenres && pinkBubblesUnlocked} onChange={(e)=> setPinkBubblesAllGenres(!!e.target.checked)} />
                              <span>All genres</span>
                            </label>
                          </div>
                        </div>
                        {/* Iron Overture Filter */}
                        <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', border:'1px solid rgba(255,255,255,.2)', borderRadius:10, padding:10 }}>
                          <div>
                            <div style={{ fontWeight:800 }}>{rivetFilterUnlocked ? 'Iron Overture Filter' : '???'}</div>
                            <div style={{ ...styles.sub }}>Metal only (default)</div>
                          </div>
                          <div style={{ display:'flex', alignItems:'center', gap:14 }}>
                            <label style={{ display:'inline-flex', alignItems:'center', gap:6 }}>
                              <input type="checkbox" disabled={!rivetFilterUnlocked} checked={!!rivetFilterEnabled && rivetFilterUnlocked} onChange={(e)=> setRivetFilterEnabled(!!e.target.checked)} />
                              <span>{rivetFilterUnlocked ? (rivetFilterEnabled ? 'On' : 'Off') : 'Locked'}</span>
                            </label>
                            <label style={{ display:'inline-flex', alignItems:'center', gap:6 }}>
                              <input type="checkbox" disabled={!rivetFilterUnlocked} checked={!!rivetFilterAllGenres && rivetFilterUnlocked} onChange={(e)=> setRivetFilterAllGenres(!!e.target.checked)} />
                              <span>All genres</span>
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {gigOpen && (
          <div style={styles.overlayClear} onClick={() => setGigOpen(false)}>
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={styles.mirrorFrame}>
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, justifyContent: 'flex-start' }}>
                  <div style={styles.title}>Book Gig</div>
                  <div style={{ ...styles.sub, marginTop: 6 }}>Play an older song to earn money and potentially attract more fans. Uses 1 week. Works best when performing highly rated songs.</div>
                  <div className="hide-scrollbar" style={{ marginTop: 8, maxHeight: 240, overflowY: 'auto', border: '1px solid rgba(255,255,255,.15)', borderRadius: 10, padding: 6 }}>
                {songHistory.length === 0 ? (
                  <div style={styles.sub}>No past songs yet.</div>
                ) : (
                  songHistory.map((s, idx) => (
                    <div key={idx} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '6px 8px', borderBottom: '1px solid rgba(255,255,255,.08)' }}>
                      <div>
                        <div style={{ fontWeight: 700 }}>{s.songName}</div>
                        <div style={{ ...styles.sub }}>Grade {s.grade}</div>
                      </div>
                      <button style={styles.smallBtn} onClick={() => setSelectedGigSong(s)}>Select</button>
                    </div>
                  ))
                )}
                  </div>
              {selectedGigSong && (
                <div style={{ marginTop: 10 }}>
                  <div style={{ ...styles.sub, marginBottom: 6 }}>Selected: <b>{selectedGigSong.songName}</b> | Fixed score {selectedGigSong.score}</div>
                  <div style={{ display: 'grid', gap: 8 }}>
                    {Object.entries(VENUES).filter(([key]) => key !== 'stadium' && key !== 'iron').map(([key, v]) => {
                          const expected = Number(selectedGigSong.score ?? 0);
                      const margin = expected - (v.breakEven ?? 0);
                      const risk = v.cost === 0 ? 'None' : margin >= 5 ? 'Low' : margin >= 0 ? 'Edge' : 'High';
                      const turnout = v.fanMult >= 2 ? 'Huge' : v.fanMult >= 1.4 ? 'High' : v.fanMult >= 1 ? 'Medium' : 'Low';
                      const fansPot = v.fanMult >= 2 ? 'Massive' : v.fanMult >= 1.4 ? 'Big' : v.fanMult >= 1 ? 'Solid' : 'Small';
                      const locked = (fans < (VENUE_FAN_REQ[key] ?? 0));
                      const reqText = VENUE_FAN_REQ[key] ? `Requires ${VENUE_FAN_REQ[key]} fans` : null;
                      const capReached = weeklyGigs >= MAX_GIGS_PER_WEEK;
                      return (
                        <div key={key} style={{ border: '1px solid rgba(255,255,255,.2)', borderRadius: 12, padding: 10 }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div style={{ fontWeight: 700 }}>{v.name}</div>
                            <div style={{ ...styles.sub, display:'inline-flex', alignItems:'center', gap:4 }}>
                              Cost:
                              <span style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                                {v.cost}
                                <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:14, height:14, objectFit:'contain' }} />
                              </span>
                            </div>
                          </div>
                          <div style={{ ...styles.sub, marginTop: 6 }}>{v.desc}</div>
                          <div style={{ display: 'flex', gap: 10, flexWrap: 'wrap', marginTop: 6, fontSize: 12, opacity: .9 }}>
                            <div>Turnout: <b>{turnout}</b></div>
                            <div>Risk: <b>{risk}</b></div>
                            <div>Fans: <b>{fansPot}</b></div>
                            {locked && reqText && <div style={{ color: 'rgba(255,120,120,.9)' }}>{reqText}</div>}
                            {capReached && <div style={{ color: 'rgba(255,120,120,.9)' }}>Weekly gig cap reached</div>}
                          </div>
                          <button
                            disabled={locked}
                            onClick={() => {
                              // Consume week and set up performance playback like release flow
                              const vCfg = VENUES[key] ?? VENUES.busking;
                              const score = Number(selectedGigSong.score ?? 0);
                              const grade = gradeFromScore(score);
                              const fansGainByGrade = { S: 60, A: 40, B: 25, C: 12, D: 5 };
                              const fanBase = Number.isFinite(fans) ? fans : 0;
                              const fanBonus = Math.floor(fanBase * 0.05);
                              const weeksSinceRelease = Math.max(0, week - (selectedGigSong.releaseWeek || week));
                              const freshness = Math.max(0.6, 1 - 0.08 * weeksSinceRelease);
                              let fansGainLocal = Math.round(((fansGainByGrade[grade] ?? 0) + fanBonus) * (vCfg.fanMult ?? 1) * freshness * (activeEffects?.fanMult || 1));
                              const marginLocal = score - (vCfg.breakEven ?? 0);
                              let gross = Math.max(0, marginLocal) * (vCfg.payoutPerPoint ?? 0) * freshness * (activeEffects?.payoutMult || 1);
                              let net = Math.floor(gross - (vCfg.cost ?? 0));
                              if (key === 'busking') net = Math.max(vCfg.tipFloor ?? 5, net);
                              if (week <= 3) net = Math.max(net, -20);

                              // Apply gains up front (consistent with release flow)
                              setWeekMode('gig');
                              setMoney((m) => m + net);
                              setFans((f) => (Number.isFinite(f) ? f : 0) + (Number.isFinite(fansGainLocal) ? fansGainLocal : 0));
                              const boost = key === 'busking' ? 1.1 : 1.0;
                              const stageGain = 0.25 * boost;
                              const vocalsGain = 0.12 * boost;
                              setStage((v) => clamp(v + stageGain, 0, 10));
                              setVocals((v) => clamp(v + vocalsGain, 0, 10));
                              // Count these gains toward weekly training
                              setWeekStageGain((g) => +(g + stageGain).toFixed(3));
                              setWeekVocGain((g) => +(g + vocalsGain).toFixed(3));
                              // Record gig into history entry
                              setSongHistory((arr) => {
                                const copy = arr.slice();
                                const idx = copy.findIndex((e) => e.songName === selectedGigSong.songName && e.releaseWeek === selectedGigSong.releaseWeek);
                                if (idx >= 0) {
                                  const entry = { ...(copy[idx] || {}) };
                                  entry.gigs = [...(entry.gigs || []), { week, venue: vCfg.name, moneyGain: net, fansGain: fansGainLocal }];
                                  copy[idx] = entry;
                                }
                                return copy;
                              });
                              // Prepare gig results payload
                              setGigResult({ venue: vCfg.name, money: net, fans: fansGainLocal, stageGain, vocalsGain });

                              // Advance to next week and reset
                              setGigOpen(false);
                              setCalendarOpen(false);
                              setFinanceOpen(false);
                              setWeek((w) => w + 1);
                              resetWeekProgress();

                              // Start performance playback like release flow
                              try {
                                if (performAudioRef.current) { try { performAudioRef.current.pause(); } catch (_) {} }
                                setPerformingVenue(key);
                                setPerformingSong({ name: selectedGigSong.songName, genre: selectedGigSong.genre, theme: selectedGigSong.theme });
                                setIsPerforming(true);
                                setIsGigPlayback(true);
                                setTarget(null);
                                setPos({ x: 50, y: 62 });
                                setActivity('singing');
                                setStatus(`Performing at ${vCfg.name}...`);
                                const genreKey = (() => {
                                  switch (selectedGigSong.genre) {
                                    case 'Rock': return 'rock';
                                    case 'EDM': return 'edm';
                                    case 'Hip-Hop': return 'hiphop';
                                    case 'Jazz': return 'jazz';
                                    case 'Country': return 'country';
                                    case 'R&B': return 'randb';
                                    case 'Metal': return 'metal';
                                    case 'Folk': return 'folk';
                                    case 'Synthwave': return 'synthwave';
                                    case 'Wizmas Banger': return 'wizmas';
                                    case 'Pop': default: return null;
                                  }
                                })();
                                const primarySrc = genreKey ? `/sounds/fullsinging_${genreKey}.ogg` : '/sounds/fullsinging.ogg';
                                const fallbackSrc = '/sounds/fullsinging.ogg';
                                const audio = new Audio(primarySrc);
                                let didFallback = false;
                                audio.onended = () => {
                                  setIsPerforming(false);
                                  setActivity('idle');
                                  performAudioRef.current = null;
                                  setPerformingSong(null);
                                  setIsGigPlayback(false);
                                  setGigResultOpen(true);
                                };
                                audio.onerror = () => {
                                  if (!didFallback) { didFallback = true; try { audio.src = fallbackSrc; audio.play().catch(() => {}); } catch (_) {} }
                                };
                                performAudioRef.current = audio;
                                audio.play().catch(() => {});
                              } catch (_) {
                                // If playback fails, fall back to immediate results
                                setIsPerforming(false);
                                setIsGigPlayback(false);
                                setGigResultOpen(true);
                              }
                            }}
                            style={{ ...(locked ? styles.primaryBtnDisabled : styles.primaryBtn), marginTop: 8 }}
                          >
                            Book this gig (use week)
                          </button>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
                  <button onClick={() => setGigOpen(false)} style={{ ...styles.primaryBtn, marginTop: 12 }}>Close</button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Finale: choose a past song to perform at Katie's Birthday Party */}
        {finaleOpen && (
          <div style={styles.overlayClear} onClick={() => setFinaleOpen(false)}>
            <div style={{ ...styles.modal, maxWidth: 520 }} onClick={(e) => e.stopPropagation()}>
              <div style={styles.title}>Katie's Birthday Celebration</div>
              <div style={{ ...styles.sub, marginTop: 6 }}>Pick a favorite song from your history to perform at Katie's Birthday Party.</div>
              <div style={{ marginTop: 8, maxHeight: 260, overflowY: 'auto', border: '1px solid rgba(255,255,255,.15)', borderRadius: 10, padding: 6 }}>
                {songHistory.length === 0 ? (
                  <div style={styles.sub}>No past songs yet.</div>
                ) : (
                  songHistory.map((s, idx) => (
                    <div key={idx} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '6px 8px', borderBottom: '1px solid rgba(255,255,255,.08)' }}>
                      <div>
                        <div style={{ fontWeight: 700 }}>{s.songName}</div>
                        <div style={{ ...styles.sub }}>Grade {s.grade}</div>
                      </div>
                      <button style={styles.smallBtn} onClick={() => setFinaleSong(s)}>Select</button>
                    </div>
                  ))
                )}
              </div>
              <button
                disabled={!finaleSong}
                onClick={() => {
                  if (!finaleSong) return;
                  try { setFinaleOpen(false); } catch (_) {}
                  setPerformingVenue('katieparty');
                  setPerformingSong({ name: finaleSong.songName, genre: finaleSong.genre, theme: finaleSong.theme });
                  setIsPerforming(true);
                  setFinaleInProgress(true);
                  setTarget(null);
                  setPos({ x: 50, y: 62 });
                  setActivity('singing');
                  setStatus("Celebrating at Katie's Birthday...");
                  try {
                    if (performAudioRef.current) { try { performAudioRef.current.pause(); } catch (_) {} }
                    const genreKey = (() => {
                      switch (finaleSong.genre) {
                        case 'Rock': return 'rock';
                        case 'EDM': return 'edm';
                        case 'Hip-Hop': return 'hiphop';
                        case 'Jazz': return 'jazz';
                        case 'Country': return 'country';
                        case 'R&B': return 'randb';
                        case 'Metal': return 'metal';
                        case 'Folk': return 'folk';
                        case 'Synthwave': return 'synthwave';
                        case 'Wizmas Banger': return 'wizmas';
                        case 'Pop': default: return null;
                      }
                    })();
                    const primarySrc = genreKey ? `/sounds/fullsinging_${genreKey}.ogg` : '/sounds/fullsinging.ogg';
                    const fallbackSrc = '/sounds/fullsinging.ogg';
                    const audio = new Audio(primarySrc);
                    let didFallback = false;
                    audio.onended = () => {
                      setIsPerforming(false);
                      setActivity('idle');
                      performAudioRef.current = null;
                      setPerformingSong(null);
                    };
                    audio.onerror = () => {
                      if (!didFallback) {
                        didFallback = true;
                        try { audio.src = fallbackSrc; audio.play().catch(() => {}); } catch (_) {}
                      }
                    };
                    performAudioRef.current = audio;
                    audio.play().catch(() => {
                      // Fallback: ensure it still ends
                      setTimeout(() => { try { setIsPerforming(false); } catch (_) {} }, 6000);
                    });
                  } catch (_) {
                    // Final fallback if audio setup fails completely
                    setTimeout(() => { try { setIsPerforming(false); } catch (_) {} }, 6000);
                  }
                }}
                style={!finaleSong ? styles.primaryBtnDisabled : styles.primaryBtn}
              >
                Perform at Katie's Party
              </button>
              <button onClick={() => setFinaleOpen(false)} style={{ ...styles.secondaryBtn, marginTop: 8 }}>Cancel</button>
            </div>
          </div>
        )}

        {/* Finale Summary (appears after Week 52 release, before party) */}
        {finaleSummaryOpen && (
          <div style={styles.overlayClear}>
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={{ ...styles.mirrorFrame, backgroundImage: "url('/art/modalframe_mirror.png')" }}>
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, top: '22%', bottom: '12%', justifyContent: 'flex-start' }}>
                  <div style={styles.title}>Year Summary</div>
                  <div style={{ marginTop: 8 }}>
                {(() => {
                  const top = songHistory.slice().sort((a,b)=> (b.score||0)-(a.score||0)).slice(0,5);
                  const totalMoney = songHistory.reduce((sum, s) => sum + (s.moneyGain||0) + (Array.isArray(s.gigs)? s.gigs.reduce((gSum,g)=>gSum+(g.moneyGain||0),0):0), 0);
                  return (
                    <div>
                      <div style={{ fontWeight: 900, marginBottom: 6 }}>Top 5 Songs</div>
                      {top.length === 0 ? (
                        <div style={styles.sub}>No songs released this year.</div>
                      ) : (
                        <div style={{ display:'grid', gap:6 }}>
                          {top.map((s,i)=>(
                            <div key={i} style={{ display:'flex', justifyContent:'space-between', border:'1px solid rgba(255,255,255,.15)', borderRadius:10, padding:8 }}>
                              <div><b>#{i+1}</b> {s.songName}</div>
                              <div>Score <b>{Number(s.score ?? 0).toFixed(2)}</b> | Grade <b>{s.grade}</b></div>
                            </div>
                          ))}
                        </div>
                      )}
                      {(() => {
                        // Preferred genre: most releases; tie-break by best single score
                        const stats = (songHistory||[]).reduce((acc, s) => {
                          const g = s && s.genre; if (!g) return acc;
                          const sc = Number(s.score || 0);
                          const o = acc[g] || { count: 0, best: -Infinity };
                          o.count += 1; o.best = Math.max(o.best, sc); acc[g] = o; return acc;
                        }, {});
                        const keys = Object.keys(stats);
                        const pref = keys.length ? keys.sort((a,b)=>{
                          const A = stats[a], B = stats[b];
                          if (B.count !== A.count) return B.count - A.count;
                          return (B.best||-Infinity) - (A.best||-Infinity);
                        })[0] : null;
                        return (
                          <div style={{ ...styles.statRow, marginTop: 10 }}><span>Preferred Genre</span><b>{pref || '-'}</b></div>
                        );
                      })()}
                      {/* Friends summary */}
                      {(() => {
                        try {
                          const met = FRIENDS_ORDER.filter(id => (friends?.[id]?.level || 0) > 0).length;
                          return (
                            <div style={{ marginTop: 10 }}>
                              <div style={{ fontWeight: 900, marginBottom: 2 }}>Friends</div>
                              <div style={{ ...styles.sub, marginBottom: 6 }}>Friends met {met}/{FRIENDS_ORDER.length}</div>
                              <div style={{ display:'grid', gap:6 }}>
                                {FRIENDS_ORDER.map((id) => {
                                  const lvl = Math.max(0, friends?.[id]?.level || 0);
                                  const name = lvl > 0 ? (friends?.[id]?.bio?.title || (id==='luminaO'?'Lumina-O': id==='aureliagleam'?'Aurelia Gleam' : id.charAt(0).toUpperCase()+id.slice(1))) : '???';
                                  return (
                                    <div key={id} style={{ display:'flex', justifyContent:'space-between' }}>
                                      <div>{name}</div>
                                      <div>lvl <b>{lvl}/{MAX_FRIEND_LEVEL}</b></div>
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                          );
                        } catch (_) { return null; }
                      })()}

                      <div style={{ ...styles.statRow, marginTop: 10 }}><span>Total Fans</span><b>{fans}</b></div>
                      <div style={styles.statRow}>
                        <span>Total Money Earned</span>
                        <b>
                          <span style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                            {totalMoney}
                            <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:14, height:14, objectFit:'contain' }} />
                          </span>
                        </b>
                      </div>
                      {/* Best Chart Position removed; Trends is canonical */}
                    </div>
                  );
                })()}
                  </div>
                  <div style={{ display:'flex', gap:8, marginTop: 12 }}>
                    <button onClick={() => { setFinaleSummaryOpen(false); setFinaleOpen(true); }} style={styles.primaryBtn}>Celebrate Katie's Birthday</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {gigResultOpen && gigResult && (
          <div style={styles.overlayClear} onClick={() => setGigResultOpen(false)}>
            <div style={styles.modal} onClick={(e) => e.stopPropagation()}>
              <div style={styles.title}>Gig Results</div>
              <div style={{ marginTop: 8 }}>
                <div style={styles.statRow}><span>Venue</span><b>{gigResult.venue}</b></div>
                <div style={styles.statRow}>
                  <span>Money</span>
                  <b>
                    <span style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                      {gigResult.money}
                      <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:14, height:14, objectFit:'contain' }} />
                    </span>
                  </b>
                </div>
                <div style={styles.statRow}><span>Fans</span><b>+{gigResult.fans}</b></div>
                <div style={{ display:'flex', gap:8, marginTop:10 }}>
                  <div style={{ padding:'6px 10px', border:'1px solid rgba(255,255,255,.25)', borderRadius:999, background:'rgba(255,255,255,.08)' }}>
                    Stage <b>+{(gigResult.stageGain||0).toFixed(2)}</b>
                  </div>
                  <div style={{ padding:'6px 10px', border:'1px solid rgba(255,255,255,.25)', borderRadius:999, background:'rgba(255,255,255,.08)' }}>
                    Vocals <b>+{(gigResult.vocalsGain||0).toFixed(2)}</b>
                  </div>
                </div>
                <div style={{ ...styles.sub, marginTop: 8 }}>A full week on the road boosted your skills.</div>
              </div>
              <button onClick={() => setGigResultOpen(false)} style={{ ...styles.primaryBtn, marginTop: 12 }}>Continue</button>
            </div>
          </div>
        )}

        {/* Finale ending options after party performance */}
        {finaleEndOpen && (
          <div style={styles.overlayClear} onClick={() => setFinaleEndOpen(false)}>
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={styles.mirrorFrame}>
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner, top: '22%', bottom: '12%', justifyContent: 'flex-start' }}>
                  <div style={styles.title}>Season Complete</div>
                  <div style={{ ...styles.sub, marginTop: 8 }}>Thanks for celebrating at Katie's Birthday!</div>
                  <div style={{ marginTop: 8 }}>
                {(() => {
                  const top = songHistory.slice().sort((a,b)=> (b.score||0)-(a.score||0)).slice(0,5);
                  const totalMoney = songHistory.reduce((sum, s) => sum + (s.moneyGain||0) + (Array.isArray(s.gigs)? s.gigs.reduce((gSum,g)=>gSum+(g.moneyGain||0),0):0), 0);
                  return (
                    <div>
                      <div style={{ fontWeight: 900, marginBottom: 6 }}>Top 5 Songs</div>
                      {top.length === 0 ? (
                        <div style={styles.sub}>No songs released this year.</div>
                      ) : (
                        <div style={{ display:'grid', gap:6 }}>
                          {top.map((s,i)=>(
                            <div key={i} style={{ display:'flex', justifyContent:'space-between', border:'1px solid rgba(255,255,255,.15)', borderRadius:10, padding:8 }}>
                              <div><b>#{i+1}</b> {s.songName}</div>
                              <div>Score <b>{Number(s.score ?? 0).toFixed(2)}</b> | Grade <b>{s.grade}</b></div>
                            </div>
                          ))}
                        </div>
                      )}
                      {(() => {
                        const stats = (songHistory||[]).reduce((acc, s) => {
                          const g = s && s.genre; if (!g) return acc;
                          const sc = Number(s.score || 0);
                          const o = acc[g] || { count: 0, best: -Infinity };
                          o.count += 1; o.best = Math.max(o.best, sc); acc[g] = o; return acc;
                        }, {});
                        const keys = Object.keys(stats);
                        const pref = keys.length ? keys.sort((a,b)=>{
                          const A = stats[a], B = stats[b];
                          if (B.count !== A.count) return B.count - A.count;
                          return (B.best||-Infinity) - (A.best||-Infinity);
                        })[0] : null;
                        return (
                          <div style={{ ...styles.statRow, marginTop: 10 }}><span>Preferred Genre</span><b>{pref || '-'}</b></div>
                        );
                      })()}
                      <div style={{ ...styles.statRow, marginTop: 10 }}><span>Total Fans</span><b>{fans}</b></div>
                      <div style={styles.statRow}>
                        <span>Total Money Earned</span>
                        <b>
                          <span style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                            {totalMoney}
                            <img src={'/art/glimbug.png'} alt={'Glimbug'} style={{ width:14, height:14, objectFit:'contain' }} />
                          </span>
                        </b>
                      </div>
                      {/* Best Chart Position removed; Trends is canonical */}
                    </div>
                  );
                })()}
                  </div>
                  <div style={{ display:'flex', gap:8, marginTop: 12 }}>
                    <button onClick={() => { setFinaleEndOpen(false); restart(); }} style={styles.primaryBtn}>Start New Game</button>
                    <button onClick={() => { setSuppressFinale(true); setFinaleEndOpen(false); }} style={styles.secondaryBtn}>Continue playing (for fun)</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {historyOpen && (
          <div style={styles.overlayClear} onClick={() => setHistoryOpen(false)}>
            <div style={{ ...styles.mirrorModal }} onClick={(e) => e.stopPropagation()}>
              <div style={styles.mirrorFrame}>
                <div className="hide-scrollbar" style={{ ...styles.mirrorInner }}>
                  <div style={{ ...styles.title, textAlign:'center' }}>My Song History</div>
                  <div style={{ marginTop: 8, maxHeight: 360, overflowY: 'auto' }}>
                    {songHistory.length === 0 ? (
                      <div style={styles.sub}>No releases yet.</div>
                    ) : (
                      songHistory.map((s, idx) => (
                        <div key={idx} style={{ padding: '8px 0', borderBottom: '1px solid rgba(255,255,255,.1)' }}>
                          <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center' }}>
                            <span>
                              <b>{s.songName}</b>
                              {/* Trends are canonical; hide legacy chartPos */}
                            </span>
                            <span>
                              <span style={{ opacity: .8, marginRight: 8 }}>{s.grade}</span>
                              <b>+{s.moneyGain}</b>
                            </span>
                          </div>
                          {(s.gigs && s.gigs.length>0) && (
                            <div style={{ marginTop: 6, fontSize: 12, opacity: .9 }}>
                              Gigs: {s.gigs.length}
                              <div style={{ marginTop: 4 }}>
                                {s.gigs.slice(-3).reverse().map((g, i2) => (
                                  <div key={i2} style={{ display:'flex', justifyContent:'space-between' }}>
                                    <span>Week {g.week} | {g.venue}</span>
                                    <span>+{'\u00A3'}{g.moneyGain} +{g.fansGain} fans</span>
                                  </div>
                                ))}
                                {s.gigs.length > 3 && <div style={{ opacity: .7 }}>(+{s.gigs.length - 3} more)</div>}
                              </div>
                            </div>
                          )}
                        </div>
                      ))
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// (TimeRow removed in favor of per-instruction buttons)

const styles = {
  page: {
    width: '100vw',
    height: '100vh',
    overflow: 'hidden',
    display: 'block',
    margin: 0,
    padding: 0,
    background: '#0b0f19',
    color: 'white',
    fontFamily: "'Fredoka', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif",
  },
  card: {
    width: "100vw",
    maxWidth: "100vw",
    height: "100dvh",
    minHeight: "100svh",
    background: "#121a2b",
    borderRadius: 0,
    padding: 0,
    position: "relative",
    boxShadow: "0 10px 30px rgba(0,0,0,.35)",
  },
  headerRow: { display: "flex", justifyContent: "space-between", alignItems: "center" },
  title: { fontSize: 22, fontWeight: 800 },
  sub: { opacity: 0.8, fontSize: 13 },
  resourceRow: { display: "flex", gap: 10, marginTop: 10, flexWrap: "wrap" },
  pill: {
    background: "#0f1524",
    padding: "8px 10px",
    borderRadius: 999,
    fontSize: 14,
  },
  grid: {
    display: "grid",
    gridTemplateColumns: "1fr",
    gap: 12,
    marginTop: 0,
    height: '100%',
  },
  roomOuter: { display: "flex", justifyContent: "center", marginTop: 0, marginBottom: 0, height: '100%' },
  section: {
    background: "transparent",
    borderRadius: 0,
    padding: 0,
  },
  h3: { margin: 0, marginBottom: 8, fontSize: 16 },
  statRow: { display: "flex", justifyContent: "space-between", padding: "4px 0" },
  label: { fontSize: 12, opacity: 0.8, marginTop: 8 },
  rowWrap: { display: "flex", flexWrap: "wrap", gap: 8, marginTop: 6 },
  inlineRow: { display: "flex", gap: 8, alignItems: "center", marginTop: 6 },
  input: {
    flex: 1,
    minWidth: 0,
    height: 38,
    borderRadius: 10,
    border: "1px solid rgba(255,255,255,.25)",
    background: "transparent",
    color: "white",
    padding: "0 10px",
    fontSize: 14,
  },
  lockNote: {
    display: "inline-block",
    border: "1px solid rgba(255,255,255,.25)",
    borderRadius: 999,
    padding: "4px 10px",
    fontSize: 12,
    opacity: 0.8,
  },
  room: {
    position: "relative",
    height: '100%',
    width: '100%',
    borderRadius: 0,
    backgroundImage: "url('/art/apartmentbackground.png')",
    backgroundSize: "auto 100%",
    backgroundPosition: "center center",
    backgroundRepeat: "no-repeat",
    border: "none",
    boxShadow: "inset 0 -20px 30px rgba(0,0,0,.3)",
    overflow: "hidden",
    marginBottom: 0,
  },
  roomAnchors: {
    position: 'absolute',
    top: 0,
    left: '50%',
    transform: 'translateX(-50%)',
    height: '100%',
    aspectRatio: '3168 / 1344',
    pointerEvents: 'auto',
  },
  nightOverlay: {
    position: 'absolute',
    inset: 0,
    zIndex: 2,
    pointerEvents: 'none',
    background: `radial-gradient(120% 120% at 50% 35%, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0.45) 65%, rgba(0,0,0,0.65) 100%), rgba(0,0,0,0.35)`,
    mixBlendMode: 'multiply'
  },
  wizmasOverlay: {
    position: 'absolute',
    inset: 0,
    backgroundImage: "url('/art/apartmentbackgroundwide_wizmas.png')",
    backgroundSize: 'auto 100%',
    backgroundPosition: 'center center',
    backgroundRepeat: 'no-repeat',
    zIndex: 2,
    pointerEvents: 'none',
  },
  station: {
    position: "absolute",
    transform: "translate(-50%, -50%)",
    fontSize: 20,
    opacity: 0.9,
  },
  stationImg: {
    width: 144,
    height: 144,
    objectFit: 'contain',
    pointerEvents: 'none',
    filter: 'drop-shadow(0 1px 1px rgba(0,0,0,.3))',
  },
  computerImg: {
    width: 72,
    height: 72,
    objectFit: 'contain',
    pointerEvents: 'none',
    filter: 'drop-shadow(0 1px 1px rgba(0,0,0,.3))',
  },
  actionImg: {
    width: 95,
    height: 95,
    objectFit: 'contain',
    pointerEvents: 'none',
  },
  actionBtnWrap: { position:'relative', display:'inline-block' },
  actionBtnRoll: {
    position:'absolute',
    left: 26,
    bottom: 43,
    color: '#574483',
    fontWeight: 900,
    fontSize: 8,
    textShadow: '0 2px 4px rgba(0,0,0,.7)',
    zIndex: 10,
    pointerEvents: 'none',
    transform: 'translateX(-50%)',
    width: 18,
    textAlign: 'center',
    fontFamily: 'monospace',
    fontVariantNumeric: 'tabular-nums',
  },
  chairImg: {
    width: 72,
    height: 72,
    objectFit: 'contain',
    pointerEvents: 'none',
    filter: 'drop-shadow(0 1px 1px rgba(0,0,0,.3))',
  },
  performer: {
    position: "absolute",
    width: 125,
    height: 125,
    borderRadius: 0,
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    background: "transparent",
    color: "#111",
    boxShadow: "none",
    transition: "transform 120ms ease",
    cursor: "pointer",
  },
  performerImg: {
    width: '100%',
    height: '100%',
    objectFit: 'contain',
    pointerEvents: 'none',
    filter: 'drop-shadow(0 2px 2px rgba(0,0,0,.3))',
  },
  actionEmoji: {
    position: "absolute",
    top: -18,
    right: -10,
    fontSize: 16,
    display: 'none',
  },
  hud: {
    position: "absolute",
    top: 8,
    left: 8,
    background: "rgba(0,0,0,.38)",
    border: "1px solid rgba(255,255,255,.2)",
    borderRadius: 10,
    padding: "6px 8px",
    color: "#fff",
    backdropFilter: "blur(2px)",
    boxShadow: "0 4px 12px rgba(0,0,0,.2)",
    minWidth: 120,
  },
  hudLine: { fontSize: 12, lineHeight: 1.2, opacity: 0.95 },
  avatarRow: { display: "flex", alignItems: "center", gap: 10, marginBottom: 6 },
  avatar: {
    width: 44,
    height: 44,
    borderRadius: 12,
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    background: "linear-gradient(135deg, #fff, #ddd)",
    color: "#111",
    fontSize: 26,
    boxShadow: "0 4px 12px rgba(0,0,0,.25)",
  },
  speech: {
    flex: 1,
    background: "#0f1524",
    border: "1px solid rgba(255,255,255,.15)",
    borderRadius: 12,
    padding: "6px 10px",
  },
  speechText: { fontSize: 13, opacity: 0.95 },
  btnOn: {
    background: "white",
    color: "black",
    border: "none",
    borderRadius: 999,
    padding: "8px 12px",
    fontWeight: 700,
  },
  btnOff: {
    background: "transparent",
    color: "white",
    border: "1px solid rgba(255,255,255,.25)",
    borderRadius: 999,
    padding: "8px 12px",
    fontWeight: 600,
  },
  smallBtn: {
    background: "transparent",
    color: "white",
    border: "1px solid rgba(255,255,255,.25)",
    borderRadius: 10,
    padding: "8px 10px",
    fontWeight: 600,
    display: 'inline-flex',
    alignItems: 'center',
    gap: 6,
  },
  actionBtn: {
    position: 'relative',
    background: 'transparent',
    border: 'none',
    padding: 0,
    display: 'inline-flex',
    alignItems: 'center',
    justifyContent: 'center',
    cursor: 'pointer',
  },
  queue: { display: "grid", gridTemplateColumns: "repeat(10, 1fr)", gap: 6, marginTop: 6 },
  queueCellOn: { height: 34, borderRadius: 8, background: "white", color: "black", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18, fontWeight: 800 },
  queueCellOff: { height: 34, borderRadius: 8, border: "1px dashed rgba(255,255,255,.25)", color: "rgba(255,255,255,.5)", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16 },
  weekStrip: { display: "grid", gridTemplateColumns: "repeat(7, 1fr)", gap: 8, marginTop: 10 },
  dayCell: { display: "flex", flexDirection: "column", alignItems: "center", gap: 4 },
  dayLabel: { fontSize: 10, opacity: 0.75 },
  dayIconOn: { width: 34, height: 34, borderRadius: 8, background: "white", color: "black", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18, fontWeight: 800 },
  dayIconOff: { width: 34, height: 34, borderRadius: 8, border: "1px dashed rgba(255,255,255,.25)", color: "rgba(255,255,255,.5)", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16 },
  primaryBtn: {
    width: "100%",
    marginTop: 10,
    padding: "12px 12px",
    borderRadius: 12,
    border: "none",
    background: "white",
    color: "black",
    fontWeight: 900,
    fontSize: 16,
    fontFamily: "'Fredoka', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif",
  },
  primaryBtnDisabled: {
    width: "100%",
    marginTop: 10,
    padding: "12px 12px",
    borderRadius: 12,
    border: "1px solid rgba(255,255,255,.25)",
    background: "transparent",
    color: "rgba(255,255,255,.6)",
    fontWeight: 900,
    fontSize: 16,
    fontFamily: "'Fredoka', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif",
  },
  secondaryBtn: {
    background: "transparent",
    color: "white",
    border: "1px solid rgba(255,255,255,.25)",
    borderRadius: 12,
    padding: "8px 10px",
    fontWeight: 700,
    fontFamily: "'Fredoka', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif",
  },
  resultTop: { display: "flex", justifyContent: "space-between", alignItems: "center" },
  grade: {
    width: 42,
    height: 42,
    borderRadius: 12,
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    background: "white",
    color: "black",
    fontWeight: 900,
    fontSize: 18,
  },
  review: { marginTop: 8, fontSize: 14, opacity: 0.95 },
  overlay: {
    position: "absolute",
    inset: 0,
    background: "rgba(0,0,0,.35)",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    padding: 14,
    borderRadius: 16,
    zIndex: 1000,
    backdropFilter: 'blur(4px)'
  },
  overlayClear: {
    position: 'absolute',
    inset: 0,
    background: 'rgba(0,0,0,.22)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    padding: 0,
    borderRadius: 0,
    zIndex: 1000,
    backdropFilter: 'blur(4px)',
  },
  modal: {
    width: "100%",
    maxWidth: 360,
    background: "#0f1524",
    borderRadius: 16,
    padding: 14,
    boxShadow: "0 10px 30px rgba(0,0,0,.4)",
  },
  shopModalFrame: {
    position: 'relative',
    width: '100%',
    background: 'transparent',
    borderRadius: 0,
    padding: 0,
    // Maintain the frame's intrinsic aspect so it never distorts
    aspectRatio: '88 / 47',
    overflow: 'visible'
  },
  shopFrameOverlay: {
    position: 'absolute',
    inset: 0,
    backgroundImage: "url('/art/newmodalframe.png')",
    backgroundSize: 'cover',
    backgroundPosition: 'center',
    backgroundRepeat: 'no-repeat',
    pointerEvents: 'none',
    zIndex: 2,
    filter: 'drop-shadow(0 8px 18px rgba(0,0,0,.35))'
  },
  shopModalInner: {
    position: 'absolute',
    // Safe area inside frame (nudged down 10%, right 5%)
    top: '22%',
    right: '13%',
    bottom: '4%',
    left: '15%',
    display: 'flex',
    flexDirection: 'column',
    overflowY: 'auto',
    gap: 6,
    fontSize: 14,
    zIndex: 1,
  },
  shopCloseBtn: {
    position: 'absolute',
    left: '50%',
    bottom: '3.5%',
    transform: 'translateX(-50%)',
    zIndex: 3,
    maxWidth: 160,
    padding: '6px 12px',
    fontSize: 12,
    borderRadius: 10,
  },
  mirrorModal: {
    width: '100%',
    maxWidth: 560,
    background: 'transparent',
    borderRadius: 16,
    padding: 0,
    boxShadow: 'none'
  },
  mirrorFrame: {
    position: 'relative',
    width: '100%',
    minHeight: 0,
    borderRadius: 16,
    backgroundImage: "url('/art/modalframe.png')",
    backgroundSize: 'cover',
    backgroundPosition: 'center bottom',
    backgroundRepeat: 'no-repeat',
    overflow: 'hidden',
    aspectRatio: '2112 / 1500',
    filter: 'drop-shadow(0 0 16px rgba(160,255,200,.15))'
  },
  mirrorInner: {
    position: 'absolute',
    // Safe area inside the modal frame
    top: '16%',
    right: '12%',
    bottom: '12%',
    left: '12%',
    display: 'flex',
    flexDirection: 'column',
    justifyContent: 'center',
    gap: 10,
    overflowY: 'auto'
  },
  // Compact shop buy button to reduce width
  shopBuyBtn: {
    padding: '6px 10px',
    fontSize: 12,
    minWidth: 80,
    whiteSpace: 'nowrap',
    width: 'auto',
    flex: '0 0 auto',
    textAlign: 'center',
    color: '#ffffff',
    background: 'linear-gradient(180deg, #3a4ea1 0%, #2b3f8a 100%)',
    border: '1px solid rgba(58,78,161,.65)',
    boxShadow: '0 2px 6px rgba(0,0,0,.25)',
    fontWeight: 700,
    borderRadius: 10,
  },
  shopBuyBtnDisabled: {
    padding: '6px 10px',
    fontSize: 12,
    minWidth: 80,
    whiteSpace: 'nowrap',
    width: 'auto',
    flex: '0 0 auto',
    textAlign: 'center',
    color: 'rgba(255,255,255,.85)',
    background: 'rgba(43,63,138,.30)',
    border: '1px solid rgba(58,78,161,.45)',
    fontWeight: 700,
    borderRadius: 10,
  },
  shopGrid: {
    display: 'grid',
    gridTemplateColumns: 'repeat(3, minmax(0, 1fr))',
    gap: 10,
    alignItems: 'stretch',
  },
  shopSearchBar: {
    width: '100%',
    maxWidth: 420,
    height: 38,
    borderRadius: 999,
    background: 'rgba(255,255,255,0.9)',
    border: '1px solid rgba(0,0,0,.12)',
    boxShadow: '0 2px 8px rgba(0,0,0,.15) inset, 0 2px 6px rgba(0,0,0,.12)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'space-between',
    padding: '0 12px',
    color: '#1e2b57',
    fontWeight: 600,
    pointerEvents: 'none',
    backdropFilter: 'blur(2px)'
  },
  shopMoneyInline: {
    alignSelf: 'flex-end',
    background: 'rgba(0,0,0,.55)',
    border: '1px solid rgba(255,255,255,.35)',
    padding: '6px 10px',
    borderRadius: 12,
    fontSize: 13,
    color: '#fff',
    display: 'inline-flex',
    alignItems: 'center',
    gap: 6,
  },
  shopMoneyOnLogo: {
    position: 'absolute',
    right: 0,
    top: 6,
    transform: 'none',
    background: 'rgba(0,0,0,.55)',
    border: '1px solid rgba(255,255,255,.35)',
    padding: '6px 10px',
    borderRadius: 12,
    fontSize: 13,
    color: '#fff',
    display: 'inline-flex',
    alignItems: 'center',
    gap: 6,
  },
  shopCard: {
    border: '1px solid rgba(255,215,0,.28)',
    borderRadius: 12,
    padding: 10,
    background: 'rgba(255,215,0,0.12)',
    minHeight: 150,
    display: 'flex',
    flexDirection: 'column',
    alignItems: 'center',
    justifyContent: 'space-between',
    textAlign: 'center',
    gap: 8,
    backdropFilter: 'blur(2px)',
  },
  shopImageBox: {
    flex: 1,
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    minHeight: 56,
    width: '100%'
  },
  ul: { margin: '6px 0 0 18px', padding: 0 },
  li: { fontSize: 13, lineHeight: 1.4, opacity: 0.95 },
  progressLabel: { display: 'flex', justifyContent: 'space-between', fontSize: 14, fontWeight: 900, letterSpacing: .2, textTransform: 'uppercase', opacity: 0.95, marginTop: 8 },
  progressTrack: { height: 12, borderRadius: 7, background: 'rgba(255,255,255,.12)', overflow: 'visible', marginTop: 4 },
  progressFill: { height: '100%', background: 'white' },
  dieToken: { minWidth: 23, height: 14, borderRadius: 9, background:'rgba(255,255,255,.15)', color:'#fff', display:'flex', alignItems:'center', justifyContent:'center', fontWeight:900, fontSize:10, border:'1px solid rgba(255,255,255,.3)', boxShadow:'inset 0 1px 0 rgba(255,255,255,.25), 0 2px 6px rgba(0,0,0,.25)' },
  dieBadge: { width: 25, height: 25, objectFit: 'contain', filter:'drop-shadow(0 1px 2px rgba(0,0,0,.35))' },
  dieBadgeWrap: { position:'relative', width: 29, height: 29, display:'flex', alignItems:'center', justifyContent:'center', zIndex: 2 },
  dieBadgeText: { position:'absolute', color:'#fff', fontWeight:900, fontSize: 11, textShadow: '0 1px 2px rgba(0,0,0,.6)',  },
  portraitWrap: { width: 160, height: 160, borderRadius: 999, background:'transparent', display:'flex', alignItems:'center', justifyContent:'center', boxShadow:'none', border:'none', marginTop: 10 },
  portraitImg: { width: 140, height: 140, borderRadius: 999, objectFit: 'cover', filter:'drop-shadow(0 2px 6px rgba(0,0,0,.25))' },
  progressHelp: { fontSize: 11, opacity: 0.8, marginTop: 4 },
  barRow: { display: 'flex', alignItems: 'center', gap: 8, marginTop: 8 },
  barLabel: { width: 90, fontSize: 12 },
  barTrack: { position:'relative', flex: 1, height: 14, borderRadius: 8, background: 'rgba(255,255,255,.08)', overflow: 'hidden' },
  barBackGrid: { position:'absolute', inset:0, background: 'linear-gradient(90deg, rgba(255,255,255,.08) 0 20%, transparent 20% 40%, rgba(255,255,255,.08) 40% 60%, transparent 60% 80%, rgba(255,255,255,.08) 80% 100%)' },
  barRight: { width: 96, textAlign: 'right', fontSize: 12 },
  barMarkers: { position: 'absolute', inset: 0, pointerEvents: 'none' },
  barTick: { position:'absolute', top: 0, width: 2, height: '100%', background: 'rgba(255,255,255,.5)', borderRadius: 1, boxShadow: '0 0 4px rgba(0,0,0,.25)' },
  buttonsOverlay: {
    position: 'absolute',
    bottom: 8,
    left: '50%',
    transform: 'translateX(-50%) translateY(30px)',
    display: 'flex',
    gap: 8,
    padding: 0,
    borderRadius: 0,
    background: 'transparent',
    backdropFilter: 'none',
    zIndex: 2,
  },
  toastWrap: {
    position: 'fixed',
    top: 16,
    left: '50%',
    transform: 'translateX(-50%)',
    display: 'flex',
    flexDirection: 'column',
    gap: 6,
    zIndex: 2000,
  },
  toast: {
    background: 'rgba(0,0,0,.75)',
    color: 'white',
    border: '1px solid rgba(255,255,255,.3)',
    padding: '8px 12px',
    borderRadius: 10,
    fontSize: 13,
    boxShadow: '0 6px 16px rgba(0,0,0,.35)'
  },
  hudMoney: {
    position: 'absolute',
    top: 8,
    right: 8,
    background: 'rgba(0,0,0,.55)',
    border: '1px solid rgba(255,255,255,.35)',
    padding: '6px 10px',
    borderRadius: 12,
    fontSize: 13,
    zIndex: 3,
  },
  hudRolls: {
    position: 'absolute',
    top: 8,
    left: 8,
    background: 'rgba(0,0,0,.55)',
    border: '1px solid rgba(255,255,255,.35)',
    padding: '6px 10px',
    borderRadius: 12,
    fontSize: 13,
    zIndex: 3,
  },
  hudPerforming: {
    position: 'absolute',
    bottom: 8,
    left: 8,
    background: 'rgba(0,0,0,.55)',
    border: '1px solid rgba(255,255,255,.35)',
    padding: '6px 10px',
    borderRadius: 12,
    fontSize: 13,
    zIndex: 3,
    maxWidth: 260,
  },
  diceOverlay: {
    position: 'absolute',
    top: 8,
    left: 8,
    display: 'flex',
    gap: 8,
    alignItems: 'center',
    zIndex: 3,
  },
  hudListening: {
    position: 'absolute',
    top: 8,
    left: 8,
    background: 'rgba(0,0,0,.55)',
    border: '1px solid rgba(255,255,255,.35)',
    padding: '4px 8px',
    borderRadius: 10,
    fontSize: 11,
    zIndex: 5,
    maxWidth: 260,
    display: 'flex',
    alignItems: 'baseline',
    pointerEvents: 'none'
  },
  performHazeOverlay: { position:'absolute', inset:0, pointerEvents:'none', zIndex: 1 },
  performHazeShimmer: { position:'absolute', inset:0, background: 'repeating-linear-gradient(115deg, rgba(200,120,255,0.10) 0px, rgba(200,120,255,0.10) 8px, rgba(0,0,0,0) 18px, rgba(0,0,0,0) 30px)', mixBlendMode: 'screen', pointerEvents: 'none', animation: 'hazeShimmer 9s linear infinite' },
  performRainOverlay: { position:'absolute', inset:0, pointerEvents:'none', overflow:'hidden', zIndex: 2 },
  performRainMute: { position:'absolute', inset:0, background:'rgba(0,0,0,.18)', pointerEvents:'none' },
  performRainDropsBack: { position:'absolute', inset:0, background: 'repeating-linear-gradient(90deg, rgba(150,190,255,.12) 0 1px, rgba(0,0,0,0) 1px 14px)', filter:'blur(.6px)', mixBlendMode:'soft-light', pointerEvents:'none', opacity: .65, transform:'skewX(-8deg)', willChange:'transform, background-position', animation: 'rainDriftSlow 1.8s linear infinite' },
  performRainDrops: { position:'absolute', inset:0, background: 'repeating-linear-gradient(90deg, rgba(150,190,255,.20) 0 1.5px, rgba(0,0,0,0) 1.5px 12px)', filter:'blur(.35px)', mixBlendMode:'soft-light', pointerEvents:'none', opacity: .85, transform:'skewX(-10deg)', willChange:'transform, background-position', animation: 'rainDrift 1.2s linear infinite' },
  performRainDropsFront: { position:'absolute', inset:0, background: 'repeating-linear-gradient(90deg, rgba(185,215,255,.30) 0 2px, rgba(0,0,0,0) 2px 16px)', filter:'blur(.15px)', mixBlendMode:'screen', pointerEvents:'none', opacity: .9, transform:'skewX(-12deg)', willChange:'transform, background-position', animation: 'rainDriftFast .9s linear infinite' },
  performLightning: { position:'absolute', inset:0, pointerEvents:'none', background: 'radial-gradient(ellipse at 50% 25%, rgba(255,255,255,.58), rgba(255,255,255,0) 60%), rgba(255,255,255,.06)', mixBlendMode:'screen', animation: 'lightFlash 220ms ease-out 1' },
  performSpotlightOverlay: { position:'absolute', inset:0, pointerEvents:'none', zIndex: 4 },
  performSpotlightDim: { position:'absolute', inset:0, background:'rgba(0,0,0,.75)', animation:'spotlightDim 6000ms ease-out 1', pointerEvents:'none' },
  performSpotlightCircle: { position:'absolute', width:320, height:240, borderRadius:999, background:'radial-gradient(ellipse at center, rgba(255,255,255,.95) 0%, rgba(255,255,255,.6) 35%, rgba(255,255,255,.12) 65%, rgba(255,255,255,0) 80%)', mixBlendMode:'screen', filter:'drop-shadow(0 0 22px rgba(255,255,255,.45))', transform:'translate(-50%,-50%)', animation:'spotlightPulse 900ms ease-out 1', pointerEvents:'none' },
  // Rivet: Iron Overture Filter (stark monochrome)
  performMonoOverlay: { position:'absolute', inset:0, pointerEvents:'none', zIndex: 5, background:'rgba(0,0,0,0.001)', backdropFilter: 'grayscale(100%) contrast(1.5) brightness(1.05)', WebkitBackdropFilter: 'grayscale(100%) contrast(1.5) brightness(1.05)' },
  // Gentle whites push in center
  performMonoHighlights: { position:'absolute', inset:0, background: 'radial-gradient(ellipse at center, rgba(255,255,255,.08) 0%, rgba(255,255,255,0) 58%)', mixBlendMode:'screen', pointerEvents:'none' },
  // Subtle vignette to emphasize intensity
  performMonoVignette: { position:'absolute', inset:0, background: 'radial-gradient(ellipse at center, rgba(255,255,255,0) 52%, rgba(0,0,0,.18) 82%, rgba(0,0,0,.35) 100%)', mixBlendMode:'multiply', pointerEvents:'none' },
  // Pink Bubbles (Pop): layered parallax bubbles + sheen (more visible)
  performBubblesOverlay: { position:'absolute', inset:0, pointerEvents:'none', zIndex: 10, overflow:'hidden' },
  performBubble: { position:'absolute', top:'100%', height:'100%', pointerEvents:'none', animation: 'bubbleRiseDom var(--dur) linear var(--delay) infinite', willChange:'transform, opacity' },
  performBubbleInner: { position:'absolute', bottom:0, left:0, display:'block', borderRadius:999, background:'radial-gradient(circle at 35% 30%, rgba(255,240,250,.98) 0%, rgba(255,195,225,.78) 45%, rgba(255,160,210,.52) 70%, rgba(255,160,210,.08) 78%, rgba(255,255,255,.85) 92%, rgba(255,255,255,0) 98%)', border: '1px solid rgba(255,220,240,.85)', boxShadow: '0 0 8px rgba(255,180,210,.55)', animation: 'bubbleSwayDom calc(var(--dur) * .6) ease-in-out var(--delay) infinite alternate' },
  performBubblesBack: {
    position:'absolute', inset:0, opacity:.55, mixBlendMode:'screen',
    backgroundImage:
      'radial-gradient(circle at 20% 85%, rgba(255,170,210,.40) 0px, rgba(255,170,210,.40) 8px, rgba(255,170,210,0) 14px), '+
      'radial-gradient(circle at 70% 95%, rgba(255,170,210,.36) 0px, rgba(255,170,210,.36) 7px, rgba(255,170,210,0) 14px), '+
      'radial-gradient(circle at 45% 105%, rgba(255,170,210,.34) 0px, rgba(255,170,210,.34) 6px, rgba(255,170,210,0) 14px)'
    ,
    backgroundRepeat:'repeat',
    backgroundSize:'110px 220px, 140px 240px, 130px 260px',
    backgroundPosition:'0 160%, 0 180%, 0 200%',
    animation:'bubbleRiseSlow 28s linear infinite'
  },
  performBubblesMid: {
    position:'absolute', inset:0, opacity:.70, mixBlendMode:'screen',
    backgroundImage:
      'radial-gradient(circle at 10% 95%, rgba(255,160,205,.48) 0px, rgba(255,160,205,.48) 11px, rgba(255,160,205,0) 20px), '+
      'radial-gradient(circle at 82% 102%, rgba(255,160,205,.44) 0px, rgba(255,160,205,.44) 10px, rgba(255,160,205,0) 20px), '+
      'radial-gradient(circle at 52% 112%, rgba(255,160,205,.40) 0px, rgba(255,160,205,.40) 9px, rgba(255,160,205,0) 20px)'
    ,
    backgroundRepeat:'repeat',
    backgroundSize:'130px 220px, 160px 260px, 150px 300px',
    backgroundPosition:'0 170%, 0 190%, 0 210%',
    animation:'bubbleRiseMid 20s linear infinite'
  },
  performBubblesFront: {
    position:'absolute', inset:0, opacity:.85, mixBlendMode:'screen',
    backgroundImage:
      'radial-gradient(circle at 30% 98%, rgba(255,155,210,.58) 0px, rgba(255,155,210,.58) 14px, rgba(255,155,210,0) 26px), '+
      'radial-gradient(circle at 92% 108%, rgba(255,155,210,.52) 0px, rgba(255,155,210,.52) 13px, rgba(255,155,210,0) 26px)'
    ,
    backgroundRepeat:'repeat',
    backgroundSize:'150px 220px, 190px 300px',
    backgroundPosition:'0 180%, 0 210%',
    animation:'bubbleRiseFast 14s linear infinite'
  },
  performBubblesSheen: {
    position:'absolute', inset:0, pointerEvents:'none', mixBlendMode:'screen',
    background:'linear-gradient(180deg, rgba(255,200,230,.14) 0%, rgba(255,200,230,0) 30%, rgba(255,200,230,.10) 60%, rgba(255,200,230,0) 100%)',
    opacity:.8
  },

  // Wizmas: Snow overlays for Busking during Wizmas weeks
  performSnowBack: {
    position:'absolute', inset:0, pointerEvents:'none', opacity:.22,
    backgroundImage: 'radial-gradient(rgba(255,255,255,.72) 0.9px, rgba(255,255,255,0) 2px), radial-gradient(rgba(255,255,255,.55) 0.9px, rgba(255,255,255,0) 2px)',
    backgroundSize: '18px 18px, 28px 28px',
    backgroundRepeat: 'repeat, repeat',
    backgroundPosition: '0px 0px, 40px -30px',
    filter: 'blur(0.2px)',
    mixBlendMode: 'screen',
    willChange:'background-position',
    animation: 'snowFallSlow 16s linear infinite'
  },
  performSnowMid: {
    position:'absolute', inset:0, pointerEvents:'none', opacity:.28,
    backgroundImage: 'radial-gradient(rgba(255,255,255,.82) 1.0px, rgba(255,255,255,0) 2.1px), radial-gradient(rgba(255,255,255,.65) 0.9px, rgba(255,255,255,0) 2px)',
    backgroundSize: '20px 20px, 30px 30px',
    backgroundRepeat: 'repeat, repeat',
    backgroundPosition: '0px 0px, -50px 20px',
    filter: 'blur(0.15px)',
    mixBlendMode: 'screen',
    willChange:'background-position',
    animation: 'snowFallMid 13s linear infinite'
  },
  performSnowFront: {
    position:'absolute', inset:0, pointerEvents:'none', opacity:.36,
    backgroundImage: 'radial-gradient(rgba(255,255,255,.88) 0.9px, rgba(255,255,255,0) 2.2px), radial-gradient(rgba(255,255,255,.78) 1.0px, rgba(255,255,255,0) 2.4px)',
    backgroundSize: '22px 22px, 34px 34px',
    backgroundRepeat: 'repeat, repeat',
    backgroundPosition: '0px 0px, 20px -10px',
    filter: 'blur(0.1px)',
    mixBlendMode: 'screen',
    willChange:'background-position',
    animation: 'snowFallFast 12s linear infinite'
  },

  // Visual Novel overlay styles
  vnLogo: { position:'absolute', left: 10, top: 18, width: 192, height: 'auto', objectFit: 'contain', opacity: .9, pointerEvents: 'none' },
  vnBustLeft: { position:'absolute', left: 37, bottom: 0, width: 220, height: 'auto', objectFit: 'contain', filter:'drop-shadow(0 2px 6px rgba(0,0,0,.35))', opacity: .95, transform:'translate(25px, 25px)' },
  vnBustRight: { position:'absolute', right: 12, bottom: 10, width: 330, height: 'auto', objectFit: 'contain', filter:'drop-shadow(0 2px 6px rgba(0,0,0,.35))', opacity: .95 },
  vnBubble: { background:'rgba(114, 69, 187, .45)', border:'1px solid rgba(255,255,255,.35)', borderRadius: 12, padding:'10px 12px', color:'#fff', backdropFilter:'blur(2px)', boxShadow:'0 4px 12px rgba(0,0,0,.2)' },
  vnBubbleLeft: { textAlign:'left' },
  vnBubbleRight: { textAlign:'left' },
  diceMiniOverlay: {
    position: 'absolute',
    top: 8,
    left: 8,
    display: 'flex',
    gap: 6,
    alignItems: 'center',
    zIndex: 3,
  },
  diceChip: {
    minWidth: 64,
    height: 44,
    borderRadius: 10,
    border: '1px solid rgba(255,255,255,.25)',
    background: 'rgba(0,0,0,.35)',
    display: 'flex',
    flexDirection: 'column',
    alignItems: 'center',
    justifyContent: 'center',
    padding: '4px 8px',
  },
  diceMiniChip: {
    minWidth: 56,
    height: 38,
    borderRadius: 10,
    border: '1px solid rgba(255,255,255,.25)',
    background: 'rgba(0,0,0,.35)',
    display: 'flex',
    flexDirection: 'column',
    alignItems: 'center',
    justifyContent: 'center',
    padding: '2px 6px',
  },
  diceLabel: { fontWeight: 800, fontSize: 12, opacity: .9 },
  diceVal: { fontWeight: 800, fontSize: 14 },
  nudgeImgBtn: {
    position: 'absolute',
    bottom: 6,
    left: 6,
    width: 36,
    height: 36,
    objectFit: 'contain',
    cursor: 'pointer',
    zIndex: 3,
    filter: 'drop-shadow(0 2px 6px rgba(0,0,0,.35))'
  },
  restBtn: {
    height: 44,
    borderRadius: 10,
    border: '1px solid rgba(255,255,255,.25)',
    background: 'rgba(0,0,0,.35)',
    color: 'white',
    padding: '0 10px',
    cursor: 'pointer',
  },
  rollBubble: {
    position: 'absolute',
    transform: 'translate(-50%, -115%)',
    background: 'rgba(0,0,0,.8)',
    color: 'white',
    border: '1px solid rgba(255,255,255,.35)',
    borderRadius: 10,
    padding: '6px 8px',
    display: 'flex',
    gap: 6,
    alignItems: 'baseline',
    zIndex: 4,
    pointerEvents: 'none',
    transition: 'transform 160ms ease-out',
  },
  moneyTopRight: {
    position: 'absolute',
    top: 8,
    right: 12,
    background: 'rgba(0,0,0,.55)',
    border: '1px solid rgba(255,255,255,.35)',
    padding: '6px 10px',
    borderRadius: 12,
    fontSize: 14,
    zIndex: 10,
  },
  desktopModal: {
    width: '100%',
    height: '100%',
    maxWidth: '100%',
    maxHeight: '100%',
    borderRadius: 16,
    position: 'relative',
    overflow: 'hidden',
  },
  desktopPanel: {
    position: 'absolute',
    inset: 0,
    backgroundImage: "url('/art/desktopbackground.png')",
    backgroundSize: 'cover',
    backgroundPosition: 'center',
    backgroundRepeat: 'no-repeat',
    zIndex: 3,
  },
  desktopIcons: {
    position: 'absolute',
    inset: 0,
    display: 'flex',
    gap: 10,
    padding: 12,
    alignItems: 'flex-start',
  },
  desktopScanlinesOverlay: {
    position: 'absolute',
    inset: 0,
    background: 'repeating-linear-gradient(180deg, rgba(0,0,0,0.28) 0px, rgba(0,0,0,0.28) 1px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 4px)',
    mixBlendMode: 'multiply',
    opacity: .28,
    pointerEvents: 'none',
    zIndex: 4,
    animation: 'scanFlicker 6s ease-in-out infinite, scanScroll 1.5s linear infinite',
  },
  finishBtnSmall: {
    position: 'absolute',
    top: '50%',
    left: '50%',
    transform: 'translate(-50%, -50%)',
    width: 36,
    height: 36,
    borderRadius: 999,
    border: '1px solid rgba(255,255,255,.35)',
    background: 'rgba(255,255,255,.15)',
    color: 'white',
    fontWeight: 900,
    cursor: 'pointer',
  },
  performCta: {
    position: 'absolute',
    right: 12,
    bottom: 12,
    border: 'none',
    borderRadius: 12,
    padding: '10px 12px',
    background: 'white',
    color: 'black',
    fontWeight: 900,
    fontSize: 14,
    zIndex: 3,
    cursor: 'pointer',
  },
  desktopColumn: {
    display: 'flex',
    flexDirection: 'column',
    gap: 10,
  },
  desktopIconWrap: {
    display: 'flex',
    flexDirection: 'column',
    alignItems: 'center',
    gap: 6,
  },
  desktopIcon: {
    width: 96,
    height: 96,
    background: 'transparent',
    border: 'none',
    borderRadius: 0,
    color: 'white',
    fontWeight: 800,
    fontSize: 24,
    display: 'inline-flex',
    alignItems: 'center',
    justifyContent: 'center',
    cursor: 'pointer',
  },
  desktopIconImg: { width: 80, height: 80, objectFit: 'contain', filter: 'drop-shadow(0 2px 6px rgba(0,0,0,.25))' },
  desktopIconLabel: { fontSize: 12, opacity: 0.98, color: '#eee', marginTop: -14, display: 'block', textShadow: '0 1px 2px rgba(0,0,0,.35)' },
  desktopClose: {
    marginLeft: 'auto',
    width: 48,
    height: 48,
    background: 'rgba(255,255,255,.15)',
    border: '1px solid rgba(255,255,255,.25)',
    borderRadius: 10,
    color: 'white',
    fontWeight: 800,
    fontSize: 20,
    display: 'inline-flex',
    alignItems: 'center',
    justifyContent: 'center',
    cursor: 'pointer',
  },
  titleScreen: {
    position: 'relative',
    width: '100%',
    maxWidth: '100%',
    height: '100%',
    borderRadius: 0,
    border: 'none',
    backgroundImage: "url('/art/newtitlescreen.png')",
    backgroundSize: 'cover',
    backgroundPosition: 'center',
    backgroundRepeat: 'no-repeat',
    boxShadow: 'none',
    cursor: 'pointer',
  },
  startButton: {
    position: 'absolute',
    bottom: 16,
    left: '50%',
    transform: 'translateX(-50%)',
    border: 'none',
    borderRadius: 12,
    padding: '12px 18px',
    fontWeight: 900,
    fontSize: 16,
    background: 'white',
    color: 'black',
    cursor: 'pointer',
  },
  startImgButton: {
    position: 'absolute',
    bottom: 24,
    left: '50%',
    transform: 'translateX(calc(-50% - 100px)) translateY(30px)',
    width: 286,
    height: 83,
    padding: 0,
    border: 'none',
    background: 'transparent',
    cursor: 'pointer',
  },
  continueImgButton: {
    position: 'absolute',
    bottom: 24,
    left: '50%',
    transform: 'translateX(calc(-50% + 100px)) translateY(30px)',
    width: 286,
    height: 83,
    padding: 0,
    border: 'none',
    background: 'transparent',
    cursor: 'pointer',
  },
};

// Slightly nicer on wider screens
if (typeof window !== "undefined") {
  const mq = window.matchMedia("(min-width: 860px)");
  if (mq.matches) {
    styles.grid.gridTemplateColumns = "1fr";
  }
}

// Simple Radar Snapshot (Melody/Lyrics/Performance)
function RadarSnapshot({ vocals, writing, stage, practiceT, writeT, performT, totalDays }) {
  const mel = practiceT * (1 + vocals / 12);
  const lyr = writeT * (1 + writing / 12);
  const per = performT * (1 + stage / 12);
  const melMax = totalDays * (1 + vocals / 12);
  const lyrMax = totalDays * (1 + writing / 12);
  const perMax = totalDays * (1 + stage / 12);
  const melFrac = melMax > 0 ? mel / melMax : 0;
  const lyrFrac = lyrMax > 0 ? lyr / lyrMax : 0;
  const perFrac = perMax > 0 ? per / perMax : 0;

  const size = 220; const cx = size/2; const cy = size/2 + 6; const R = 80;
  const toXY = (frac, angleDeg) => {
    const a = (Math.PI/180) * angleDeg;
    const r = Math.max(0, Math.min(1, frac)) * R;
    return [cx + r * Math.cos(a), cy + r * Math.sin(a)];
  };
  // Axes: 90? (Melody, up), 210? (Lyrics, down-left), 330? (Performance, down-right)
  const pMel = toXY(melFrac, -90 + 180); // adjust for SVG y downwards
  const pLyr = toXY(lyrFrac, 150);
  const pPer = toXY(perFrac, 30);
  const pMaxMel = toXY(1, 90);
  const pMaxLyr = toXY(1, 210);
  const pMaxPer = toXY(1, 330);
  const poly = `${pMel[0]},${pMel[1]} ${pLyr[0]},${pLyr[1]} ${pPer[0]},${pPer[1]}`;
  const polyMax = `${pMaxMel[0]},${pMaxMel[1]} ${pMaxLyr[0]},${pMaxLyr[1]} ${pMaxPer[0]},${pMaxPer[1]}`;

  return (
    <div style={{ marginTop: 12, display:'flex', justifyContent:'center' }}>
      <svg width={size} height={size}>
        {/* Axes */}
        <line x1={cx} y1={cy} x2={pMaxMel[0]} y2={pMaxMel[1]} stroke="rgba(255,255,255,.25)" />
        <line x1={cx} y1={cy} x2={pMaxLyr[0]} y2={pMaxLyr[1]} stroke="rgba(255,255,255,.25)" />
        <line x1={cx} y1={cy} x2={pMaxPer[0]} y2={pMaxPer[1]} stroke="rgba(255,255,255,.25)" />
        {/* Max triangle */}
        <polygon points={polyMax} fill="none" stroke="rgba(255,255,255,.2)" />
        {/* Current polygon */}
        <polygon points={poly} fill="rgba(255,255,255,.25)" stroke="white" strokeOpacity="0.6" />
        {/* Labels */}
        <text x={cx} y={cy - R - 8} textAnchor="middle" fontSize="11" fill="white">Melody</text>
        <text x={cx - R * 0.9} y={cy + R * 0.75} textAnchor="middle" fontSize="11" fill="white">Lyrics</text>
        <text x={cx + R * 0.9} y={cy + R * 0.75} textAnchor="middle" fontSize="11" fill="white">Performance</text>
      </svg>
    </div>
  );
}

function TriadBarChart({ actions, vocals, writing, stage, totalDays }) {
  const segs = actions.filter(a=>a.t!=='gig');
  const axes = [
    { key: 'Melody', color: '#9AE6B4', stat: vocals, keyProp:'m' },
    { key: 'Lyrics', color: '#63B3ED', stat: writing, keyProp:'l' },
    { key: 'Performance', color: '#F6AD55', stat: stage, keyProp:'p' },
  ].map(a => {
    const value = segs.reduce((sum, s)=> sum + (+s[a.keyProp]||0), 0);
    // Fixed-cap normalization so higher stats fill faster for the same days
    const max = totalDays * (1 + 10 / 8);
    const frac = max > 0 ? value / max : 0;
    const parts = segs.filter(s => (s[a.keyProp]||0) > 0).map(s => ({ w: (s[a.keyProp]/max) }));
    return { ...a, value, max, frac, parts };
  });

  const qualityLabel = (frac) => {
    if (frac >= 0.85) return { label: 'Masterpiece', color: '#EBCB8B' };
    if (frac >= 0.65) return { label: 'Great', color: '#A3BE8C' };
    if (frac >= 0.4) return { label: 'Good', color: '#88C0D0' };
    if (frac >= 0.2) return { label: 'OK', color: '#E5E9F0' };
    return { label: 'Bad', color: '#D08770' };
  };

  return (
    <div style={{ marginTop: 12 }}>
      {axes.map((a) => {
        const q = qualityLabel(a.frac);
        return (
          <div key={a.key} style={styles.barRow}>
            <div style={styles.barLabel}>{a.key}</div>
            <div style={styles.barTrack}>
              <div style={{ ...styles.barBackGrid }} />
              <div style={{ position:'absolute', left:0, top:0, bottom:0, right:0, display:'flex' }}>
                {a.parts.map((p,i)=>(
                  <div key={i} style={{ height:'100%', width: `${Math.max(1, p.w*100)}%`, background: a.color, opacity: 0.95, marginRight: 2, borderRadius: 6 }} />
                ))}
              </div>
            </div>
            <div style={{ ...styles.barRight, color: q.color }}>{q.label}</div>
          </div>
        );
      })}
      <div style={{ ...styles.sub, marginTop: 6 }}>Bars fill faster with higher stats; cap is a fixed weekly goal.</div>
    </div>
  );
}





